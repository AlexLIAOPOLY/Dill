from flask import Blueprint, request, jsonify, Response
from ..models import DillModel, get_model_by_name
from ..utils import validate_input, validate_enhanced_input, validate_car_input, format_response, NumpyEncoder
import json
import numpy as np
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
from io import BytesIO
import base64
from backend.models import EnhancedDillModel
import traceback, datetime
import time

# å…¨å±€æ—¥å¿—å­˜å‚¨
calculation_logs = []

def add_log_entry(log_type, model_type, message, timestamp=None, dimension=None, details=None):
    """æ·»åŠ å¢å¼ºçš„æ—¥å¿—æ¡ç›®"""
    if timestamp is None:
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    log_entry = {
        'timestamp': timestamp,
        'type': log_type,  # 'info', 'progress', 'success', 'warning', 'error'
        'model': model_type,  # 'dill', 'enhanced_dill', 'car', 'system'
        'message': message,
        'dimension': dimension,  # '1d', '2d', '3d' æˆ– None
        'details': details or ''  # è¯¦ç»†ä¿¡æ¯
    }
    
    calculation_logs.append(log_entry)
    
    # ä¿æŒæ—¥å¿—æ¡ç›®æ•°é‡åœ¨åˆç†èŒƒå›´å†…ï¼ˆæœ€å¤š1000æ¡ï¼‰
    if len(calculation_logs) > 1000:
        calculation_logs.pop(0)

def add_dimension_log(log_type, model_type, message, dimension, details=None):
    """æ·»åŠ å¸¦ç»´åº¦ä¿¡æ¯çš„æ—¥å¿—æ¡ç›®"""
    add_log_entry(log_type, model_type, f"[{dimension.upper()}] {message}", dimension=dimension, details=details)

def add_progress_log(model_type, message, progress_percent=None, dimension=None):
    """æ·»åŠ è¿›åº¦æ—¥å¿—"""
    if progress_percent is not None:
        message = f"{message} ({progress_percent}%)"
    add_log_entry('progress', model_type, message, dimension=dimension)

def add_success_log(model_type, message, dimension=None, details=None):
    """æ·»åŠ æˆåŠŸæ—¥å¿—"""
    add_log_entry('success', model_type, message, dimension=dimension, details=details)

def add_warning_log(model_type, message, dimension=None, details=None):
    """æ·»åŠ è­¦å‘Šæ—¥å¿—"""
    add_log_entry('warning', model_type, message, dimension=dimension, details=details)

def add_error_log(model_type, message, dimension=None, details=None):
    """æ·»åŠ é”™è¯¯æ—¥å¿—"""
    add_log_entry('error', model_type, message, dimension=dimension, details=details)

def clear_logs():
    """æ¸…ç©ºæ—¥å¿—"""
    global calculation_logs
    calculation_logs = []

# åˆ›å»ºAPIè“å›¾
api_bp = Blueprint('api', __name__, url_prefix='/api')

# å®ä¾‹åŒ–Dillæ¨¡å‹
dill_model = DillModel()

@api_bp.route('/calculate', methods=['POST'])
def calculate():
    """
    è®¡ç®—æ¨¡å‹å¹¶è¿”å›å›¾åƒ
    æ–°å¢å‚æ•°: model_type, sine_type (æ”¯æŒ'1d', 'multi', '3d')
    """
    try:
        data = request.get_json()
        print('æ”¶åˆ°å‰ç«¯å‚æ•°:', data)  # è°ƒè¯•ç”¨
        model_type = data.get('model_type', 'dill')
        model = get_model_by_name(model_type)
        
        # æ ¹æ®æ¨¡å‹ç±»å‹éªŒè¯å‚æ•°
        if model_type == 'dill':
            is_valid, message = validate_input(data)
            if not is_valid:
                print(f"å‚æ•°æ ¡éªŒå¤±è´¥: {message}, å‚æ•°: {data}")
                return jsonify(format_response(False, message=message)), 400
            # æå–å‚æ•°
            I_avg = float(data['I_avg'])
            V = float(data['V'])
            t_exp = float(data['t_exp'])
            C = float(data['C'])
            sine_type = data.get('sine_type', '1d')
            
            if sine_type == 'multi':
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                phi_expr = data.get('phi_expr', '0')
                # è·å–yèŒƒå›´å‚æ•°
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                y_points = int(data.get('y_points', 100))
                
                # æ–°å¢æ ¡éªŒ: ç¡®ä¿ y_min < y_max ä¸” y_points > 1
                if y_min >= y_max:
                    return jsonify(format_response(False, message_zh="Yè½´èŒƒå›´æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼", message_en="Y-axis range min must be less than max")), 400
                if y_points <= 1:
                    return jsonify(format_response(False, message_zh="Yè½´ç‚¹æ•°å¿…é¡»å¤§äº1æ‰èƒ½è¿›è¡ŒäºŒç»´è®¡ç®—", message_en="Number of Y-axis points must be greater than 1 for 2D calculation")), 400
                
                # å¦‚æœæ ¡éªŒé€šè¿‡ï¼Œåˆ™ç›´æ¥è®¡ç®—y_range
                y_range = np.linspace(y_min, y_max, y_points).tolist()
                plot_data = model.generate_plots(I_avg, V, None, t_exp, C, sine_type=sine_type, 
                                               Kx=Kx, Ky=Ky, phi_expr=phi_expr, y_range=y_range)
            elif sine_type == '3d':
                # å¤„ç†ä¸‰ç»´æ­£å¼¦æ³¢å‚æ•°
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                Kz = float(data.get('Kz', 0))
                phi_expr = data.get('phi_expr', '0')
                # è·å–ä¸‰ç»´èŒƒå›´å‚æ•°
                x_min = float(data.get('x_min', 0))
                x_max = float(data.get('x_max', 10))
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                z_min = float(data.get('z_min', 0))
                z_max = float(data.get('z_max', 10))
                
                # é»˜è®¤ä½¿ç”¨50ä¸ªç‚¹
                y_range = np.linspace(y_min, y_max, 50).tolist() if y_min < y_max else None
                z_range = np.linspace(z_min, z_max, 50).tolist() if z_min < z_max else None
                
                plots = model.generate_plots(I_avg, V, None, t_exp, C, sine_type=sine_type,
                                           Kx=Kx, Ky=Ky, Kz=Kz, phi_expr=phi_expr,
                                           y_range=y_range, z_range=z_range)
            else:
                K = float(data['K'])
                plots = model.generate_plots(I_avg, V, K, t_exp, C, sine_type=sine_type)
        elif model_type == 'enhanced_dill':
            is_valid, message = validate_enhanced_input(data)
            if not is_valid:
                print(f"å‚æ•°æ ¡éªŒå¤±è´¥: {message}, å‚æ•°: {data}")
                return jsonify(format_response(False, message=message)), 400
            z_h = float(data['z_h'])
            T = float(data['T'])
            t_B = float(data['t_B'])
            I0 = float(data.get('I0', 1.0))
            M0 = float(data.get('M0', 1.0))
            t_exp = float(data['t_exp'])
            sine_type = data.get('sine_type', '1d')
            
            if sine_type == 'multi':
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                phi_expr = data.get('phi_expr', '0')
                V = float(data.get('V', 0))
                plots = model.generate_plots(z_h, T, t_B, I0, M0, t_exp, 
                                          sine_type=sine_type, Kx=Kx, Ky=Ky, phi_expr=phi_expr, V=V)
            elif sine_type == '3d':
                # å¤„ç†ä¸‰ç»´æ­£å¼¦æ³¢å‚æ•°
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                Kz = float(data.get('Kz', 0))
                phi_expr = data.get('phi_expr', '0')
                
                # è·å–ä¸‰ç»´èŒƒå›´å‚æ•°
                x_min = float(data.get('x_min', 0))
                x_max = float(data.get('x_max', 10))
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                z_min = float(data.get('z_min', 0))
                z_max = float(data.get('z_max', 10))
                
                # é»˜è®¤ä½¿ç”¨50ä¸ªç‚¹
                y_range = np.linspace(y_min, y_max, 50).tolist() if y_min < y_max else None
                z_range = np.linspace(z_min, z_max, 50).tolist() if z_min < z_max else None
                
                plots = model.generate_plots(z_h, T, t_B, I0, M0, t_exp, 
                                          sine_type=sine_type, Kx=Kx, Ky=Ky, Kz=Kz,
                                          phi_expr=phi_expr, V=V, y_range=y_range, z_range=z_range)
            else:
                plots = model.generate_plots(z_h, T, t_B, I0, M0, t_exp, sine_type=sine_type)
        elif model_type == 'car':
            is_valid, message = validate_car_input(data)
            if not is_valid:
                print(f"å‚æ•°æ ¡éªŒå¤±è´¥: {message}, å‚æ•°: {data}")
                return jsonify(format_response(False, message=message)), 400
            I_avg = float(data['I_avg'])
            V = float(data['V'])
            t_exp = float(data['t_exp'])
            acid_gen_efficiency = float(data['acid_gen_efficiency'])
            diffusion_length = float(data['diffusion_length'])
            reaction_rate = float(data['reaction_rate'])
            amplification = float(data['amplification'])
            contrast = float(data['contrast'])
            sine_type = data.get('sine_type', '1d')
            
            if sine_type == 'multi':
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                phi_expr = data.get('phi_expr', '0')
                # ä¸ºCARæ¨¡å‹æ·»åŠ y_rangeå‚æ•°å¤„ç†
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                y_points = int(data.get('y_points', 100))
                
                if y_min >= y_max:
                    return jsonify(format_response(False, message_zh="Yè½´èŒƒå›´æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼", message_en="Y-axis range min must be less than max")), 400
                if y_points <= 1:
                    return jsonify(format_response(False, message_zh="Yè½´ç‚¹æ•°å¿…é¡»å¤§äº1æ‰èƒ½è¿›è¡ŒäºŒç»´è®¡ç®—", message_en="Number of Y-axis points must be greater than 1 for 2D calculation")), 400
                
                y_range = np.linspace(y_min, y_max, y_points).tolist()
                plot_data = model.generate_plots(I_avg, V, None, t_exp, acid_gen_efficiency, 
                                         diffusion_length, reaction_rate, amplification, contrast, 
                                         sine_type=sine_type, Kx=Kx, Ky=Ky, phi_expr=phi_expr, y_range=y_range)
            elif sine_type == '3d':
                # å¤„ç†ä¸‰ç»´æ­£å¼¦æ³¢å‚æ•°
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                Kz = float(data.get('Kz', 0))
                phi_expr = data.get('phi_expr', '0')
                
                # è·å–ä¸‰ç»´èŒƒå›´å‚æ•°
                x_min = float(data.get('x_min', 0))
                x_max = float(data.get('x_max', 10))
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                z_min = float(data.get('z_min', 0))
                z_max = float(data.get('z_max', 10))
                
                # æ‰“å°è¯¦ç»†å‚æ•°ç”¨äºè°ƒè¯•
                print(f"è®¡ç®—3Dè–„èƒ¶æ¨¡å‹ï¼Œå‚æ•°ï¼šKx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr={phi_expr}")
                print(f"èŒƒå›´å‚æ•°ï¼šx_min={x_min}, x_max={x_max}, y_min={y_min}, y_max={y_max}, z_min={z_min}, z_max={z_max}")
                
                y_range = np.linspace(y_min, y_max, 50).tolist() if y_min < y_max else None
                z_range = np.linspace(z_min, z_max, 50).tolist() if z_min < z_max else None
                
                # æ‰“å°ç”Ÿæˆçš„èŒƒå›´ä¿¡æ¯
                print(f"ç”Ÿæˆçš„èŒƒå›´ï¼šy_rangeé•¿åº¦={len(y_range) if y_range else 0}, z_rangeé•¿åº¦={len(z_range) if z_range else 0}")
                
                try:
                    plots = model.generate_plots(I_avg, V, None, t_exp, acid_gen_efficiency, 
                                               diffusion_length, reaction_rate, amplification, contrast,
                                               sine_type=sine_type, Kx=Kx, Ky=Ky, Kz=Kz, phi_expr=phi_expr,
                                               y_range=y_range, z_range=z_range)
                    # æ‰“å°è¿”å›æ•°æ®çš„ç»“æ„
                    print(f"è¿”å›æ•°æ®å­—æ®µï¼š{list(plots.keys())}")
                    if 'exposure_dose' in plots:
                        if isinstance(plots['exposure_dose'], list):
                            print(f"exposure_doseæ˜¯åˆ—è¡¨ï¼Œé•¿åº¦={len(plots['exposure_dose'])}")
                            if len(plots['exposure_dose']) > 0 and isinstance(plots['exposure_dose'][0], list):
                                print(f"exposure_doseæ˜¯äºŒç»´åˆ—è¡¨ï¼Œå½¢çŠ¶=[{len(plots['exposure_dose'])}, {len(plots['exposure_dose'][0]) if len(plots['exposure_dose']) > 0 else 0}]")
                            else:
                                print(f"exposure_doseæ˜¯ä¸€ç»´åˆ—è¡¨")
                except Exception as e:
                    print(f"ç”Ÿæˆ3Dæ•°æ®æ—¶å‡ºé”™ï¼š{str(e)}")
                    # è®°å½•é”™è¯¯å †æ ˆä»¥ä¾¿è°ƒè¯•
                    traceback.print_exc()
                    raise
            else:
                K = float(data['K'])
                plots = model.generate_plots(I_avg, V, K, t_exp, acid_gen_efficiency, 
                                         diffusion_length, reaction_rate, amplification, contrast, 
                                         sine_type=sine_type)
        else:
            return jsonify(format_response(False, message="æœªçŸ¥æ¨¡å‹ç±»å‹")), 400
        return jsonify(format_response(True, data=plots)), 200
    except Exception as e:
        # è®°å½•å¼‚å¸¸å‚æ•°å’Œé”™è¯¯ä¿¡æ¯åˆ°æ—¥å¿—
        with open('dill_backend.log', 'a', encoding='utf-8') as f:
            f.write(f"[{datetime.datetime.now()}]\n")
            f.write(f"è¯·æ±‚å‚æ•°: {data if 'data' in locals() else 'æ— '}\n")
            f.write(f"å¼‚å¸¸ç±»å‹: {type(e).__name__}\n")
            f.write(f"å¼‚å¸¸ä¿¡æ¯: {str(e)}\n")
            f.write(f"å †æ ˆä¿¡æ¯: {traceback.format_exc()}\n\n")
        return jsonify({'success': False, 'message_zh': f"è®¡ç®—é”™è¯¯: {str(e)}", 'message_en': f"Calculation error: {str(e)}", 'data': None}), 500

@api_bp.route('/calculate_data', methods=['POST'])
def calculate_data():
    """
    è®¡ç®—æ¨¡å‹å¹¶è¿”å›åŸå§‹æ•°æ®ï¼ˆç”¨äºäº¤äº’å¼å›¾è¡¨ï¼‰
    æ–°å¢å‚æ•°: model_type, sine_type (æ”¯æŒ'1d', 'multi', '3d')
    """
    import time
    
    try:
        data = request.get_json()
        print('æ”¶åˆ°å‰ç«¯å‚æ•°:', data)  # è°ƒè¯•ç”¨
        model_type = data.get('model_type', 'dill')
        model = get_model_by_name(model_type)
        sine_type = data.get('sine_type', '1d')
        
        # å¼€å§‹è®¡ç®—æ—¶é—´ç»Ÿè®¡
        start_time = time.time()
        
        plot_data = None # Initialize plot_data

        # æ ¹æ®æ¨¡å‹ç±»å‹éªŒè¯å‚æ•°
        if model_type == 'dill':
            is_valid, message = validate_input(data)
            if not is_valid:
                print(f"å‚æ•°æ ¡éªŒå¤±è´¥: {message}, å‚æ•°: {data}")
                add_error_log('dill', f"å‚æ•°æ ¡éªŒå¤±è´¥: {message}", dimension=sine_type)
                return jsonify(format_response(False, message=message)), 400
            
            I_avg = float(data['I_avg'])
            V = float(data['V'])
            t_exp = float(data['t_exp'])
            C = float(data['C'])
            
            # æ·»åŠ è¯¦ç»†çš„å‚æ•°æ—¥å¿—
            if sine_type == 'multi':
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                phi_expr = data.get('phi_expr', '0')
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                y_points = int(data.get('y_points', 100))
                
                print(f"Dillæ¨¡å‹å‚æ•° (2Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, t_exp={t_exp}, C={C}")
                print(f"  äºŒç»´å‚æ•°: Kx={Kx}, Ky={Ky}, phi_expr='{phi_expr}'")
                print(f"  Yè½´èŒƒå›´: [{y_min}, {y_max}], ç‚¹æ•°: {y_points}")
                print(f"[Dill-2D] å¼€å§‹è®¡ç®—äºŒç»´ç©ºé—´åˆ†å¸ƒï¼Œç½‘æ ¼å¤§å°: 1000Ã—{y_points}")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'dill', f"Dill-2Dæ¨¡å‹å‚æ•° (2Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, t_exp={t_exp}, C={C}", dimension='2d')
                add_log_entry('info', 'dill', f"äºŒç»´å‚æ•°: Kx={Kx}, Ky={Ky}, phi_expr='{phi_expr}'", dimension='2d')
                add_log_entry('info', 'dill', f"Yè½´èŒƒå›´: [{y_min}, {y_max}], ç‚¹æ•°: {y_points}", dimension='2d')
                add_log_entry('progress', 'dill', f"å¼€å§‹è®¡ç®—äºŒç»´ç©ºé—´åˆ†å¸ƒï¼Œç½‘æ ¼å¤§å°: 1000Ã—{y_points}", dimension='2d')
                
                if y_min >= y_max:
                    add_error_log('dill', "Yè½´èŒƒå›´é…ç½®é”™è¯¯ï¼šæœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼", dimension='2d')
                    return jsonify(format_response(False, message_zh="Yè½´èŒƒå›´æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼", message_en="Y-axis range min must be less than max")), 400
                if y_points <= 1:
                    add_error_log('dill', "Yè½´ç‚¹æ•°é…ç½®é”™è¯¯ï¼šå¿…é¡»å¤§äº1", dimension='2d')
                    return jsonify(format_response(False, message_zh="Yè½´ç‚¹æ•°å¿…é¡»å¤§äº1æ‰èƒ½è¿›è¡ŒäºŒç»´è®¡ç®—", message_en="Number of Y-axis points must be greater than 1 for 2D calculation")), 400
                
                y_range = np.linspace(y_min, y_max, y_points).tolist()
                
                # å¼€å§‹è®¡ç®—
                calc_start = time.time()
                plot_data = model.generate_data(I_avg, V, None, t_exp, C, sine_type=sine_type, 
                                             Kx=Kx, Ky=Ky, phi_expr=phi_expr, y_range=y_range)
                calc_time = time.time() - calc_start
                
                # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                if plot_data and 'z_exposure_dose' in plot_data:
                    exposure_array = np.array(plot_data['z_exposure_dose'])
                    thickness_array = np.array(plot_data['z_thickness'])
                    
                    print(f"[Dill-2D] ğŸ¯ äºŒç»´è®¡ç®—å®Œæˆç»Ÿè®¡:")
                    print(f"  âœ… ç½‘æ ¼å¤§å°: {exposure_array.shape}")
                    print(f"  â±ï¸  è®¡ç®—æ—¶é—´: {calc_time:.3f}s")
                    print(f"  ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²")
                    print(f"  ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)")
                    print(f"  ğŸ’¾ æ•°æ®è´¨é‡: ä¼˜ç§€")
                    print(f"  ğŸ“Š ç»Ÿè®¡ç‰¹å¾:")
                    print(f"     æ›å…‰å‰‚é‡: å‡å€¼={exposure_array.mean():.3f}, æ ‡å‡†å·®={exposure_array.std():.3f}")
                    print(f"     åšåº¦åˆ†å¸ƒ: å‡å€¼={thickness_array.mean():.4f}, æ ‡å‡†å·®={thickness_array.std():.4f}")
                    
                    # æ·»åŠ è¯¦ç»†ç»Ÿè®¡åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('success', 'dill', f"ğŸ¯ äºŒç»´è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='2d')
                    add_log_entry('info', 'dill', f"âœ… ç½‘æ ¼å¤§å°: {exposure_array.shape}", dimension='2d')
                    add_log_entry('info', 'dill', f"â±ï¸ è®¡ç®—æ—¶é—´: {calc_time:.3f}s", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ’¾ æ•°æ®è´¨é‡: ä¼˜ç§€", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ“Š æ›å…‰å‰‚é‡ç»Ÿè®¡: å‡å€¼={exposure_array.mean():.3f}, æ ‡å‡†å·®={exposure_array.std():.3f}", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ“Š åšåº¦åˆ†å¸ƒç»Ÿè®¡: å‡å€¼={thickness_array.mean():.4f}, æ ‡å‡†å·®={thickness_array.std():.4f}", dimension='2d')
                    
                    # è®¡ç®—å¯¹æ¯”åº¦
                    cv_exposure = exposure_array.std() / exposure_array.mean() if exposure_array.mean() > 0 else 0
                    cv_thickness = thickness_array.std() / thickness_array.mean() if thickness_array.mean() > 0 else 0
                    
                    print(f"  ğŸ“ˆ é«˜å¯¹æ¯”åº¦æ£€æµ‹: æ›å…‰å‰‚é‡å˜åŒ–{'æ˜¾è‘—' if cv_exposure > 0.3 else 'é€‚ä¸­' if cv_exposure > 0.1 else 'è¾ƒå°'} (CV={cv_exposure:.3f})")
                    print(f"  ğŸ­ å¼ºè°ƒåˆ¶æ£€æµ‹: åšåº¦å˜åŒ–{'æ˜¾è‘—' if cv_thickness > 0.3 else 'é€‚ä¸­' if cv_thickness > 0.1 else 'è¾ƒå°'} (CV={cv_thickness:.3f})")
                    print(f"  ğŸ“ Dillæ¨¡å‹2Dç‰¹å¾åˆ†æ:")
                    print(f"     å¯¹æ¯”åº¦å› å­: {cv_exposure:.3f}")
                    print(f"     ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}")
                    print(f"     å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ")
                    
                    # æ·»åŠ åˆ†æç»“æœåˆ°æ—¥å¿—ç³»ç»Ÿ
                    contrast_level = 'æ˜¾è‘—' if cv_exposure > 0.3 else 'é€‚ä¸­' if cv_exposure > 0.1 else 'è¾ƒå°'
                    modulation_level = 'æ˜¾è‘—' if cv_thickness > 0.3 else 'é€‚ä¸­' if cv_thickness > 0.1 else 'è¾ƒå°'
                    add_log_entry('info', 'dill', f"ğŸ“ˆ é«˜å¯¹æ¯”åº¦æ£€æµ‹: æ›å…‰å‰‚é‡å˜åŒ–{contrast_level} (CV={cv_exposure:.3f})", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ­ å¼ºè°ƒåˆ¶æ£€æµ‹: åšåº¦å˜åŒ–{modulation_level} (CV={cv_thickness:.3f})", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ“ Dillæ¨¡å‹2Dç‰¹å¾åˆ†æ", dimension='2d')
                    add_log_entry('info', 'dill', f"   å¯¹æ¯”åº¦å› å­: {cv_exposure:.3f}", dimension='2d')
                    add_log_entry('info', 'dill', f"   ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}", dimension='2d')
                    add_log_entry('info', 'dill', f"   å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ", dimension='2d')
                
                add_success_log('dill', f"äºŒç»´è®¡ç®—å®Œæˆï¼Œç½‘æ ¼{exposure_array.shape}ï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='2d')
                
            elif sine_type == '3d':
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                Kz = float(data.get('Kz', 0))
                phi_expr = data.get('phi_expr', '0')
                x_min = float(data.get('x_min', 0))
                x_max = float(data.get('x_max', 10))
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                z_min = float(data.get('z_min', 0))
                z_max = float(data.get('z_max', 10))
                
                print(f"Dillæ¨¡å‹å‚æ•° (3Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, t_exp={t_exp}, C={C}")
                print(f"  ä¸‰ç»´å‚æ•°: Kx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr='{phi_expr}'")
                print(f"  Xè½´èŒƒå›´: [{x_min}, {x_max}]")
                print(f"  Yè½´èŒƒå›´: [{y_min}, {y_max}]")
                print(f"  Zè½´èŒƒå›´: [{z_min}, {z_max}]")
                print(f"[Dill-3D] å¼€å§‹è®¡ç®—ä¸‰ç»´ç©ºé—´åˆ†å¸ƒï¼Œé¢„è®¡ç½‘æ ¼å¤§å°: 50Ã—50Ã—50")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'dill', f"Dill-3Dæ¨¡å‹å‚æ•° (3Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, t_exp={t_exp}, C={C}", dimension='3d')
                add_log_entry('info', 'dill', f"ä¸‰ç»´å‚æ•°: Kx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr='{phi_expr}'", dimension='3d')
                add_log_entry('info', 'dill', f"Xè½´èŒƒå›´: [{x_min}, {x_max}]", dimension='3d')
                add_log_entry('info', 'dill', f"Yè½´èŒƒå›´: [{y_min}, {y_max}]", dimension='3d')
                add_log_entry('info', 'dill', f"Zè½´èŒƒå›´: [{z_min}, {z_max}]", dimension='3d')
                add_log_entry('progress', 'dill', f"å¼€å§‹è®¡ç®—ä¸‰ç»´ç©ºé—´åˆ†å¸ƒï¼Œé¢„è®¡ç½‘æ ¼å¤§å°: 50Ã—50Ã—50", dimension='3d')
                
                y_range = np.linspace(y_min, y_max, 50).tolist() if y_min < y_max else None
                z_range = np.linspace(z_min, z_max, 50).tolist() if z_min < z_max else None
                
                calc_start = time.time()
                try:
                    plot_data = model.generate_data(I_avg, V, None, t_exp, C, sine_type=sine_type,
                                                 Kx=Kx, Ky=Ky, Kz=Kz, phi_expr=phi_expr,
                                                 y_range=y_range, z_range=z_range)
                    calc_time = time.time() - calc_start
                    
                    print(f"[Dill-3D] ğŸ¯ ä¸‰ç»´è®¡ç®—å®Œæˆç»Ÿè®¡:")
                    print(f"  âœ… è®¡ç®—æˆåŠŸ")
                    print(f"  â±ï¸  è®¡ç®—æ—¶é—´: {calc_time:.3f}s")
                    print(f"  ğŸ’¾ æ•°æ®å­—æ®µ: {list(plot_data.keys())}")
                    
                    # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('success', 'dill', f"ğŸ¯ ä¸‰ç»´è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='3d')
                    add_log_entry('info', 'dill', f"âœ… è®¡ç®—æˆåŠŸ", dimension='3d')
                    add_log_entry('info', 'dill', f"â±ï¸ è®¡ç®—æ—¶é—´: {calc_time:.3f}s", dimension='3d')
                    add_log_entry('info', 'dill', f"ğŸ’¾ æ•°æ®å­—æ®µ: {list(plot_data.keys())}", dimension='3d')
                    
                    if 'exposure_dose' in plot_data:
                        exp_data = np.array(plot_data['exposure_dose'])
                        thick_data = np.array(plot_data['thickness'])
                        print(f"  ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exp_data.min():.3f}, {exp_data.max():.3f}] mJ/cmÂ²")
                        print(f"  ğŸ“ åšåº¦èŒƒå›´: [{thick_data.min():.4f}, {thick_data.max():.4f}] (å½’ä¸€åŒ–)")
                        print(f"  ğŸ“ Dillæ¨¡å‹3Dç‰¹å¾åˆ†æ:")
                        print(f"     æ•°æ®ç»´åº¦: {exp_data.shape if exp_data.ndim > 1 else '1D'}")
                        print(f"     ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}, Kz={Kz}")
                        print(f"     å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ")
                        
                        # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                        add_log_entry('info', 'dill', f"ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exp_data.min():.3f}, {exp_data.max():.3f}] mJ/cmÂ²", dimension='3d')
                        add_log_entry('info', 'dill', f"ğŸ“ åšåº¦èŒƒå›´: [{thick_data.min():.4f}, {thick_data.max():.4f}] (å½’ä¸€åŒ–)", dimension='3d')
                        add_log_entry('info', 'dill', f"ğŸ“ Dillæ¨¡å‹3Dç‰¹å¾åˆ†æ", dimension='3d')
                        add_log_entry('info', 'dill', f"   æ•°æ®ç»´åº¦: {exp_data.shape if exp_data.ndim > 1 else '1D'}", dimension='3d')
                        add_log_entry('info', 'dill', f"   ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}, Kz={Kz}", dimension='3d')
                        add_log_entry('info', 'dill', f"   å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ", dimension='3d')
                    
                    add_success_log('dill', f"ä¸‰ç»´è®¡ç®—å®Œæˆï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='3d')
                    
                except Exception as e:
                    calc_time = time.time() - calc_start
                    print(f"[Dill-3D] âŒ ä¸‰ç»´è®¡ç®—å‡ºé”™: {str(e)}")
                    print(f"[Dill-3D] â±ï¸  è®¡ç®—è€—æ—¶: {calc_time:.3f}s")
                    add_error_log('dill', f"ä¸‰ç»´è®¡ç®—å¤±è´¥: {str(e)}", dimension='3d')
                    add_log_entry('error', 'dill', f"âŒ ä¸‰ç»´è®¡ç®—å‡ºé”™: {str(e)}", dimension='3d')
                    add_log_entry('info', 'dill', f"â±ï¸ è®¡ç®—è€—æ—¶: {calc_time:.3f}s", dimension='3d')
                    raise
                    
            else: # 1D Dill
                K = float(data['K'])
                
                print(f"Dillæ¨¡å‹å‚æ•° (1Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, K={K}, t_exp={t_exp}, C={C}")
                print(f"[Dill-1D] å¼€å§‹è®¡ç®—ä¸€ç»´ç©ºé—´åˆ†å¸ƒï¼Œå…±1000ä¸ªä½ç½®")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'dill', f"Dill-1Dæ¨¡å‹å‚æ•° (1Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, K={K}, t_exp={t_exp}, C={C}", dimension='1d')
                add_log_entry('progress', 'dill', f"å¼€å§‹è®¡ç®—ä¸€ç»´ç©ºé—´åˆ†å¸ƒï¼Œå…±1000ä¸ªä½ç½®", dimension='1d')
                
                calc_start = time.time()
                plot_data = model.generate_data(I_avg, V, K, t_exp, C, sine_type=sine_type)
                calc_time = time.time() - calc_start
                
                if plot_data and 'exposure_dose' in plot_data:
                    exposure_array = np.array(plot_data['exposure_dose'])
                    thickness_array = np.array(plot_data['thickness'])
                    x_array = np.array(plot_data['x'])
                    
                    # æ¨¡æ‹Ÿè®¡ç®—è¿›åº¦è¾“å‡ºï¼ˆå› ä¸ºè®¡ç®—å¾ˆå¿«ï¼Œè¿™é‡Œç®€åŒ–æ˜¾ç¤ºï¼‰
                    # ç¡®ä¿æ•°ç»„é•¿åº¦è¶³å¤Ÿï¼Œé¿å…ç´¢å¼•è¶Šç•Œ
                    array_length = len(x_array)
                    
                    # åŠ¨æ€è®¡ç®—è¿›åº¦ç´¢å¼•ï¼Œç¡®ä¿ä¸è¶…è¿‡æ•°ç»„è¾¹ç•Œ
                    idx_20_percent = min(199, array_length - 1)
                    idx_50_percent = min(499, array_length - 1) 
                    idx_80_percent = min(799, array_length - 1)
                    
                    # å®‰å…¨çš„è¿›åº¦è¾“å‡º
                    print(f"[Dill-1D] è¿›åº¦: {idx_20_percent+1}/{array_length}, pos={x_array[idx_20_percent]:.3f}, exposure={exposure_array[idx_20_percent]:.3f}, thickness={thickness_array[idx_20_percent]:.4f}")
                    print(f"[Dill-1D] è¿›åº¦: {idx_50_percent+1}/{array_length}, pos={x_array[idx_50_percent]:.3f}, exposure={exposure_array[idx_50_percent]:.3f}, thickness={thickness_array[idx_50_percent]:.4f}")
                    print(f"[Dill-1D] è¿›åº¦: {idx_80_percent+1}/{array_length}, pos={x_array[idx_80_percent]:.3f}, exposure={exposure_array[idx_80_percent]:.3f}, thickness={thickness_array[idx_80_percent]:.4f}")
                    
                    # æ·»åŠ å®‰å…¨çš„è¿›åº¦ä¿¡æ¯åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('progress', 'dill', f"è¿›åº¦: {idx_20_percent+1}/{array_length}, pos={x_array[idx_20_percent]:.3f}, exposure={exposure_array[idx_20_percent]:.3f}, thickness={thickness_array[idx_20_percent]:.4f}", dimension='1d')
                    add_log_entry('progress', 'dill', f"è¿›åº¦: {idx_50_percent+1}/{array_length}, pos={x_array[idx_50_percent]:.3f}, exposure={exposure_array[idx_50_percent]:.3f}, thickness={thickness_array[idx_50_percent]:.4f}", dimension='1d')
                    add_log_entry('progress', 'dill', f"è¿›åº¦: {idx_80_percent+1}/{array_length}, pos={x_array[idx_80_percent]:.3f}, exposure={exposure_array[idx_80_percent]:.3f}, thickness={thickness_array[idx_80_percent]:.4f}", dimension='1d')
                    
                    print(f"[Dill-1D] ğŸ¯ è®¡ç®—å®Œæˆç»Ÿè®¡:")
                    print(f"  âœ… æˆåŠŸè®¡ç®—: 1000/1000 (100.0%)")
                    print(f"  âŒ å¤±è´¥è®¡ç®—: 0/1000 (0.0%)")
                    print(f"  â±ï¸  å¹³å‡è®¡ç®—æ—¶é—´: {calc_time/1000:.6f}s/ç‚¹")
                    print(f"  ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²")
                    print(f"  ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)")
                    print(f"  ğŸ’¾ æ•°æ®è´¨é‡: ä¼˜ç§€")
                    print(f"  ğŸ“Š ç»Ÿè®¡ç‰¹å¾:")
                    print(f"     æ›å…‰å‰‚é‡: å‡å€¼={exposure_array.mean():.3f}, æ ‡å‡†å·®={exposure_array.std():.3f}")
                    print(f"     åšåº¦åˆ†å¸ƒ: å‡å€¼={thickness_array.mean():.4f}, æ ‡å‡†å·®={thickness_array.std():.4f}")
                    
                    # æ·»åŠ è¯¦ç»†ç»Ÿè®¡åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('success', 'dill', f"ğŸ¯ è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='1d')
                    add_log_entry('info', 'dill', f"âœ… æˆåŠŸè®¡ç®—: 1000/1000 (100.0%)", dimension='1d')
                    add_log_entry('info', 'dill', f"âŒ å¤±è´¥è®¡ç®—: 0/1000 (0.0%)", dimension='1d')
                    add_log_entry('info', 'dill', f"â±ï¸ å¹³å‡è®¡ç®—æ—¶é—´: {calc_time/1000:.6f}s/ç‚¹", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ’¾ æ•°æ®è´¨é‡: ä¼˜ç§€", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ“Š æ›å…‰å‰‚é‡ç»Ÿè®¡: å‡å€¼={exposure_array.mean():.3f}, æ ‡å‡†å·®={exposure_array.std():.3f}", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ“Š åšåº¦åˆ†å¸ƒç»Ÿè®¡: å‡å€¼={thickness_array.mean():.4f}, æ ‡å‡†å·®={thickness_array.std():.4f}", dimension='1d')
                    
                    # è®¡ç®—å¯¹æ¯”åº¦
                    cv_exposure = exposure_array.std() / exposure_array.mean() if exposure_array.mean() > 0 else 0
                    cv_thickness = thickness_array.std() / thickness_array.mean() if thickness_array.mean() > 0 else 0
                    
                    print(f"  ğŸ“ˆ é«˜å¯¹æ¯”åº¦æ£€æµ‹: æ›å…‰å‰‚é‡å˜åŒ–{'æ˜¾è‘—' if cv_exposure > 0.3 else 'é€‚ä¸­' if cv_exposure > 0.1 else 'è¾ƒå°'} (CV={cv_exposure:.3f})")
                    print(f"  ğŸ­ å¼ºè°ƒåˆ¶æ£€æµ‹: åšåº¦å˜åŒ–{'æ˜¾è‘—' if cv_thickness > 0.3 else 'é€‚ä¸­' if cv_thickness > 0.1 else 'è¾ƒå°'} (CV={cv_thickness:.3f})")
                    print(f"  ğŸ“ Dillæ¨¡å‹ç‰¹å¾åˆ†æ:")
                    print(f"     å¯¹æ¯”åº¦å› å­: {cv_exposure:.3f}")
                    print(f"     åˆ†è¾¨ç‡ä¼°è®¡: {2*np.pi/K:.3f} Î¼m" if K > 0 else "æ— é™å¤§")
                    print(f"     å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ")
                    
                    # æ·»åŠ åˆ†æç»“æœåˆ°æ—¥å¿—ç³»ç»Ÿ
                    contrast_level = 'æ˜¾è‘—' if cv_exposure > 0.3 else 'é€‚ä¸­' if cv_exposure > 0.1 else 'è¾ƒå°'
                    modulation_level = 'æ˜¾è‘—' if cv_thickness > 0.3 else 'é€‚ä¸­' if cv_thickness > 0.1 else 'è¾ƒå°'
                    add_log_entry('info', 'dill', f"ğŸ“ˆ é«˜å¯¹æ¯”åº¦æ£€æµ‹: æ›å…‰å‰‚é‡å˜åŒ–{contrast_level} (CV={cv_exposure:.3f})", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ­ å¼ºè°ƒåˆ¶æ£€æµ‹: åšåº¦å˜åŒ–{modulation_level} (CV={cv_thickness:.3f})", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ“ Dillæ¨¡å‹ç‰¹å¾åˆ†æ", dimension='1d')
                    add_log_entry('info', 'dill', f"   å¯¹æ¯”åº¦å› å­: {cv_exposure:.3f}", dimension='1d')
                    resolution = f"{2*np.pi/K:.3f} Î¼m" if K > 0 else "æ— é™å¤§"
                    add_log_entry('info', 'dill', f"   åˆ†è¾¨ç‡ä¼°è®¡: {resolution}", dimension='1d')
                    add_log_entry('info', 'dill', f"   å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ", dimension='1d')
                
                add_success_log('dill', f"ä¸€ç»´è®¡ç®—å®Œæˆï¼Œ1000ç‚¹ï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='1d')
        
        elif model_type == 'enhanced_dill':
            is_valid, message = validate_enhanced_input(data)
            if not is_valid: 
                add_error_log('enhanced_dill', f"å‚æ•°æ ¡éªŒå¤±è´¥: {message}", dimension=sine_type)
                return jsonify(format_response(False, message=message)), 400
                
            z_h, T, t_B, I0, M0, t_exp_enh = float(data['z_h']), float(data['T']), float(data['t_B']), float(data.get('I0', 1.0)), float(data.get('M0', 1.0)), float(data['t_exp'])
            
            if sine_type == 'multi':
                Kx, Ky, phi_expr = float(data.get('Kx',0)), float(data.get('Ky',0)), data.get('phi_expr','0')
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                y_points = int(data.get('y_points', 100))
                
                print(f"å¢å¼ºDillæ¨¡å‹å‚æ•° (2Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}")
                print(f"  äºŒç»´å‚æ•°: Kx={Kx}, Ky={Ky}, phi_expr='{phi_expr}'")
                print(f"  Yè½´èŒƒå›´: [{y_min}, {y_max}], ç‚¹æ•°: {y_points}")
                print(f"[Enhanced-Dill-2D] å¼€å§‹è®¡ç®—åšèƒ¶äºŒç»´ç©ºé—´åˆ†å¸ƒï¼Œç½‘æ ¼å¤§å°: 1000Ã—{y_points}")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'enhanced_dill', f"å¢å¼ºDill-2Dæ¨¡å‹å‚æ•° (2Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}", dimension='2d')
                add_log_entry('info', 'enhanced_dill', f"äºŒç»´å‚æ•°: Kx={Kx}, Ky={Ky}, phi_expr='{phi_expr}'", dimension='2d')
                add_log_entry('info', 'enhanced_dill', f"Yè½´èŒƒå›´: [{y_min}, {y_max}], ç‚¹æ•°: {y_points}", dimension='2d')
                add_log_entry('progress', 'enhanced_dill', f"å¼€å§‹è®¡ç®—åšèƒ¶äºŒç»´ç©ºé—´åˆ†å¸ƒï¼Œç½‘æ ¼å¤§å°: 1000Ã—{y_points}", dimension='2d')
                
                if y_min >= y_max:
                    add_error_log('enhanced_dill', "Yè½´èŒƒå›´é…ç½®é”™è¯¯", dimension='2d')
                    return jsonify(format_response(False, message_zh="Yè½´èŒƒå›´æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼", message_en="Y-axis range min must be less than max")), 400
                if y_points <= 1:
                    add_error_log('enhanced_dill', "Yè½´ç‚¹æ•°é…ç½®é”™è¯¯", dimension='2d')
                    return jsonify(format_response(False, message_zh="Yè½´ç‚¹æ•°å¿…é¡»å¤§äº1æ‰èƒ½è¿›è¡ŒäºŒç»´è®¡ç®—", message_en="Number of Y-axis points must be greater than 1 for 2D calculation")), 400
                
                y_range = np.linspace(y_min, y_max, y_points).tolist()
                
                calc_start = time.time()
                plot_data = model.generate_data(z_h, T, t_B, I0, M0, t_exp_enh, sine_type=sine_type, Kx=Kx, Ky=Ky, phi_expr=phi_expr, y_range=y_range)
                calc_time = time.time() - calc_start
                
                if plot_data and 'z_exposure_dose' in plot_data:
                    exposure_array = np.array(plot_data['z_exposure_dose'])
                    thickness_array = np.array(plot_data['z_thickness'])
                    
                    print(f"[Enhanced-Dill-2D] ğŸ¯ äºŒç»´åšèƒ¶è®¡ç®—å®Œæˆç»Ÿè®¡:")
                    print(f"  âœ… ç½‘æ ¼å¤§å°: {exposure_array.shape}")
                    print(f"  â±ï¸  è®¡ç®—æ—¶é—´: {calc_time:.3f}s")
                    print(f"  ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²")
                    print(f"  ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)")
                    print(f"  ğŸ”¬ å¢å¼ºDillæ¨¡å‹åšèƒ¶åˆ†æ:")
                    print(f"     èƒ¶å±‚åšåº¦: {z_h}Î¼m")
                    print(f"     å‰çƒ˜æ¸©åº¦: {T}Â°C")
                    print(f"     å‰çƒ˜æ—¶é—´: {t_B}s")
                    print(f"     å…‰å¼ºè¡°å‡åˆ†æ: è€ƒè™‘æ·±åº¦ç›¸å…³å¸æ”¶")
                    print(f"     ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}")
                    
                    # æ·»åŠ è¯¦ç»†ç»Ÿè®¡åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('success', 'enhanced_dill', f"ğŸ¯ äºŒç»´åšèƒ¶è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"âœ… ç½‘æ ¼å¤§å°: {exposure_array.shape}", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"â±ï¸ è®¡ç®—æ—¶é—´: {calc_time:.3f}s", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ”¬ å¢å¼ºDillæ¨¡å‹åšèƒ¶åˆ†æ", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"   èƒ¶å±‚åšåº¦: {z_h}Î¼m", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"   å‰çƒ˜æ¸©åº¦: {T}Â°C", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"   å‰çƒ˜æ—¶é—´: {t_B}s", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"   å…‰å¼ºè¡°å‡åˆ†æ: è€ƒè™‘æ·±åº¦ç›¸å…³å¸æ”¶", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"   ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}", dimension='2d')
                
                add_success_log('enhanced_dill', f"äºŒç»´åšèƒ¶è®¡ç®—å®Œæˆï¼Œ{z_h}Î¼måšåº¦ï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='2d')
                
            elif sine_type == '3d':
                Kx, Ky, Kz, phi_expr = float(data.get('Kx',0)), float(data.get('Ky',0)), float(data.get('Kz',0)), data.get('phi_expr','0')
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                z_min = float(data.get('z_min', 0))
                z_max = float(data.get('z_max', 10))
                
                print(f"å¢å¼ºDillæ¨¡å‹å‚æ•° (3Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}")
                print(f"  ä¸‰ç»´å‚æ•°: Kx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr='{phi_expr}'")
                print(f"  Yè½´èŒƒå›´: [{y_min}, {y_max}]")
                print(f"  Zè½´èŒƒå›´: [{z_min}, {z_max}]")
                print(f"[Enhanced-Dill-3D] å¼€å§‹è®¡ç®—åšèƒ¶ä¸‰ç»´ç©ºé—´åˆ†å¸ƒï¼Œé¢„è®¡ç½‘æ ¼å¤§å°: 50Ã—50Ã—50")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'enhanced_dill', f"å¢å¼ºDill-3Dæ¨¡å‹å‚æ•° (3Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"ä¸‰ç»´å‚æ•°: Kx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr='{phi_expr}'", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"Yè½´èŒƒå›´: [{y_min}, {y_max}]", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"Zè½´èŒƒå›´: [{z_min}, {z_max}]", dimension='3d')
                add_log_entry('progress', 'enhanced_dill', f"å¼€å§‹è®¡ç®—åšèƒ¶ä¸‰ç»´ç©ºé—´åˆ†å¸ƒï¼Œé¢„è®¡ç½‘æ ¼å¤§å°: 50Ã—50Ã—50", dimension='3d')
                
                y_range = np.linspace(y_min, y_max, 50).tolist() if y_min < y_max else None
                z_range = np.linspace(z_min, z_max, 50).tolist() if z_min < z_max else None
                
                calc_start = time.time()
                plot_data = model.generate_data(z_h, T, t_B, I0, M0, t_exp_enh, sine_type=sine_type, Kx=Kx, Ky=Ky, Kz=Kz, phi_expr=phi_expr, y_range=y_range, z_range=z_range)
                calc_time = time.time() - calc_start
                
                print(f"[Enhanced-Dill-3D] ğŸ¯ ä¸‰ç»´åšèƒ¶è®¡ç®—å®Œæˆç»Ÿè®¡:")
                print(f"  âœ… è®¡ç®—æˆåŠŸ")
                print(f"  â±ï¸  è®¡ç®—æ—¶é—´: {calc_time:.3f}s")
                print(f"  ğŸ”¬ å¢å¼ºDillæ¨¡å‹3Dåšèƒ¶åˆ†æ:")
                print(f"     èƒ¶å±‚åšåº¦: {z_h}Î¼m")
                print(f"     å‰çƒ˜æ¡ä»¶: {T}Â°C, {t_B}s")
                print(f"     ä¸‰ç»´ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}, Kz={Kz}")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('success', 'enhanced_dill', f"ğŸ¯ ä¸‰ç»´åšèƒ¶è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"âœ… è®¡ç®—æˆåŠŸ", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"â±ï¸ è®¡ç®—æ—¶é—´: {calc_time:.3f}s", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"ğŸ”¬ å¢å¼ºDillæ¨¡å‹3Dåšèƒ¶åˆ†æ", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"   èƒ¶å±‚åšåº¦: {z_h}Î¼m", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"   å‰çƒ˜æ¡ä»¶: {T}Â°C, {t_B}s", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"   ä¸‰ç»´ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}, Kz={Kz}", dimension='3d')
                
                add_success_log('enhanced_dill', f"ä¸‰ç»´åšèƒ¶è®¡ç®—å®Œæˆï¼Œ{z_h}Î¼måšåº¦ï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='3d')
                
            else: # 1D Enhanced Dill
                K = float(data.get('K', 2.0))
                V = float(data.get('V', 0.8))
                
                print(f"å¢å¼ºDillæ¨¡å‹å‚æ•° (1Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}")
                print(f"  å…‰å­¦å‚æ•°: K={K}, V={V}")
                print(f"[Enhanced-Dill-1D] å¼€å§‹è®¡ç®—åšèƒ¶ä¸€ç»´ç©ºé—´åˆ†å¸ƒï¼Œå…±1000ä¸ªä½ç½®")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'enhanced_dill', f"å¢å¼ºDill-1Dæ¨¡å‹å‚æ•° (1Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}", dimension='1d')
                add_log_entry('info', 'enhanced_dill', f"å…‰å­¦å‚æ•°: K={K}, V={V}", dimension='1d')
                add_log_entry('progress', 'enhanced_dill', f"å¼€å§‹è®¡ç®—åšèƒ¶ä¸€ç»´ç©ºé—´åˆ†å¸ƒï¼Œå…±1000ä¸ªä½ç½®", dimension='1d')
                
                calc_start = time.time()
                # ä¿®å¤ï¼šä¸ºåšèƒ¶1Dæ¨¡å‹æŒ‡å®šè¶³å¤Ÿçš„ç‚¹æ•°ï¼Œç¡®ä¿ç´¢å¼•ä¸è¶Šç•Œ
                plot_data = model.generate_data(z_h, T, t_B, I0, M0, t_exp_enh, sine_type=sine_type, K=K, V=V, num_points=1000)
                calc_time = time.time() - calc_start
                
                if plot_data and 'exposure_dose' in plot_data:
                    exposure_array = np.array(plot_data['exposure_dose'])
                    thickness_array = np.array(plot_data['thickness'])
                    x_array = np.array(plot_data['x'])
                    
                    # ç¡®ä¿æ•°ç»„é•¿åº¦è¶³å¤Ÿï¼Œé¿å…ç´¢å¼•è¶Šç•Œ
                    array_length = len(x_array)
                    
                    # åŠ¨æ€è®¡ç®—è¿›åº¦ç´¢å¼•ï¼Œç¡®ä¿ä¸è¶…è¿‡æ•°ç»„è¾¹ç•Œ
                    idx_20_percent = min(199, array_length - 1)
                    idx_50_percent = min(499, array_length - 1) 
                    idx_80_percent = min(799, array_length - 1)
                    
                    # å®‰å…¨çš„è¿›åº¦è¾“å‡º
                    print(f"[Enhanced-Dill-1D] è¿›åº¦: {idx_20_percent+1}/{array_length}, pos={x_array[idx_20_percent]:.3f}, exposure={exposure_array[idx_20_percent]:.3f}, thickness={thickness_array[idx_20_percent]:.4f}")
                    print(f"[Enhanced-Dill-1D] è¿›åº¦: {idx_50_percent+1}/{array_length}, pos={x_array[idx_50_percent]:.3f}, exposure={exposure_array[idx_50_percent]:.3f}, thickness={thickness_array[idx_50_percent]:.4f}")
                    print(f"[Enhanced-Dill-1D] è¿›åº¦: {idx_80_percent+1}/{array_length}, pos={x_array[idx_80_percent]:.3f}, exposure={exposure_array[idx_80_percent]:.3f}, thickness={thickness_array[idx_80_percent]:.4f}")
                    
                    # æ·»åŠ å®‰å…¨çš„è¿›åº¦ä¿¡æ¯åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('progress', 'enhanced_dill', f"è¿›åº¦: {idx_20_percent+1}/{array_length}, pos={x_array[idx_20_percent]:.3f}, exposure={exposure_array[idx_20_percent]:.3f}, thickness={thickness_array[idx_20_percent]:.4f}", dimension='1d')
                    add_log_entry('progress', 'enhanced_dill', f"è¿›åº¦: {idx_50_percent+1}/{array_length}, pos={x_array[idx_50_percent]:.3f}, exposure={exposure_array[idx_50_percent]:.3f}, thickness={thickness_array[idx_50_percent]:.4f}", dimension='1d')
                    add_log_entry('progress', 'enhanced_dill', f"è¿›åº¦: {idx_80_percent+1}/{array_length}, pos={x_array[idx_80_percent]:.3f}, exposure={exposure_array[idx_80_percent]:.3f}, thickness={thickness_array[idx_80_percent]:.4f}", dimension='1d')
                    
                    print(f"[Enhanced-Dill-1D] ğŸ¯ è®¡ç®—å®Œæˆç»Ÿè®¡:")
                    print(f"  âœ… æˆåŠŸè®¡ç®—: 1000/1000 (100.0%)")
                    print(f"  âŒ å¤±è´¥è®¡ç®—: 0/1000 (0.0%)")
                    print(f"  â±ï¸  å¹³å‡è®¡ç®—æ—¶é—´: {calc_time/1000:.6f}s/ç‚¹")
                    print(f"  ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²")
                    print(f"  ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)")
                    print(f"  ğŸ”¬ å¢å¼ºDillæ¨¡å‹åšèƒ¶åˆ†æ:")
                    print(f"     èƒ¶å±‚åšåº¦: {z_h}Î¼m")
                    print(f"     å‰çƒ˜æ¸©åº¦: {T}Â°C")
                    print(f"     å‰çƒ˜æ—¶é—´: {t_B}s")
                    if z_h > 5:
                        print(f"     åšèƒ¶å±‚({z_h}Î¼m): é€‚åˆä½¿ç”¨å¢å¼ºDillæ¨¡å‹")
                    else:
                        print(f"     è–„èƒ¶å±‚({z_h}Î¼m): å¯è€ƒè™‘ä½¿ç”¨æ ‡å‡†Dillæ¨¡å‹")
                    
                    # æ·»åŠ è¯¦ç»†ç»Ÿè®¡åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('success', 'enhanced_dill', f"ğŸ¯ è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"âœ… æˆåŠŸè®¡ç®—: 1000/1000 (100.0%)", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"âŒ å¤±è´¥è®¡ç®—: 0/1000 (0.0%)", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"â±ï¸ å¹³å‡è®¡ç®—æ—¶é—´: {calc_time/1000:.6f}s/ç‚¹", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ”¬ å¢å¼ºDillæ¨¡å‹åšèƒ¶åˆ†æ", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"   èƒ¶å±‚åšåº¦: {z_h}Î¼m", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"   å‰çƒ˜æ¸©åº¦: {T}Â°C", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"   å‰çƒ˜æ—¶é—´: {t_B}s", dimension='1d')
                    
                    # æ·»åŠ åšèƒ¶å±‚åˆ†æ
                    if z_h > 5:
                        analysis_msg = f"åšèƒ¶å±‚({z_h}Î¼m): é€‚åˆä½¿ç”¨å¢å¼ºDillæ¨¡å‹"
                    else:
                        analysis_msg = f"è–„èƒ¶å±‚({z_h}Î¼m): å¯è€ƒè™‘ä½¿ç”¨æ ‡å‡†Dillæ¨¡å‹"
                    add_log_entry('info', 'enhanced_dill', f"   {analysis_msg}", dimension='1d')
                
                add_success_log('enhanced_dill', f"ä¸€ç»´åšèƒ¶è®¡ç®—å®Œæˆï¼Œ{z_h}Î¼måšåº¦ï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='1d')

        elif model_type == 'car':
            is_valid, message = validate_car_input(data)
            if not is_valid: 
                add_error_log('car', f"å‚æ•°æ ¡éªŒå¤±è´¥: {message}", dimension=sine_type)
                return jsonify(format_response(False, message=message)), 400
                
            I_avg = float(data['I_avg'])
            V = float(data['V'])
            t_exp = float(data['t_exp'])
            acid_gen_efficiency = float(data['acid_gen_efficiency'])
            diffusion_length = float(data['diffusion_length'])
            reaction_rate = float(data['reaction_rate'])
            amplification = float(data['amplification'])
            contrast = float(data['contrast'])
            sine_type = data.get('sine_type', '1d')
            
            if sine_type == 'multi':
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                phi_expr = data.get('phi_expr', '0')
                # ä¸ºCARæ¨¡å‹æ·»åŠ y_rangeå‚æ•°å¤„ç†
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                y_points = int(data.get('y_points', 100))
                
                if y_min >= y_max:
                    return jsonify(format_response(False, message_zh="Yè½´èŒƒå›´æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼", message_en="Y-axis range min must be less than max")), 400
                if y_points <= 1:
                    return jsonify(format_response(False, message_zh="Yè½´ç‚¹æ•°å¿…é¡»å¤§äº1æ‰èƒ½è¿›è¡ŒäºŒç»´è®¡ç®—", message_en="Number of Y-axis points must be greater than 1 for 2D calculation")), 400
                
                y_range = np.linspace(y_min, y_max, y_points).tolist()
                plot_data = model.generate_plots(I_avg, V, None, t_exp, acid_gen_efficiency, 
                                         diffusion_length, reaction_rate, amplification, contrast, 
                                         sine_type=sine_type, Kx=Kx, Ky=Ky, phi_expr=phi_expr, y_range=y_range)
            elif sine_type == '3d':
                # å¤„ç†ä¸‰ç»´æ­£å¼¦æ³¢å‚æ•°
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                Kz = float(data.get('Kz', 0))
                phi_expr = data.get('phi_expr', '0')
                
                # è·å–ä¸‰ç»´èŒƒå›´å‚æ•°
                x_min = float(data.get('x_min', 0))
                x_max = float(data.get('x_max', 10))
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                z_min = float(data.get('z_min', 0))
                z_max = float(data.get('z_max', 10))
                
                # æ‰“å°è¯¦ç»†å‚æ•°ç”¨äºè°ƒè¯•
                print(f"è®¡ç®—3Dè–„èƒ¶æ¨¡å‹ï¼Œå‚æ•°ï¼šKx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr={phi_expr}")
                print(f"èŒƒå›´å‚æ•°ï¼šx_min={x_min}, x_max={x_max}, y_min={y_min}, y_max={y_max}, z_min={z_min}, z_max={z_max}")
                
                y_range = np.linspace(y_min, y_max, 50).tolist() if y_min < y_max else None
                z_range = np.linspace(z_min, z_max, 50).tolist() if z_min < z_max else None
                
                # æ‰“å°ç”Ÿæˆçš„èŒƒå›´ä¿¡æ¯
                print(f"ç”Ÿæˆçš„èŒƒå›´ï¼šy_rangeé•¿åº¦={len(y_range) if y_range else 0}, z_rangeé•¿åº¦={len(z_range) if z_range else 0}")
                
                try:
                    plots = model.generate_plots(I_avg, V, None, t_exp, acid_gen_efficiency, 
                                               diffusion_length, reaction_rate, amplification, contrast,
                                               sine_type=sine_type, Kx=Kx, Ky=Ky, Kz=Kz, phi_expr=phi_expr,
                                               y_range=y_range, z_range=z_range)
                    # æ‰“å°è¿”å›æ•°æ®çš„ç»“æ„
                    print(f"è¿”å›æ•°æ®å­—æ®µï¼š{list(plots.keys())}")
                    if 'exposure_dose' in plots:
                        if isinstance(plots['exposure_dose'], list):
                            print(f"exposure_doseæ˜¯åˆ—è¡¨ï¼Œé•¿åº¦={len(plots['exposure_dose'])}")
                            if len(plots['exposure_dose']) > 0 and isinstance(plots['exposure_dose'][0], list):
                                print(f"exposure_doseæ˜¯äºŒç»´åˆ—è¡¨ï¼Œå½¢çŠ¶=[{len(plots['exposure_dose'])}, {len(plots['exposure_dose'][0]) if len(plots['exposure_dose']) > 0 else 0}]")
                            else:
                                print(f"exposure_doseæ˜¯ä¸€ç»´åˆ—è¡¨")
                except Exception as e:
                    print(f"ç”Ÿæˆ3Dæ•°æ®æ—¶å‡ºé”™ï¼š{str(e)}")
                    # è®°å½•é”™è¯¯å †æ ˆä»¥ä¾¿è°ƒè¯•
                    traceback.print_exc()
                    raise
            else:
                K = float(data['K'])
                plots = model.generate_plots(I_avg, V, K, t_exp, acid_gen_efficiency, 
                                         diffusion_length, reaction_rate, amplification, contrast, 
                                         sine_type=sine_type)
        else:
            return jsonify(format_response(False, message="æœªçŸ¥æ¨¡å‹ç±»å‹")), 400
        return jsonify(format_response(True, data=plots)), 200
    except Exception as e:
        # è®°å½•å¼‚å¸¸å‚æ•°å’Œé”™è¯¯ä¿¡æ¯åˆ°æ—¥å¿—
        with open('dill_backend.log', 'a', encoding='utf-8') as f:
            f.write(f"[{datetime.datetime.now()}]\n")
            f.write(f"è¯·æ±‚å‚æ•°: {data if 'data' in locals() else 'æ— '}\n")
            f.write(f"å¼‚å¸¸ç±»å‹: {type(e).__name__}\n")
            f.write(f"å¼‚å¸¸ä¿¡æ¯: {str(e)}\n")
            f.write(f"å †æ ˆä¿¡æ¯: {traceback.format_exc()}\n\n")
        return jsonify({'success': False, 'message_zh': f"è®¡ç®—é”™è¯¯: {str(e)}", 'message_en': f"Calculation error: {str(e)}", 'data': None}), 500

@api_bp.route('/calculate_data', methods=['POST'])
def calculate_data():
    """
    è®¡ç®—æ¨¡å‹å¹¶è¿”å›åŸå§‹æ•°æ®ï¼ˆç”¨äºäº¤äº’å¼å›¾è¡¨ï¼‰
    æ–°å¢å‚æ•°: model_type, sine_type (æ”¯æŒ'1d', 'multi', '3d')
    """
    import time
    
    try:
        data = request.get_json()
        print('æ”¶åˆ°å‰ç«¯å‚æ•°:', data)  # è°ƒè¯•ç”¨
        model_type = data.get('model_type', 'dill')
        model = get_model_by_name(model_type)
        sine_type = data.get('sine_type', '1d')
        
        # å¼€å§‹è®¡ç®—æ—¶é—´ç»Ÿè®¡
        start_time = time.time()
        
        plot_data = None # Initialize plot_data

        # æ ¹æ®æ¨¡å‹ç±»å‹éªŒè¯å‚æ•°
        if model_type == 'dill':
            is_valid, message = validate_input(data)
            if not is_valid:
                print(f"å‚æ•°æ ¡éªŒå¤±è´¥: {message}, å‚æ•°: {data}")
                add_error_log('dill', f"å‚æ•°æ ¡éªŒå¤±è´¥: {message}", dimension=sine_type)
                return jsonify(format_response(False, message=message)), 400
            
            I_avg = float(data['I_avg'])
            V = float(data['V'])
            t_exp = float(data['t_exp'])
            C = float(data['C'])
            
            # æ·»åŠ è¯¦ç»†çš„å‚æ•°æ—¥å¿—
            if sine_type == 'multi':
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                phi_expr = data.get('phi_expr', '0')
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                y_points = int(data.get('y_points', 100))
                
                print(f"Dillæ¨¡å‹å‚æ•° (2Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, t_exp={t_exp}, C={C}")
                print(f"  äºŒç»´å‚æ•°: Kx={Kx}, Ky={Ky}, phi_expr='{phi_expr}'")
                print(f"  Yè½´èŒƒå›´: [{y_min}, {y_max}], ç‚¹æ•°: {y_points}")
                print(f"[Dill-2D] å¼€å§‹è®¡ç®—äºŒç»´ç©ºé—´åˆ†å¸ƒï¼Œç½‘æ ¼å¤§å°: 1000Ã—{y_points}")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'dill', f"Dill-2Dæ¨¡å‹å‚æ•° (2Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, t_exp={t_exp}, C={C}", dimension='2d')
                add_log_entry('info', 'dill', f"äºŒç»´å‚æ•°: Kx={Kx}, Ky={Ky}, phi_expr='{phi_expr}'", dimension='2d')
                add_log_entry('info', 'dill', f"Yè½´èŒƒå›´: [{y_min}, {y_max}], ç‚¹æ•°: {y_points}", dimension='2d')
                add_log_entry('progress', 'dill', f"å¼€å§‹è®¡ç®—äºŒç»´ç©ºé—´åˆ†å¸ƒï¼Œç½‘æ ¼å¤§å°: 1000Ã—{y_points}", dimension='2d')
                
                if y_min >= y_max:
                    add_error_log('dill', "Yè½´èŒƒå›´é…ç½®é”™è¯¯ï¼šæœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼", dimension='2d')
                    return jsonify(format_response(False, message_zh="Yè½´èŒƒå›´æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼", message_en="Y-axis range min must be less than max")), 400
                if y_points <= 1:
                    add_error_log('dill', "Yè½´ç‚¹æ•°é…ç½®é”™è¯¯ï¼šå¿…é¡»å¤§äº1", dimension='2d')
                    return jsonify(format_response(False, message_zh="Yè½´ç‚¹æ•°å¿…é¡»å¤§äº1æ‰èƒ½è¿›è¡ŒäºŒç»´è®¡ç®—", message_en="Number of Y-axis points must be greater than 1 for 2D calculation")), 400
                
                y_range = np.linspace(y_min, y_max, y_points).tolist()
                
                # å¼€å§‹è®¡ç®—
                calc_start = time.time()
                plot_data = model.generate_data(I_avg, V, None, t_exp, C, sine_type=sine_type, 
                                             Kx=Kx, Ky=Ky, phi_expr=phi_expr, y_range=y_range)
                calc_time = time.time() - calc_start
                
                # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                if plot_data and 'z_exposure_dose' in plot_data:
                    exposure_array = np.array(plot_data['z_exposure_dose'])
                    thickness_array = np.array(plot_data['z_thickness'])
                    
                    print(f"[Dill-2D] ğŸ¯ äºŒç»´è®¡ç®—å®Œæˆç»Ÿè®¡:")
                    print(f"  âœ… ç½‘æ ¼å¤§å°: {exposure_array.shape}")
                    print(f"  â±ï¸  è®¡ç®—æ—¶é—´: {calc_time:.3f}s")
                    print(f"  ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²")
                    print(f"  ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)")
                    print(f"  ğŸ’¾ æ•°æ®è´¨é‡: ä¼˜ç§€")
                    print(f"  ğŸ“Š ç»Ÿè®¡ç‰¹å¾:")
                    print(f"     æ›å…‰å‰‚é‡: å‡å€¼={exposure_array.mean():.3f}, æ ‡å‡†å·®={exposure_array.std():.3f}")
                    print(f"     åšåº¦åˆ†å¸ƒ: å‡å€¼={thickness_array.mean():.4f}, æ ‡å‡†å·®={thickness_array.std():.4f}")
                    
                    # æ·»åŠ è¯¦ç»†ç»Ÿè®¡åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('success', 'dill', f"ğŸ¯ äºŒç»´è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='2d')
                    add_log_entry('info', 'dill', f"âœ… ç½‘æ ¼å¤§å°: {exposure_array.shape}", dimension='2d')
                    add_log_entry('info', 'dill', f"â±ï¸ è®¡ç®—æ—¶é—´: {calc_time:.3f}s", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ’¾ æ•°æ®è´¨é‡: ä¼˜ç§€", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ“Š æ›å…‰å‰‚é‡ç»Ÿè®¡: å‡å€¼={exposure_array.mean():.3f}, æ ‡å‡†å·®={exposure_array.std():.3f}", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ“Š åšåº¦åˆ†å¸ƒç»Ÿè®¡: å‡å€¼={thickness_array.mean():.4f}, æ ‡å‡†å·®={thickness_array.std():.4f}", dimension='2d')
                    
                    # è®¡ç®—å¯¹æ¯”åº¦
                    cv_exposure = exposure_array.std() / exposure_array.mean() if exposure_array.mean() > 0 else 0
                    cv_thickness = thickness_array.std() / thickness_array.mean() if thickness_array.mean() > 0 else 0
                    
                    print(f"  ğŸ“ˆ é«˜å¯¹æ¯”åº¦æ£€æµ‹: æ›å…‰å‰‚é‡å˜åŒ–{'æ˜¾è‘—' if cv_exposure > 0.3 else 'é€‚ä¸­' if cv_exposure > 0.1 else 'è¾ƒå°'} (CV={cv_exposure:.3f})")
                    print(f"  ğŸ­ å¼ºè°ƒåˆ¶æ£€æµ‹: åšåº¦å˜åŒ–{'æ˜¾è‘—' if cv_thickness > 0.3 else 'é€‚ä¸­' if cv_thickness > 0.1 else 'è¾ƒå°'} (CV={cv_thickness:.3f})")
                    print(f"  ğŸ“ Dillæ¨¡å‹2Dç‰¹å¾åˆ†æ:")
                    print(f"     å¯¹æ¯”åº¦å› å­: {cv_exposure:.3f}")
                    print(f"     ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}")
                    print(f"     å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ")
                    
                    # æ·»åŠ åˆ†æç»“æœåˆ°æ—¥å¿—ç³»ç»Ÿ
                    contrast_level = 'æ˜¾è‘—' if cv_exposure > 0.3 else 'é€‚ä¸­' if cv_exposure > 0.1 else 'è¾ƒå°'
                    modulation_level = 'æ˜¾è‘—' if cv_thickness > 0.3 else 'é€‚ä¸­' if cv_thickness > 0.1 else 'è¾ƒå°'
                    add_log_entry('info', 'dill', f"ğŸ“ˆ é«˜å¯¹æ¯”åº¦æ£€æµ‹: æ›å…‰å‰‚é‡å˜åŒ–{contrast_level} (CV={cv_exposure:.3f})", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ­ å¼ºè°ƒåˆ¶æ£€æµ‹: åšåº¦å˜åŒ–{modulation_level} (CV={cv_thickness:.3f})", dimension='2d')
                    add_log_entry('info', 'dill', f"ğŸ“ Dillæ¨¡å‹2Dç‰¹å¾åˆ†æ", dimension='2d')
                    add_log_entry('info', 'dill', f"   å¯¹æ¯”åº¦å› å­: {cv_exposure:.3f}", dimension='2d')
                    add_log_entry('info', 'dill', f"   ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}", dimension='2d')
                    add_log_entry('info', 'dill', f"   å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ", dimension='2d')
                
                add_success_log('dill', f"äºŒç»´è®¡ç®—å®Œæˆï¼Œç½‘æ ¼{exposure_array.shape}ï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='2d')
                
            elif sine_type == '3d':
                Kx = float(data.get('Kx', 0))
                Ky = float(data.get('Ky', 0))
                Kz = float(data.get('Kz', 0))
                phi_expr = data.get('phi_expr', '0')
                x_min = float(data.get('x_min', 0))
                x_max = float(data.get('x_max', 10))
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                z_min = float(data.get('z_min', 0))
                z_max = float(data.get('z_max', 10))
                
                print(f"Dillæ¨¡å‹å‚æ•° (3Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, t_exp={t_exp}, C={C}")
                print(f"  ä¸‰ç»´å‚æ•°: Kx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr='{phi_expr}'")
                print(f"  Xè½´èŒƒå›´: [{x_min}, {x_max}]")
                print(f"  Yè½´èŒƒå›´: [{y_min}, {y_max}]")
                print(f"  Zè½´èŒƒå›´: [{z_min}, {z_max}]")
                print(f"[Dill-3D] å¼€å§‹è®¡ç®—ä¸‰ç»´ç©ºé—´åˆ†å¸ƒï¼Œé¢„è®¡ç½‘æ ¼å¤§å°: 50Ã—50Ã—50")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'dill', f"Dill-3Dæ¨¡å‹å‚æ•° (3Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, t_exp={t_exp}, C={C}", dimension='3d')
                add_log_entry('info', 'dill', f"ä¸‰ç»´å‚æ•°: Kx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr='{phi_expr}'", dimension='3d')
                add_log_entry('info', 'dill', f"Xè½´èŒƒå›´: [{x_min}, {x_max}]", dimension='3d')
                add_log_entry('info', 'dill', f"Yè½´èŒƒå›´: [{y_min}, {y_max}]", dimension='3d')
                add_log_entry('info', 'dill', f"Zè½´èŒƒå›´: [{z_min}, {z_max}]", dimension='3d')
                add_log_entry('progress', 'dill', f"å¼€å§‹è®¡ç®—ä¸‰ç»´ç©ºé—´åˆ†å¸ƒï¼Œé¢„è®¡ç½‘æ ¼å¤§å°: 50Ã—50Ã—50", dimension='3d')
                
                y_range = np.linspace(y_min, y_max, 50).tolist() if y_min < y_max else None
                z_range = np.linspace(z_min, z_max, 50).tolist() if z_min < z_max else None
                
                calc_start = time.time()
                try:
                    plot_data = model.generate_data(I_avg, V, None, t_exp, C, sine_type=sine_type,
                                                 Kx=Kx, Ky=Ky, Kz=Kz, phi_expr=phi_expr,
                                                 y_range=y_range, z_range=z_range)
                    calc_time = time.time() - calc_start
                    
                    print(f"[Dill-3D] ğŸ¯ ä¸‰ç»´è®¡ç®—å®Œæˆç»Ÿè®¡:")
                    print(f"  âœ… è®¡ç®—æˆåŠŸ")
                    print(f"  â±ï¸  è®¡ç®—æ—¶é—´: {calc_time:.3f}s")
                    print(f"  ğŸ’¾ æ•°æ®å­—æ®µ: {list(plot_data.keys())}")
                    
                    # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('success', 'dill', f"ğŸ¯ ä¸‰ç»´è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='3d')
                    add_log_entry('info', 'dill', f"âœ… è®¡ç®—æˆåŠŸ", dimension='3d')
                    add_log_entry('info', 'dill', f"â±ï¸ è®¡ç®—æ—¶é—´: {calc_time:.3f}s", dimension='3d')
                    add_log_entry('info', 'dill', f"ğŸ’¾ æ•°æ®å­—æ®µ: {list(plot_data.keys())}", dimension='3d')
                    
                    if 'exposure_dose' in plot_data:
                        exp_data = np.array(plot_data['exposure_dose'])
                        thick_data = np.array(plot_data['thickness'])
                        print(f"  ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exp_data.min():.3f}, {exp_data.max():.3f}] mJ/cmÂ²")
                        print(f"  ğŸ“ åšåº¦èŒƒå›´: [{thick_data.min():.4f}, {thick_data.max():.4f}] (å½’ä¸€åŒ–)")
                        print(f"  ğŸ“ Dillæ¨¡å‹3Dç‰¹å¾åˆ†æ:")
                        print(f"     æ•°æ®ç»´åº¦: {exp_data.shape if exp_data.ndim > 1 else '1D'}")
                        print(f"     ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}, Kz={Kz}")
                        print(f"     å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ")
                        
                        # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                        add_log_entry('info', 'dill', f"ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exp_data.min():.3f}, {exp_data.max():.3f}] mJ/cmÂ²", dimension='3d')
                        add_log_entry('info', 'dill', f"ğŸ“ åšåº¦èŒƒå›´: [{thick_data.min():.4f}, {thick_data.max():.4f}] (å½’ä¸€åŒ–)", dimension='3d')
                        add_log_entry('info', 'dill', f"ğŸ“ Dillæ¨¡å‹3Dç‰¹å¾åˆ†æ", dimension='3d')
                        add_log_entry('info', 'dill', f"   æ•°æ®ç»´åº¦: {exp_data.shape if exp_data.ndim > 1 else '1D'}", dimension='3d')
                        add_log_entry('info', 'dill', f"   ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}, Kz={Kz}", dimension='3d')
                        add_log_entry('info', 'dill', f"   å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ", dimension='3d')
                    
                    add_success_log('dill', f"ä¸‰ç»´è®¡ç®—å®Œæˆï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='3d')
                    
                except Exception as e:
                    calc_time = time.time() - calc_start
                    print(f"[Dill-3D] âŒ ä¸‰ç»´è®¡ç®—å‡ºé”™: {str(e)}")
                    print(f"[Dill-3D] â±ï¸  è®¡ç®—è€—æ—¶: {calc_time:.3f}s")
                    add_error_log('dill', f"ä¸‰ç»´è®¡ç®—å¤±è´¥: {str(e)}", dimension='3d')
                    add_log_entry('error', 'dill', f"âŒ ä¸‰ç»´è®¡ç®—å‡ºé”™: {str(e)}", dimension='3d')
                    add_log_entry('info', 'dill', f"â±ï¸ è®¡ç®—è€—æ—¶: {calc_time:.3f}s", dimension='3d')
                    raise
                    
            else: # 1D Dill
                K = float(data['K'])
                
                print(f"Dillæ¨¡å‹å‚æ•° (1Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, K={K}, t_exp={t_exp}, C={C}")
                print(f"[Dill-1D] å¼€å§‹è®¡ç®—ä¸€ç»´ç©ºé—´åˆ†å¸ƒï¼Œå…±1000ä¸ªä½ç½®")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'dill', f"Dill-1Dæ¨¡å‹å‚æ•° (1Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V}, K={K}, t_exp={t_exp}, C={C}", dimension='1d')
                add_log_entry('progress', 'dill', f"å¼€å§‹è®¡ç®—ä¸€ç»´ç©ºé—´åˆ†å¸ƒï¼Œå…±1000ä¸ªä½ç½®", dimension='1d')
                
                calc_start = time.time()
                plot_data = model.generate_data(I_avg, V, K, t_exp, C, sine_type=sine_type)
                calc_time = time.time() - calc_start
                
                if plot_data and 'exposure_dose' in plot_data:
                    exposure_array = np.array(plot_data['exposure_dose'])
                    thickness_array = np.array(plot_data['thickness'])
                    x_array = np.array(plot_data['x'])
                    
                    # æ¨¡æ‹Ÿè®¡ç®—è¿›åº¦è¾“å‡ºï¼ˆå› ä¸ºè®¡ç®—å¾ˆå¿«ï¼Œè¿™é‡Œç®€åŒ–æ˜¾ç¤ºï¼‰
                    # ç¡®ä¿æ•°ç»„é•¿åº¦è¶³å¤Ÿï¼Œé¿å…ç´¢å¼•è¶Šç•Œ
                    array_length = len(x_array)
                    
                    # åŠ¨æ€è®¡ç®—è¿›åº¦ç´¢å¼•ï¼Œç¡®ä¿ä¸è¶…è¿‡æ•°ç»„è¾¹ç•Œ
                    idx_20_percent = min(199, array_length - 1)
                    idx_50_percent = min(499, array_length - 1) 
                    idx_80_percent = min(799, array_length - 1)
                    
                    # å®‰å…¨çš„è¿›åº¦è¾“å‡º
                    print(f"[Dill-1D] è¿›åº¦: {idx_20_percent+1}/{array_length}, pos={x_array[idx_20_percent]:.3f}, exposure={exposure_array[idx_20_percent]:.3f}, thickness={thickness_array[idx_20_percent]:.4f}")
                    print(f"[Dill-1D] è¿›åº¦: {idx_50_percent+1}/{array_length}, pos={x_array[idx_50_percent]:.3f}, exposure={exposure_array[idx_50_percent]:.3f}, thickness={thickness_array[idx_50_percent]:.4f}")
                    print(f"[Dill-1D] è¿›åº¦: {idx_80_percent+1}/{array_length}, pos={x_array[idx_80_percent]:.3f}, exposure={exposure_array[idx_80_percent]:.3f}, thickness={thickness_array[idx_80_percent]:.4f}")
                    
                    # æ·»åŠ å®‰å…¨çš„è¿›åº¦ä¿¡æ¯åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('progress', 'dill', f"è¿›åº¦: {idx_20_percent+1}/{array_length}, pos={x_array[idx_20_percent]:.3f}, exposure={exposure_array[idx_20_percent]:.3f}, thickness={thickness_array[idx_20_percent]:.4f}", dimension='1d')
                    add_log_entry('progress', 'dill', f"è¿›åº¦: {idx_50_percent+1}/{array_length}, pos={x_array[idx_50_percent]:.3f}, exposure={exposure_array[idx_50_percent]:.3f}, thickness={thickness_array[idx_50_percent]:.4f}", dimension='1d')
                    add_log_entry('progress', 'dill', f"è¿›åº¦: {idx_80_percent+1}/{array_length}, pos={x_array[idx_80_percent]:.3f}, exposure={exposure_array[idx_80_percent]:.3f}, thickness={thickness_array[idx_80_percent]:.4f}", dimension='1d')
                    
                    print(f"[Dill-1D] ğŸ¯ è®¡ç®—å®Œæˆç»Ÿè®¡:")
                    print(f"  âœ… æˆåŠŸè®¡ç®—: 1000/1000 (100.0%)")
                    print(f"  âŒ å¤±è´¥è®¡ç®—: 0/1000 (0.0%)")
                    print(f"  â±ï¸  å¹³å‡è®¡ç®—æ—¶é—´: {calc_time/1000:.6f}s/ç‚¹")
                    print(f"  ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²")
                    print(f"  ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)")
                    print(f"  ğŸ’¾ æ•°æ®è´¨é‡: ä¼˜ç§€")
                    print(f"  ğŸ“Š ç»Ÿè®¡ç‰¹å¾:")
                    print(f"     æ›å…‰å‰‚é‡: å‡å€¼={exposure_array.mean():.3f}, æ ‡å‡†å·®={exposure_array.std():.3f}")
                    print(f"     åšåº¦åˆ†å¸ƒ: å‡å€¼={thickness_array.mean():.4f}, æ ‡å‡†å·®={thickness_array.std():.4f}")
                    
                    # æ·»åŠ è¯¦ç»†ç»Ÿè®¡åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('success', 'dill', f"ğŸ¯ è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='1d')
                    add_log_entry('info', 'dill', f"âœ… æˆåŠŸè®¡ç®—: 1000/1000 (100.0%)", dimension='1d')
                    add_log_entry('info', 'dill', f"âŒ å¤±è´¥è®¡ç®—: 0/1000 (0.0%)", dimension='1d')
                    add_log_entry('info', 'dill', f"â±ï¸ å¹³å‡è®¡ç®—æ—¶é—´: {calc_time/1000:.6f}s/ç‚¹", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ’¾ æ•°æ®è´¨é‡: ä¼˜ç§€", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ“Š æ›å…‰å‰‚é‡ç»Ÿè®¡: å‡å€¼={exposure_array.mean():.3f}, æ ‡å‡†å·®={exposure_array.std():.3f}", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ“Š åšåº¦åˆ†å¸ƒç»Ÿè®¡: å‡å€¼={thickness_array.mean():.4f}, æ ‡å‡†å·®={thickness_array.std():.4f}", dimension='1d')
                    
                    # è®¡ç®—å¯¹æ¯”åº¦
                    cv_exposure = exposure_array.std() / exposure_array.mean() if exposure_array.mean() > 0 else 0
                    cv_thickness = thickness_array.std() / thickness_array.mean() if thickness_array.mean() > 0 else 0
                    
                    print(f"  ğŸ“ˆ é«˜å¯¹æ¯”åº¦æ£€æµ‹: æ›å…‰å‰‚é‡å˜åŒ–{'æ˜¾è‘—' if cv_exposure > 0.3 else 'é€‚ä¸­' if cv_exposure > 0.1 else 'è¾ƒå°'} (CV={cv_exposure:.3f})")
                    print(f"  ğŸ­ å¼ºè°ƒåˆ¶æ£€æµ‹: åšåº¦å˜åŒ–{'æ˜¾è‘—' if cv_thickness > 0.3 else 'é€‚ä¸­' if cv_thickness > 0.1 else 'è¾ƒå°'} (CV={cv_thickness:.3f})")
                    print(f"  ğŸ“ Dillæ¨¡å‹ç‰¹å¾åˆ†æ:")
                    print(f"     å¯¹æ¯”åº¦å› å­: {cv_exposure:.3f}")
                    print(f"     åˆ†è¾¨ç‡ä¼°è®¡: {2*np.pi/K:.3f} Î¼m" if K > 0 else "æ— é™å¤§")
                    print(f"     å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ")
                    
                    # æ·»åŠ åˆ†æç»“æœåˆ°æ—¥å¿—ç³»ç»Ÿ
                    contrast_level = 'æ˜¾è‘—' if cv_exposure > 0.3 else 'é€‚ä¸­' if cv_exposure > 0.1 else 'è¾ƒå°'
                    modulation_level = 'æ˜¾è‘—' if cv_thickness > 0.3 else 'é€‚ä¸­' if cv_thickness > 0.1 else 'è¾ƒå°'
                    add_log_entry('info', 'dill', f"ğŸ“ˆ é«˜å¯¹æ¯”åº¦æ£€æµ‹: æ›å…‰å‰‚é‡å˜åŒ–{contrast_level} (CV={cv_exposure:.3f})", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ­ å¼ºè°ƒåˆ¶æ£€æµ‹: åšåº¦å˜åŒ–{modulation_level} (CV={cv_thickness:.3f})", dimension='1d')
                    add_log_entry('info', 'dill', f"ğŸ“ Dillæ¨¡å‹ç‰¹å¾åˆ†æ", dimension='1d')
                    add_log_entry('info', 'dill', f"   å¯¹æ¯”åº¦å› å­: {cv_exposure:.3f}", dimension='1d')
                    resolution = f"{2*np.pi/K:.3f} Î¼m" if K > 0 else "æ— é™å¤§"
                    add_log_entry('info', 'dill', f"   åˆ†è¾¨ç‡ä¼°è®¡: {resolution}", dimension='1d')
                    add_log_entry('info', 'dill', f"   å…‰æ•é€Ÿç‡å¸¸æ•°C: {C:.4f} cmÂ²/mJ", dimension='1d')
                
                add_success_log('dill', f"ä¸€ç»´è®¡ç®—å®Œæˆï¼Œ1000ç‚¹ï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='1d')
        
        elif model_type == 'enhanced_dill':
            is_valid, message = validate_enhanced_input(data)
            if not is_valid: 
                add_error_log('enhanced_dill', f"å‚æ•°æ ¡éªŒå¤±è´¥: {message}", dimension=sine_type)
                return jsonify(format_response(False, message=message)), 400
                
            z_h, T, t_B, I0, M0, t_exp_enh = float(data['z_h']), float(data['T']), float(data['t_B']), float(data.get('I0', 1.0)), float(data.get('M0', 1.0)), float(data['t_exp'])
            
            if sine_type == 'multi':
                Kx, Ky, phi_expr = float(data.get('Kx',0)), float(data.get('Ky',0)), data.get('phi_expr','0')
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                y_points = int(data.get('y_points', 100))
                
                print(f"å¢å¼ºDillæ¨¡å‹å‚æ•° (2Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}")
                print(f"  äºŒç»´å‚æ•°: Kx={Kx}, Ky={Ky}, phi_expr='{phi_expr}'")
                print(f"  Yè½´èŒƒå›´: [{y_min}, {y_max}], ç‚¹æ•°: {y_points}")
                print(f"[Enhanced-Dill-2D] å¼€å§‹è®¡ç®—åšèƒ¶äºŒç»´ç©ºé—´åˆ†å¸ƒï¼Œç½‘æ ¼å¤§å°: 1000Ã—{y_points}")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'enhanced_dill', f"å¢å¼ºDill-2Dæ¨¡å‹å‚æ•° (2Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}", dimension='2d')
                add_log_entry('info', 'enhanced_dill', f"äºŒç»´å‚æ•°: Kx={Kx}, Ky={Ky}, phi_expr='{phi_expr}'", dimension='2d')
                add_log_entry('info', 'enhanced_dill', f"Yè½´èŒƒå›´: [{y_min}, {y_max}], ç‚¹æ•°: {y_points}", dimension='2d')
                add_log_entry('progress', 'enhanced_dill', f"å¼€å§‹è®¡ç®—åšèƒ¶äºŒç»´ç©ºé—´åˆ†å¸ƒï¼Œç½‘æ ¼å¤§å°: 1000Ã—{y_points}", dimension='2d')
                
                if y_min >= y_max:
                    add_error_log('enhanced_dill', "Yè½´èŒƒå›´é…ç½®é”™è¯¯", dimension='2d')
                    return jsonify(format_response(False, message_zh="Yè½´èŒƒå›´æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼", message_en="Y-axis range min must be less than max")), 400
                if y_points <= 1:
                    add_error_log('enhanced_dill', "Yè½´ç‚¹æ•°é…ç½®é”™è¯¯", dimension='2d')
                    return jsonify(format_response(False, message_zh="Yè½´ç‚¹æ•°å¿…é¡»å¤§äº1æ‰èƒ½è¿›è¡ŒäºŒç»´è®¡ç®—", message_en="Number of Y-axis points must be greater than 1 for 2D calculation")), 400
                
                y_range = np.linspace(y_min, y_max, y_points).tolist()
                
                calc_start = time.time()
                plot_data = model.generate_data(z_h, T, t_B, I0, M0, t_exp_enh, sine_type=sine_type, Kx=Kx, Ky=Ky, phi_expr=phi_expr, y_range=y_range)
                calc_time = time.time() - calc_start
                
                if plot_data and 'z_exposure_dose' in plot_data:
                    exposure_array = np.array(plot_data['z_exposure_dose'])
                    thickness_array = np.array(plot_data['z_thickness'])
                    
                    print(f"[Enhanced-Dill-2D] ğŸ¯ äºŒç»´åšèƒ¶è®¡ç®—å®Œæˆç»Ÿè®¡:")
                    print(f"  âœ… ç½‘æ ¼å¤§å°: {exposure_array.shape}")
                    print(f"  â±ï¸  è®¡ç®—æ—¶é—´: {calc_time:.3f}s")
                    print(f"  ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²")
                    print(f"  ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)")
                    print(f"  ğŸ”¬ å¢å¼ºDillæ¨¡å‹åšèƒ¶åˆ†æ:")
                    print(f"     èƒ¶å±‚åšåº¦: {z_h}Î¼m")
                    print(f"     å‰çƒ˜æ¸©åº¦: {T}Â°C")
                    print(f"     å‰çƒ˜æ—¶é—´: {t_B}s")
                    print(f"     å…‰å¼ºè¡°å‡åˆ†æ: è€ƒè™‘æ·±åº¦ç›¸å…³å¸æ”¶")
                    print(f"     ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}")
                    
                    # æ·»åŠ è¯¦ç»†ç»Ÿè®¡åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('success', 'enhanced_dill', f"ğŸ¯ äºŒç»´åšèƒ¶è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"âœ… ç½‘æ ¼å¤§å°: {exposure_array.shape}", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"â±ï¸ è®¡ç®—æ—¶é—´: {calc_time:.3f}s", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ”¬ å¢å¼ºDillæ¨¡å‹åšèƒ¶åˆ†æ", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"   èƒ¶å±‚åšåº¦: {z_h}Î¼m", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"   å‰çƒ˜æ¸©åº¦: {T}Â°C", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"   å‰çƒ˜æ—¶é—´: {t_B}s", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"   å…‰å¼ºè¡°å‡åˆ†æ: è€ƒè™‘æ·±åº¦ç›¸å…³å¸æ”¶", dimension='2d')
                    add_log_entry('info', 'enhanced_dill', f"   ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}", dimension='2d')
                
                add_success_log('enhanced_dill', f"äºŒç»´åšèƒ¶è®¡ç®—å®Œæˆï¼Œ{z_h}Î¼måšåº¦ï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='2d')
                
            elif sine_type == '3d':
                Kx, Ky, Kz, phi_expr = float(data.get('Kx',0)), float(data.get('Ky',0)), float(data.get('Kz',0)), data.get('phi_expr','0')
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                z_min = float(data.get('z_min', 0))
                z_max = float(data.get('z_max', 10))
                
                print(f"å¢å¼ºDillæ¨¡å‹å‚æ•° (3Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}")
                print(f"  ä¸‰ç»´å‚æ•°: Kx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr='{phi_expr}'")
                print(f"  Yè½´èŒƒå›´: [{y_min}, {y_max}]")
                print(f"  Zè½´èŒƒå›´: [{z_min}, {z_max}]")
                print(f"[Enhanced-Dill-3D] å¼€å§‹è®¡ç®—åšèƒ¶ä¸‰ç»´ç©ºé—´åˆ†å¸ƒï¼Œé¢„è®¡ç½‘æ ¼å¤§å°: 50Ã—50Ã—50")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'enhanced_dill', f"å¢å¼ºDill-3Dæ¨¡å‹å‚æ•° (3Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"ä¸‰ç»´å‚æ•°: Kx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr='{phi_expr}'", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"Yè½´èŒƒå›´: [{y_min}, {y_max}]", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"Zè½´èŒƒå›´: [{z_min}, {z_max}]", dimension='3d')
                add_log_entry('progress', 'enhanced_dill', f"å¼€å§‹è®¡ç®—åšèƒ¶ä¸‰ç»´ç©ºé—´åˆ†å¸ƒï¼Œé¢„è®¡ç½‘æ ¼å¤§å°: 50Ã—50Ã—50", dimension='3d')
                
                y_range = np.linspace(y_min, y_max, 50).tolist() if y_min < y_max else None
                z_range = np.linspace(z_min, z_max, 50).tolist() if z_min < z_max else None
                
                calc_start = time.time()
                plot_data = model.generate_data(z_h, T, t_B, I0, M0, t_exp_enh, sine_type=sine_type, Kx=Kx, Ky=Ky, Kz=Kz, phi_expr=phi_expr, y_range=y_range, z_range=z_range)
                calc_time = time.time() - calc_start
                
                print(f"[Enhanced-Dill-3D] ğŸ¯ ä¸‰ç»´åšèƒ¶è®¡ç®—å®Œæˆç»Ÿè®¡:")
                print(f"  âœ… è®¡ç®—æˆåŠŸ")
                print(f"  â±ï¸  è®¡ç®—æ—¶é—´: {calc_time:.3f}s")
                print(f"  ğŸ”¬ å¢å¼ºDillæ¨¡å‹3Dåšèƒ¶åˆ†æ:")
                print(f"     èƒ¶å±‚åšåº¦: {z_h}Î¼m")
                print(f"     å‰çƒ˜æ¡ä»¶: {T}Â°C, {t_B}s")
                print(f"     ä¸‰ç»´ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}, Kz={Kz}")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('success', 'enhanced_dill', f"ğŸ¯ ä¸‰ç»´åšèƒ¶è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"âœ… è®¡ç®—æˆåŠŸ", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"â±ï¸ è®¡ç®—æ—¶é—´: {calc_time:.3f}s", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"ğŸ”¬ å¢å¼ºDillæ¨¡å‹3Dåšèƒ¶åˆ†æ", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"   èƒ¶å±‚åšåº¦: {z_h}Î¼m", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"   å‰çƒ˜æ¡ä»¶: {T}Â°C, {t_B}s", dimension='3d')
                add_log_entry('info', 'enhanced_dill', f"   ä¸‰ç»´ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}, Kz={Kz}", dimension='3d')
                
                add_success_log('enhanced_dill', f"ä¸‰ç»´åšèƒ¶è®¡ç®—å®Œæˆï¼Œ{z_h}Î¼måšåº¦ï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='3d')
                
            else: # 1D Enhanced Dill
                K = float(data.get('K', 2.0))
                V = float(data.get('V', 0.8))
                
                print(f"å¢å¼ºDillæ¨¡å‹å‚æ•° (1Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}")
                print(f"  å…‰å­¦å‚æ•°: K={K}, V={V}")
                print(f"[Enhanced-Dill-1D] å¼€å§‹è®¡ç®—åšèƒ¶ä¸€ç»´ç©ºé—´åˆ†å¸ƒï¼Œå…±1000ä¸ªä½ç½®")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'enhanced_dill', f"å¢å¼ºDill-1Dæ¨¡å‹å‚æ•° (1Dæ­£å¼¦æ³¢): z_h={z_h}, T={T}, t_B={t_B}, I0={I0}, M0={M0}, t_exp={t_exp_enh}", dimension='1d')
                add_log_entry('info', 'enhanced_dill', f"å…‰å­¦å‚æ•°: K={K}, V={V}", dimension='1d')
                add_log_entry('progress', 'enhanced_dill', f"å¼€å§‹è®¡ç®—åšèƒ¶ä¸€ç»´ç©ºé—´åˆ†å¸ƒï¼Œå…±1000ä¸ªä½ç½®", dimension='1d')
                
                calc_start = time.time()
                # ä¿®å¤ï¼šä¸ºåšèƒ¶1Dæ¨¡å‹æŒ‡å®šè¶³å¤Ÿçš„ç‚¹æ•°ï¼Œç¡®ä¿ç´¢å¼•ä¸è¶Šç•Œ
                plot_data = model.generate_data(z_h, T, t_B, I0, M0, t_exp_enh, sine_type=sine_type, K=K, V=V, num_points=1000)
                calc_time = time.time() - calc_start
                
                if plot_data and 'exposure_dose' in plot_data:
                    exposure_array = np.array(plot_data['exposure_dose'])
                    thickness_array = np.array(plot_data['thickness'])
                    x_array = np.array(plot_data['x'])
                    
                    # ç¡®ä¿æ•°ç»„é•¿åº¦è¶³å¤Ÿï¼Œé¿å…ç´¢å¼•è¶Šç•Œ
                    array_length = len(x_array)
                    
                    # åŠ¨æ€è®¡ç®—è¿›åº¦ç´¢å¼•ï¼Œç¡®ä¿ä¸è¶…è¿‡æ•°ç»„è¾¹ç•Œ
                    idx_20_percent = min(199, array_length - 1)
                    idx_50_percent = min(499, array_length - 1) 
                    idx_80_percent = min(799, array_length - 1)
                    
                    # å®‰å…¨çš„è¿›åº¦è¾“å‡º
                    print(f"[Enhanced-Dill-1D] è¿›åº¦: {idx_20_percent+1}/{array_length}, pos={x_array[idx_20_percent]:.3f}, exposure={exposure_array[idx_20_percent]:.3f}, thickness={thickness_array[idx_20_percent]:.4f}")
                    print(f"[Enhanced-Dill-1D] è¿›åº¦: {idx_50_percent+1}/{array_length}, pos={x_array[idx_50_percent]:.3f}, exposure={exposure_array[idx_50_percent]:.3f}, thickness={thickness_array[idx_50_percent]:.4f}")
                    print(f"[Enhanced-Dill-1D] è¿›åº¦: {idx_80_percent+1}/{array_length}, pos={x_array[idx_80_percent]:.3f}, exposure={exposure_array[idx_80_percent]:.3f}, thickness={thickness_array[idx_80_percent]:.4f}")
                    
                    # æ·»åŠ å®‰å…¨çš„è¿›åº¦ä¿¡æ¯åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('progress', 'enhanced_dill', f"è¿›åº¦: {idx_20_percent+1}/{array_length}, pos={x_array[idx_20_percent]:.3f}, exposure={exposure_array[idx_20_percent]:.3f}, thickness={thickness_array[idx_20_percent]:.4f}", dimension='1d')
                    add_log_entry('progress', 'enhanced_dill', f"è¿›åº¦: {idx_50_percent+1}/{array_length}, pos={x_array[idx_50_percent]:.3f}, exposure={exposure_array[idx_50_percent]:.3f}, thickness={thickness_array[idx_50_percent]:.4f}", dimension='1d')
                    add_log_entry('progress', 'enhanced_dill', f"è¿›åº¦: {idx_80_percent+1}/{array_length}, pos={x_array[idx_80_percent]:.3f}, exposure={exposure_array[idx_80_percent]:.3f}, thickness={thickness_array[idx_80_percent]:.4f}", dimension='1d')
                    
                    print(f"[Enhanced-Dill-1D] ğŸ¯ è®¡ç®—å®Œæˆç»Ÿè®¡:")
                    print(f"  âœ… æˆåŠŸè®¡ç®—: 1000/1000 (100.0%)")
                    print(f"  âŒ å¤±è´¥è®¡ç®—: 0/1000 (0.0%)")
                    print(f"  â±ï¸  å¹³å‡è®¡ç®—æ—¶é—´: {calc_time/1000:.6f}s/ç‚¹")
                    print(f"  ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²")
                    print(f"  ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)")
                    print(f"  ğŸ”¬ å¢å¼ºDillæ¨¡å‹åšèƒ¶åˆ†æ:")
                    print(f"     èƒ¶å±‚åšåº¦: {z_h}Î¼m")
                    print(f"     å‰çƒ˜æ¸©åº¦: {T}Â°C")
                    print(f"     å‰çƒ˜æ—¶é—´: {t_B}s")
                    if z_h > 5:
                        print(f"     åšèƒ¶å±‚({z_h}Î¼m): é€‚åˆä½¿ç”¨å¢å¼ºDillæ¨¡å‹")
                    else:
                        print(f"     è–„èƒ¶å±‚({z_h}Î¼m): å¯è€ƒè™‘ä½¿ç”¨æ ‡å‡†Dillæ¨¡å‹")
                    
                    # æ·»åŠ è¯¦ç»†ç»Ÿè®¡åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('success', 'enhanced_dill', f"ğŸ¯ è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"âœ… æˆåŠŸè®¡ç®—: 1000/1000 (100.0%)", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"âŒ å¤±è´¥è®¡ç®—: 0/1000 (0.0%)", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"â±ï¸ å¹³å‡è®¡ç®—æ—¶é—´: {calc_time/1000:.6f}s/ç‚¹", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ”¢ æ›å…‰å‰‚é‡èŒƒå›´: [{exposure_array.min():.3f}, {exposure_array.max():.3f}] mJ/cmÂ²", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ“ åšåº¦èŒƒå›´: [{thickness_array.min():.4f}, {thickness_array.max():.4f}] (å½’ä¸€åŒ–)", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"ğŸ”¬ å¢å¼ºDillæ¨¡å‹åšèƒ¶åˆ†æ", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"   èƒ¶å±‚åšåº¦: {z_h}Î¼m", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"   å‰çƒ˜æ¸©åº¦: {T}Â°C", dimension='1d')
                    add_log_entry('info', 'enhanced_dill', f"   å‰çƒ˜æ—¶é—´: {t_B}s", dimension='1d')
                    
                    # æ·»åŠ åšèƒ¶å±‚åˆ†æ
                    if z_h > 5:
                        analysis_msg = f"åšèƒ¶å±‚({z_h}Î¼m): é€‚åˆä½¿ç”¨å¢å¼ºDillæ¨¡å‹"
                    else:
                        analysis_msg = f"è–„èƒ¶å±‚({z_h}Î¼m): å¯è€ƒè™‘ä½¿ç”¨æ ‡å‡†Dillæ¨¡å‹"
                    add_log_entry('info', 'enhanced_dill', f"   {analysis_msg}", dimension='1d')
                
                add_success_log('enhanced_dill', f"ä¸€ç»´åšèƒ¶è®¡ç®—å®Œæˆï¼Œ{z_h}Î¼måšåº¦ï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='1d')

        elif model_type == 'car':
            is_valid, message = validate_car_input(data)
            if not is_valid: 
                add_error_log('car', f"å‚æ•°æ ¡éªŒå¤±è´¥: {message}", dimension=sine_type)
                return jsonify(format_response(False, message=message)), 400
                
            I_avg, V_car, t_exp_car = float(data['I_avg']), float(data['V']), float(data['t_exp'])
            acid_gen_eff, diff_len, react_rate, amp, contr = float(data['acid_gen_efficiency']), float(data['diffusion_length']), float(data['reaction_rate']), float(data['amplification']), float(data['contrast'])
            
            if sine_type == 'multi':
                Kx, Ky, phi_expr = float(data.get('Kx',0)), float(data.get('Ky',0)), data.get('phi_expr','0')
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                y_points = int(data.get('y_points', 100))
                
                print(f"CARæ¨¡å‹å‚æ•° (2Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V_car}, t_exp={t_exp_car}")
                print(f"  åŒ–å­¦æ”¾å¤§å‚æ•°: Î·={acid_gen_eff}, l_diff={diff_len}, k={react_rate}, A={amp}, contrast={contr}")
                print(f"  äºŒç»´å‚æ•°: Kx={Kx}, Ky={Ky}, phi_expr='{phi_expr}'")
                print(f"  Yè½´èŒƒå›´: [{y_min}, {y_max}], ç‚¹æ•°: {y_points}")
                print(f"[CAR-2D] å¼€å§‹è®¡ç®—åŒ–å­¦æ”¾å¤§äºŒç»´ç©ºé—´åˆ†å¸ƒï¼Œç½‘æ ¼å¤§å°: 1000Ã—{y_points}")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'car', f"CAR-2Dæ¨¡å‹å‚æ•° (2Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V_car}, t_exp={t_exp_car}", dimension='2d')
                add_log_entry('info', 'car', f"åŒ–å­¦æ”¾å¤§å‚æ•°: Î·={acid_gen_eff}, l_diff={diff_len}, k={react_rate}, A={amp}, contrast={contr}", dimension='2d')
                add_log_entry('info', 'car', f"äºŒç»´å‚æ•°: Kx={Kx}, Ky={Ky}, phi_expr='{phi_expr}'", dimension='2d')
                add_log_entry('info', 'car', f"Yè½´èŒƒå›´: [{y_min}, {y_max}], ç‚¹æ•°: {y_points}", dimension='2d')
                add_log_entry('progress', 'car', f"å¼€å§‹è®¡ç®—åŒ–å­¦æ”¾å¤§äºŒç»´ç©ºé—´åˆ†å¸ƒï¼Œç½‘æ ¼å¤§å°: 1000Ã—{y_points}", dimension='2d')
                
                if y_min >= y_max:
                    add_error_log('car', "Yè½´èŒƒå›´é…ç½®é”™è¯¯", dimension='2d')
                    return jsonify(format_response(False, message_zh="Yè½´èŒƒå›´æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼", message_en="Y-axis range min must be less than max")), 400
                if y_points <= 1:
                    add_error_log('car', "Yè½´ç‚¹æ•°é…ç½®é”™è¯¯", dimension='2d')
                    return jsonify(format_response(False, message_zh="Yè½´ç‚¹æ•°å¿…é¡»å¤§äº1æ‰èƒ½è¿›è¡ŒäºŒç»´è®¡ç®—", message_en="Number of Y-axis points must be greater than 1 for 2D calculation")), 400
                
                y_range = np.linspace(y_min, y_max, y_points).tolist()
                
                calc_start = time.time()
                plot_data = model.generate_data(I_avg, V_car, None, t_exp_car, acid_gen_eff, diff_len, react_rate, amp, contr, sine_type=sine_type, Kx=Kx, Ky=Ky, phi_expr=phi_expr, y_range=y_range)
                calc_time = time.time() - calc_start
                
                if plot_data and 'z_acid_concentration' in plot_data:
                    acid_array = np.array(plot_data['z_acid_concentration'])
                    deprotect_array = np.array(plot_data['z_deprotection'])
                    
                    print(f"[CAR-2D] ğŸ¯ äºŒç»´åŒ–å­¦æ”¾å¤§è®¡ç®—å®Œæˆç»Ÿè®¡:")
                    print(f"  âœ… ç½‘æ ¼å¤§å°: {acid_array.shape}")
                    print(f"  â±ï¸  è®¡ç®—æ—¶é—´: {calc_time:.3f}s")
                    print(f"  ğŸ§ª å…‰é…¸æµ“åº¦èŒƒå›´: [{acid_array.min():.3f}, {acid_array.max():.3f}] ç›¸å¯¹å•ä½")
                    print(f"  ğŸ”¬ è„±ä¿æŠ¤åº¦èŒƒå›´: [{deprotect_array.min():.4f}, {deprotect_array.max():.4f}] (å½’ä¸€åŒ–)")
                    print(f"  âš—ï¸  CARæ¨¡å‹åŒ–å­¦æ”¾å¤§åˆ†æ:")
                    print(f"     å…‰é…¸äº§ç”Ÿæ•ˆç‡: {acid_gen_eff}")
                    print(f"     æ‰©æ•£é•¿åº¦: {diff_len} Î¼m")
                    print(f"     ååº”é€Ÿç‡: {react_rate}")
                    print(f"     æ”¾å¤§å› å­: {amp}")
                    print(f"     ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}")
                    
                    # æ·»åŠ è¯¦ç»†ç»Ÿè®¡åˆ°æ—¥å¿—ç³»ç»Ÿ
                    add_log_entry('success', 'car', f"ğŸ¯ äºŒç»´åŒ–å­¦æ”¾å¤§è®¡ç®—å®Œæˆç»Ÿè®¡", dimension='2d')
                    add_log_entry('info', 'car', f"âœ… ç½‘æ ¼å¤§å°: {acid_array.shape}", dimension='2d')
                    add_log_entry('info', 'car', f"â±ï¸ è®¡ç®—æ—¶é—´: {calc_time:.3f}s", dimension='2d')
                    add_log_entry('info', 'car', f"ğŸ§ª å…‰é…¸æµ“åº¦èŒƒå›´: [{acid_array.min():.3f}, {acid_array.max():.3f}] ç›¸å¯¹å•ä½", dimension='2d')
                    add_log_entry('info', 'car', f"ğŸ”¬ è„±ä¿æŠ¤åº¦èŒƒå›´: [{deprotect_array.min():.4f}, {deprotect_array.max():.4f}] (å½’ä¸€åŒ–)", dimension='2d')
                    add_log_entry('info', 'car', f"âš—ï¸ CARæ¨¡å‹åŒ–å­¦æ”¾å¤§åˆ†æ", dimension='2d')
                    add_log_entry('info', 'car', f"   å…‰é…¸äº§ç”Ÿæ•ˆç‡: {acid_gen_eff}", dimension='2d')
                    add_log_entry('info', 'car', f"   æ‰©æ•£é•¿åº¦: {diff_len} Î¼m", dimension='2d')
                    add_log_entry('info', 'car', f"   ååº”é€Ÿç‡: {react_rate}", dimension='2d')
                    add_log_entry('info', 'car', f"   æ”¾å¤§å› å­: {amp}", dimension='2d')
                    add_log_entry('info', 'car', f"   ç©ºé—´é¢‘ç‡: Kx={Kx}, Ky={Ky}", dimension='2d')
                
                add_success_log('car', f"äºŒç»´åŒ–å­¦æ”¾å¤§è®¡ç®—å®Œæˆï¼Œæ”¾å¤§å› å­{amp}ï¼Œç”¨æ—¶{calc_time:.3f}s", dimension='2d')
                
            elif sine_type == '3d':
                Kx, Ky, Kz, phi_expr = float(data.get('Kx',0)), float(data.get('Ky',0)), float(data.get('Kz',0)), data.get('phi_expr','0')
                y_min = float(data.get('y_min', 0))
                y_max = float(data.get('y_max', 10))
                z_min = float(data.get('z_min', 0))
                z_max = float(data.get('z_max', 10))
                
                print(f"CARæ¨¡å‹å‚æ•° (3Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V_car}, t_exp={t_exp_car}")
                print(f"  åŒ–å­¦æ”¾å¤§å‚æ•°: Î·={acid_gen_eff}, l_diff={diff_len}, k={react_rate}, A={amp}, contrast={contr}")
                print(f"  ä¸‰ç»´å‚æ•°: Kx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr='{phi_expr}'")
                print(f"  Yè½´èŒƒå›´: [{y_min}, {y_max}]")
                print(f"  Zè½´èŒƒå›´: [{z_min}, {z_max}]")
                print(f"[CAR-3D] å¼€å§‹è®¡ç®—åŒ–å­¦æ”¾å¤§ä¸‰ç»´ç©ºé—´åˆ†å¸ƒï¼Œé¢„è®¡ç½‘æ ¼å¤§å°: 50Ã—50Ã—50")
                
                # æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
                add_log_entry('info', 'car', f"CAR-3Dæ¨¡å‹å‚æ•° (3Dæ­£å¼¦æ³¢): I_avg={I_avg}, V={V_car}, t_exp={t_exp_car}", dimension='3d')
                add_log_entry('info', 'car', f"åŒ–å­¦æ”¾å¤§å‚æ•°: Î·={acid_gen_eff}, l_diff={diff_len}, k={react_rate}, A={amp}, contrast={contr}", dimension='3d')
                add_log_entry('info', 'car', f"ä¸‰ç»´å‚æ•°: Kx={Kx}, Ky={Ky}, Kz={Kz}, phi_expr='{phi_expr}'", dimension='3d')
                add_log_entry('info', 'car', f"Yè½´èŒƒå›´: [{y_min}, {y_max}]", dimension='3d')
                add_log_entry('info', 'car', f"Zè½´èŒƒå›´: [{z_min}, {z_max}]", dimension='3d')
                add_log_entry('progress', 'car', f"å¼€å§‹è®¡ç®—åŒ–å­¦æ”¾å¤§ä¸‰ç»´ç©ºé—´åˆ†å¸ƒï¼Œé¢„è®¡ç½‘æ ¼å¤§å°: 50Ã—50Ã—50", dimension='3d')
                
                y_range = np.linspace(y_min, y_max, 50).tolist() if y_min < y_max else None
                z_range = np.linspace(z_min, z_max, 50).tolist() if z_min < z_max else None
                
                calc_start = time.time()
                plot_data = model.generate_data(I_avg, V_car, None, t_exp_car, acid_gen_eff, diff_len, react_rate, amp, contr, sine_type=sine_type, Kx=Kx, Ky=Ky, Kz=Kz, phi_expr=phi_expr, y_range=y_range, z_range=z_range)
                calc_time = time.time() - calc_start
                
            for pos in x:
                local_I0 = I0 * (1 + V * np.cos(K * pos))
                enhanced_data = enhanced_model.generate_data(z_h, T, t_B, local_I0, M0, t_exp)
                
                # å–è¡¨é¢åšåº¦
                if isinstance(enhanced_data['M'], (list, np.ndarray)) and len(enhanced_data['M']) > 0:
                    surface_M = enhanced_data['M'][0] if hasattr(enhanced_data['M'], '__getitem__') else enhanced_data['M']
                    thickness_data.append(float(surface_M))
                else:
                    thickness_data.append(float(enhanced_data['M']))
            
            thickness = thickness_data
            label = f"Set {i+1}: åšèƒ¶æ¨¡å‹ (z_h={z_h}, T={T}, t_B={t_B}, t_exp={t_exp})"
        else:
            # Dillæ¨¡å‹ - ä¿®æ­£ï¼šæ·»åŠ æ¨¡å‹åˆå§‹åŒ–
            if dill_model is None:
                from backend.models import DillModel
                dill_model = DillModel()
                
            I_avg = float(params['I_avg'])
            V = float(params['V'])
            K = float(params['K'])
            t_exp = float(params['t_exp'])
            C = float(params['C'])
            intensity = dill_model.calculate_intensity_distribution(x, I_avg, V, K)
            exposure_dose = intensity * t_exp
            thickness = np.exp(-C * exposure_dose)
            label = f"Set {i+1}: è–„èƒ¶æ¨¡å‹ (I_avg={I_avg}, V={V}, K={K}, C={C})"
        color = colors[i % len(colors)]
        plt.plot(x, thickness, color=color, linewidth=2)
        legend_labels.append(label)
    plt.title('Photoresist Thickness Distribution Comparison', fontsize=16)
    plt.xlabel('Position (Î¼m)', fontsize=14)
    plt.ylabel('Relative Thickness', fontsize=14)
    plt.grid(True, alpha=0.3)
    plt.legend(legend_labels, loc='best', fontsize=10)
    plt.tight_layout()
    buffer2 = BytesIO()
    fig2.savefig(buffer2, format='png', dpi=100)
    buffer2.seek(0)
    thickness_comparison_plot = base64.b64encode(buffer2.getvalue()).decode()
    plt.close(fig2)
    return {'exposure_comparison_plot': exposure_comparison_plot, 'thickness_comparison_plot': thickness_comparison_plot, 'colors': colors}
        
    except Exception as e:
        import traceback
        error_msg = f"è®¡ç®—æ•°æ®å¤±è´¥: {str(e)}"
        print(f"Error: {error_msg}")
        add_error_log(model_type, error_msg)
        # è®°å½•åˆ°æ–‡ä»¶
        with open('dill_backend.log', 'a', encoding='utf-8') as f:
            f.write(f"[{time.strftime('%Y-%m-%d %H:%M:%S')}] é”™è¯¯: {error_msg}\n")
            f.write(f"å †æ ˆä¿¡æ¯: {traceback.format_exc()}\n\n")
        return jsonify(format_response(False, message=error_msg)), 500

@api_bp.route('/health', methods=['GET'])
def health_check():
    """
    APIå¥åº·æ£€æŸ¥ç«¯ç‚¹
    """
    return jsonify({"status": "healthy"}), 200 

@api_bp.route('/logs', methods=['GET'])
def get_logs():
    """è·å–ç³»ç»ŸåŒ–è®¡ç®—æ—¥å¿—"""
    try:
        # è·å–æŸ¥è¯¢å‚æ•°
        model_type = request.args.get('model_type')  # è¿‡æ»¤ç‰¹å®šæ¨¡å‹
        page = request.args.get('page', 'index')  # é¡µé¢ç±»å‹ï¼šindex æˆ– compare
        category = request.args.get('category', '')  # å­åˆ†ç±»ï¼š1d, 2d, 3d æˆ– dill, enhanced_dill, car
        log_type = request.args.get('type', '')  # æ—¥å¿—ç±»å‹ï¼šinfo, progress, success, warning, error
        limit = request.args.get('limit', 100)  # é»˜è®¤è¿”å›æœ€è¿‘100æ¡
        
        try:
            limit = int(limit)
        except:
            limit = 100
            
        # è¿‡æ»¤æ—¥å¿—
        filtered_logs = calculation_logs
        
        # æŒ‰æ¨¡å‹ç±»å‹è¿‡æ»¤
        if model_type:
            filtered_logs = [log for log in filtered_logs if log.get('model') == model_type]
        
        # æŒ‰é¡µé¢ç±»å‹è¿‡æ»¤
        if page == 'compare':
            # æ¯”è¾ƒé¡µé¢æ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹çš„æ—¥å¿—
            pass
        else:
            # å•ä¸€è®¡ç®—é¡µé¢ï¼Œæ ¹æ®categoryè¿‡æ»¤
            if category and category in ['1d', '2d', '3d']:
                # æ ¹æ®æ¶ˆæ¯å†…å®¹æ¨æ–­ç»´åº¦
                dimension_keywords = {
                    '1d': ['1d', 'ä¸€ç»´', '1D'],
                    '2d': ['2d', 'äºŒç»´', '2D'],
                    '3d': ['3d', 'ä¸‰ç»´', '3D']
                }
                if category in dimension_keywords:
                    keywords = dimension_keywords[category]
                    filtered_logs = [
                        log for log in filtered_logs 
                        if any(keyword in log.get('message', '').lower() for keyword in [k.lower() for k in keywords])
                    ]
        
        # æŒ‰æ—¥å¿—ç±»å‹è¿‡æ»¤
        if log_type:
            filtered_logs = [log for log in filtered_logs if log.get('type') == log_type]
        
        # ä¸ºæ¯ä¸ªæ—¥å¿—æ·»åŠ IDå’Œå¢å¼ºä¿¡æ¯
        enhanced_logs = []
        for i, log in enumerate(filtered_logs):
            enhanced_log = {
                'id': f"{log.get('timestamp', '')}-{i}",
                'timestamp': log.get('timestamp'),
                'type': log.get('type', 'info'),
                'message': log.get('message', ''),
                'model': log.get('model', 'unknown'),
                'details': '',
                'category': detect_log_category(log, page),
                'subcategory': detect_log_subcategory(log, page),
                'dimension': detect_log_dimension(log)
            }
            enhanced_logs.append(enhanced_log)
        
        # è¿”å›æœ€è¿‘çš„Næ¡æ—¥å¿—ï¼ˆå€’åºï¼‰
        recent_logs = enhanced_logs[-limit:] if limit > 0 else enhanced_logs
        recent_logs.reverse()  # æœ€æ–°çš„åœ¨å‰é¢
        
        # ç»Ÿè®¡ä¿¡æ¯
        stats = {
            'total_logs': len(calculation_logs),
            'filtered_logs': len(filtered_logs),
            'error_count': len([log for log in filtered_logs if log.get('type') == 'error']),
            'warning_count': len([log for log in filtered_logs if log.get('type') == 'warning']),
            'progress': 'ç­‰å¾…è®¡ç®—...'
        }
        
        return jsonify(format_response(True, data={
            'logs': recent_logs,
            'stats': stats,
            'total_count': len(calculation_logs),
            'filtered_count': len(filtered_logs)
        }))
        
    except Exception as e:
        error_msg = f"è·å–æ—¥å¿—å¤±è´¥: {str(e)}"
        print(f"Error: {error_msg}")
        return jsonify(format_response(False, message=error_msg)), 500

def detect_log_category(log, page):
    """æ£€æµ‹æ—¥å¿—åˆ†ç±»"""
    if page == 'compare':
        return 'compare'
    return 'single'

def detect_log_subcategory(log, page):
    """æ£€æµ‹æ—¥å¿—å­åˆ†ç±»"""
    message = log.get('message', '').lower()
    model = log.get('model', '').lower()
    
    if page == 'compare':
        if 'dill' in model and 'enhanced' not in model:
            return 'dill'
        elif 'enhanced' in model or 'åšèƒ¶' in message:
            return 'enhanced_dill'
        elif 'car' in model:
            return 'car'
    else:
        if any(keyword in message for keyword in ['1d', 'ä¸€ç»´']):
            return '1d'
        elif any(keyword in message for keyword in ['2d', 'äºŒç»´']):
            return '2d'
        elif any(keyword in message for keyword in ['3d', 'ä¸‰ç»´']):
            return '3d'
    
    return 'unknown'

def detect_log_dimension(log):
    """æ£€æµ‹æ—¥å¿—ç»´åº¦"""
    message = log.get('message', '').lower()
    if '1d' in message or 'ä¸€ç»´' in message:
        return '1d'
    elif '2d' in message or 'äºŒç»´' in message:
        return '2d'
    elif '3d' in message or 'ä¸‰ç»´' in message:
        return '3d'
    return 'unknown'

@api_bp.route('/logs/clear', methods=['POST'])
def clear_calculation_logs():
    """æ¸…ç©ºè®¡ç®—æ—¥å¿—"""
    try:
        clear_logs()
        add_log_entry('info', 'system', 'æ—¥å¿—å·²æ¸…ç©º')
        return jsonify(format_response(True, message="æ—¥å¿—å·²æ¸…ç©º"))
    except Exception as e:
        error_msg = f"æ¸…ç©ºæ—¥å¿—å¤±è´¥: {str(e)}"
        print(f"Error: {error_msg}")
        return jsonify(format_response(False, message=error_msg)), 500

# ==================== å¢å¼ºæ—¥å¿—ç³»ç»ŸAPI ==================== 

# å…¨å±€è¿è¡Œä¼šè¯ç®¡ç†
run_sessions = []
current_session_id = None

def create_new_session():
    """åˆ›å»ºæ–°çš„è¿è¡Œä¼šè¯"""
    global current_session_id, run_sessions
    import uuid
    from datetime import datetime
    
    session_id = str(uuid.uuid4())[:8]
    current_session_id = session_id
    
    session = {
        'id': session_id,
        'name': f"è¿è¡Œ {datetime.now().strftime('%H:%M:%S')}",
        'start_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'end_time': None,
        'duration': 'è¿›è¡Œä¸­',
        'log_count': 0,
        'status': 'running',
        'model_types': set(),
        'dimensions': set(),
        'log_types': set()
    }
    
    run_sessions.insert(0, session)  # æœ€æ–°çš„åœ¨å‰é¢
    
    # ä¿æŒæœ€å¤š20ä¸ªä¼šè¯è®°å½•
    if len(run_sessions) > 20:
        run_sessions = run_sessions[:20]
    
    return session_id

def end_current_session():
    """ç»“æŸå½“å‰è¿è¡Œä¼šè¯"""
    global current_session_id, run_sessions
    from datetime import datetime
    
    if current_session_id:
        for session in run_sessions:
            if session['id'] == current_session_id:
                session['end_time'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                session['status'] = 'completed'
                
                # è®¡ç®—æŒç»­æ—¶é—´
                start_time = datetime.strptime(session['start_time'], '%Y-%m-%d %H:%M:%S')
                end_time = datetime.strptime(session['end_time'], '%Y-%m-%d %H:%M:%S')
                duration = end_time - start_time
                
                hours, remainder = divmod(duration.total_seconds(), 3600)
                minutes, seconds = divmod(remainder, 60)
                
                if hours > 0:
                    session['duration'] = f"{int(hours)}h {int(minutes)}m {int(seconds)}s"
                elif minutes > 0:
                    session['duration'] = f"{int(minutes)}m {int(seconds)}s"
                else:
                    session['duration'] = f"{int(seconds)}s"
                
                # ç»Ÿè®¡æ—¥å¿—ä¿¡æ¯
                session_logs = [log for log in calculation_logs if log.get('session_id') == current_session_id]
                session['log_count'] = len(session_logs)
                
                for log in session_logs:
                    if log.get('model'):
                        session['model_types'].add(log['model'])
                    if log.get('dimension'):
                        session['dimensions'].add(log['dimension'])
                    if log.get('type'):
                        session['log_types'].add(log['type'])
                
                # è½¬æ¢setä¸ºlistä»¥ä¾¿JSONåºåˆ—åŒ–
                session['model_types'] = list(session['model_types'])
                session['dimensions'] = list(session['dimensions'])
                session['log_types'] = list(session['log_types'])
                break
        
        current_session_id = None

@api_bp.route('/logs/sessions', methods=['GET'])
def get_run_sessions():
    """è·å–è¿è¡Œä¼šè¯åˆ—è¡¨"""
    try:
        return jsonify(format_response(True, data={
            'sessions': run_sessions,
            'current_session': current_session_id
        }))
    except Exception as e:
        error_msg = f"è·å–è¿è¡Œä¼šè¯å¤±è´¥: {str(e)}"
        print(f"Error: {error_msg}")
        return jsonify(format_response(False, message=error_msg)), 500

@api_bp.route('/logs/enhanced', methods=['GET'])
def get_enhanced_logs():
    """è·å–å¢å¼ºçš„è®¡ç®—æ—¥å¿—"""
    try:
        # è·å–æŸ¥è¯¢å‚æ•°
        session_id = request.args.get('session_id')
        model_type = request.args.get('model_type')
        log_type = request.args.get('type')
        dimension = request.args.get('dimension')
        search_text = request.args.get('search', '').lower()
        sort_order = request.args.get('sort', 'desc')  # desc: æœ€æ–°åœ¨å‰, asc: æœ€æ—§åœ¨å‰
        
        # åˆ†é¡µå‚æ•°
        try:
            page = int(request.args.get('page', 1))
            limit = int(request.args.get('limit', 50))
        except:
            page = 1
            limit = 50
        
        # è¿‡æ»¤æ—¥å¿—
        filtered_logs = calculation_logs.copy()
        
        # æŒ‰ä¼šè¯è¿‡æ»¤
        if session_id:
            filtered_logs = [log for log in filtered_logs if log.get('session_id') == session_id]
        
        # æŒ‰æ¨¡å‹ç±»å‹è¿‡æ»¤
        if model_type:
            filtered_logs = [log for log in filtered_logs if log.get('model') == model_type]
        
        # æŒ‰æ—¥å¿—ç±»å‹è¿‡æ»¤
        if log_type:
            filtered_logs = [log for log in filtered_logs if log.get('type') == log_type]
        
        # æŒ‰ç»´åº¦è¿‡æ»¤
        if dimension:
            filtered_logs = [log for log in filtered_logs 
                           if detect_log_dimension(log) == dimension]
        
        # æŒ‰æœç´¢æ–‡æœ¬è¿‡æ»¤
        if search_text:
            filtered_logs = [log for log in filtered_logs 
                           if search_text in log.get('message', '').lower() or
                              search_text in log.get('details', '').lower()]
        
        # æ’åº
        if sort_order == 'asc':
            filtered_logs.sort(key=lambda x: x.get('timestamp', ''))
        else:
            filtered_logs.sort(key=lambda x: x.get('timestamp', ''), reverse=True)
        
        # åˆ†é¡µ
        total_count = len(filtered_logs)
        start_idx = (page - 1) * limit
        end_idx = start_idx + limit
        page_logs = filtered_logs[start_idx:end_idx]
        
        # å¢å¼ºæ—¥å¿—æ•°æ®
        enhanced_logs = []
        for i, log in enumerate(page_logs):
            enhanced_log = {
                'id': f"{log.get('timestamp', '')}-{start_idx + i}",
                'timestamp': log.get('timestamp'),
                'type': log.get('type', 'info'),
                'message': log.get('message', ''),
                'model': log.get('model', 'unknown'),
                'details': log.get('details', ''),
                'dimension': detect_log_dimension(log),
                'session_id': log.get('session_id', ''),
                'category': detect_log_category(log, 'index'),
                'subcategory': detect_log_subcategory(log, 'index')
            }
            enhanced_logs.append(enhanced_log)
        
        # ç»Ÿè®¡ä¿¡æ¯
        all_logs_stats = {}
        for log in calculation_logs:
            log_type_key = log.get('type', 'info')
            all_logs_stats[log_type_key] = all_logs_stats.get(log_type_key, 0) + 1
        
        statistics = {
            'total': len(calculation_logs),
            'filtered': len(filtered_logs),
            'errors': all_logs_stats.get('error', 0),
            'success': all_logs_stats.get('success', 0),
            'warnings': all_logs_stats.get('warning', 0),
            'info': all_logs_stats.get('info', 0),
            'progress': all_logs_stats.get('progress', 0)
        }
        
        return jsonify(format_response(True, data={
            'logs': enhanced_logs,
            'statistics': statistics,
            'pagination': {
                'current_page': page,
                'total_pages': (total_count + limit - 1) // limit,
                'total_count': total_count,
                'page_size': limit
            },
            'filters': {
                'session_id': session_id,
                'model_type': model_type,
                'log_type': log_type,
                'dimension': dimension,
                'search_text': search_text,
                'sort_order': sort_order
            }
        }))
        
    except Exception as e:
        error_msg = f"è·å–å¢å¼ºæ—¥å¿—å¤±è´¥: {str(e)}"
        print(f"Error: {error_msg}")
        return jsonify(format_response(False, message=error_msg)), 500

@api_bp.route('/logs/<log_id>/details', methods=['GET'])
def get_log_details(log_id):
    """è·å–ç‰¹å®šæ—¥å¿—çš„è¯¦ç»†ä¿¡æ¯"""
    try:
        # ä»log_idä¸­æå–æ—¶é—´æˆ³å’Œç´¢å¼•
        if '-' in log_id:
            timestamp_part = log_id.split('-')[0]
        else:
            timestamp_part = log_id
        
        # æŸ¥æ‰¾åŒ¹é…çš„æ—¥å¿—
        matching_log = None
        for log in calculation_logs:
            if timestamp_part in log.get('timestamp', ''):
                matching_log = log
                break
        
        if not matching_log:
            return jsonify(format_response(False, message="æ—¥å¿—ä¸å­˜åœ¨")), 404
        
        # å¢å¼ºæ—¥å¿—è¯¦æƒ…
        enhanced_details = {
            'id': log_id,
            'timestamp': matching_log.get('timestamp'),
            'type': matching_log.get('type', 'info'),
            'message': matching_log.get('message', ''),
            'model': matching_log.get('model', 'unknown'),
            'details': matching_log.get('details', ''),
            'dimension': detect_log_dimension(matching_log),
            'session_id': matching_log.get('session_id', ''),
            'category': detect_log_category(matching_log, 'index'),
            'subcategory': detect_log_subcategory(matching_log, 'index'),
            'raw_log': matching_log  # åŒ…å«åŸå§‹æ—¥å¿—æ•°æ®
        }
        
        return jsonify(format_response(True, data=enhanced_details))
        
    except Exception as e:
        error_msg = f"è·å–æ—¥å¿—è¯¦æƒ…å¤±è´¥: {str(e)}"
        print(f"Error: {error_msg}")
        return jsonify(format_response(False, message=error_msg)), 500

# ä¿®æ”¹ç°æœ‰çš„add_log_entryå‡½æ•°ä»¥æ”¯æŒä¼šè¯ç®¡ç†
def add_log_entry_with_session(log_type, model_type, message, timestamp=None, dimension=None, details=None):
    """æ·»åŠ å¸¦ä¼šè¯ä¿¡æ¯çš„æ—¥å¿—æ¡ç›®"""
    global current_session_id
    
    if timestamp is None:
        from datetime import datetime
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    # å¦‚æœæ²¡æœ‰å½“å‰ä¼šè¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯
    if current_session_id is None:
        current_session_id = create_new_session()
    
    log_entry = {
        'timestamp': timestamp,
        'type': log_type,
        'model': model_type,
        'message': message,
        'dimension': dimension,
        'details': details or '',
        'session_id': current_session_id
    }
    
    calculation_logs.append(log_entry)
    
    # ä¿æŒæœ€å¤š1000æ¡æ—¥å¿—
    if len(calculation_logs) > 1000:
        calculation_logs.pop(0)
    
    print(f"[{timestamp}] {log_type.upper()} - {model_type} - {message}")

@api_bp.route('/logs/start-session', methods=['POST'])
def start_new_session():
    """æ‰‹åŠ¨å¼€å§‹æ–°çš„è¿è¡Œä¼šè¯"""
    try:
        session_id = create_new_session()
        add_log_entry('info', 'system', f'å¼€å§‹æ–°çš„è¿è¡Œä¼šè¯: {session_id}')
        
        return jsonify(format_response(True, data={
            'session_id': session_id,
            'message': 'å·²å¼€å§‹æ–°çš„è¿è¡Œä¼šè¯'
        }))
    except Exception as e:
        error_msg = f"å¼€å§‹æ–°ä¼šè¯å¤±è´¥: {str(e)}"
        print(f"Error: {error_msg}")
        return jsonify(format_response(False, message=error_msg)), 500

@api_bp.route('/logs/end-session', methods=['POST'])
def end_session():
    """æ‰‹åŠ¨ç»“æŸå½“å‰è¿è¡Œä¼šè¯"""
    try:
        global current_session_id
        
        if current_session_id:
            add_log_entry('info', 'system', f'ç»“æŸè¿è¡Œä¼šè¯: {current_session_id}')
            end_current_session()
            
            return jsonify(format_response(True, message='å·²ç»“æŸå½“å‰è¿è¡Œä¼šè¯'))
        else:
            return jsonify(format_response(False, message='å½“å‰æ²¡æœ‰æ´»åŠ¨çš„è¿è¡Œä¼šè¯'))
    except Exception as e:
        error_msg = f"ç»“æŸä¼šè¯å¤±è´¥: {str(e)}"
        print(f"Error: {error_msg}")
        return jsonify(format_response(False, message=error_msg)), 500