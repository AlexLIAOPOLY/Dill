/**
 * CARæ¨¡å‹åŠŸèƒ½å®ç°
 */

// åˆå§‹CARæ¨¡å‹å‚æ•°
const defaultCarParams = {
    I_avg: 10,
    V: 0.8,
    K: 2,
    t_exp: 5,
    acid_gen_efficiency: 0.5,
    diffusion_length: 3,
    reaction_rate: 0.3,
    amplification: 10,
    contrast: 3
};

// å½“å‰CARæ¨¡å‹å‚æ•°
let currentCarParams = {...defaultCarParams};

// CARæ¨¡å‹å‚æ•°èŒƒå›´å’Œæ­¥é•¿
const carParamRanges = {
    I_avg: { min: 1, max: 100, step: 0.1 },
    V: { min: 0, max: 1, step: 0.01 },
    K: { min: 0.1, max: 10, step: 0.1 },
    t_exp: { min: 0.1, max: 20, step: 0.1 },
    acid_gen_efficiency: { min: 0.01, max: 1, step: 0.01 },
    diffusion_length: { min: 0, max: 20, step: 0.1 },
    reaction_rate: { min: 0.01, max: 1, step: 0.01 },
    amplification: { min: 1, max: 50, step: 0.5 },
    contrast: { min: 0.1, max: 10, step: 0.1 }
};

// åˆå§‹åŒ–CARæ¨¡å‹ç•Œé¢
function initCarModel() {
    // ç»‘å®šå‚æ•°æ»‘å—äº‹ä»¶
    Object.keys(defaultCarParams).forEach(param => {
        const slider = document.getElementById(`car_${param}`);
        
        // æ·»åŠ æ£€æŸ¥ç¡®ä¿sliderä¸æ˜¯null
        if (!slider) {
            console.warn(`æœªæ‰¾åˆ°IDä¸ºcar_${param}çš„æ»‘å—å…ƒç´ `);
            return; // è·³è¿‡å½“å‰è¿­ä»£
        }
        
        const numInput = slider.parentElement ? slider.parentElement.querySelector('input[type="number"]') : null;
        const valueDisplay = slider.parentElement && slider.parentElement.parentElement ? 
                            slider.parentElement.parentElement.querySelector('.parameter-value') : null;
        
        if (slider && numInput) {
            // è®¾ç½®åˆå§‹å€¼
            slider.value = defaultCarParams[param];
            numInput.value = defaultCarParams[param];
            if (valueDisplay) {
                valueDisplay.textContent = defaultCarParams[param];
            }
            
            // ç»‘å®šæ»‘å—äº‹ä»¶
            slider.addEventListener('input', function() {
                numInput.value = this.value;
                if (valueDisplay) {
                    valueDisplay.textContent = this.value;
                }
                currentCarParams[param] = parseFloat(this.value);
            });
            
            // ç»‘å®šæ•°å­—è¾“å…¥æ¡†äº‹ä»¶
            numInput.addEventListener('change', function() {
                const range = carParamRanges[param];
                let value = parseFloat(this.value);
                
                // éªŒè¯èŒƒå›´
                if (value < range.min) value = range.min;
                if (value > range.max) value = range.max;
                
                this.value = value;
                slider.value = value;
                if (valueDisplay) {
                    valueDisplay.textContent = value;
                }
                currentCarParams[param] = value;
            });
        }
    });
    
    // ç»‘å®šè®¡ç®—æŒ‰é’®äº‹ä»¶ï¼ˆä½¿ç”¨å…¨å±€è®¡ç®—æŒ‰é’®ï¼‰
    const calculateBtn = document.getElementById('calculate-btn');
    if (calculateBtn) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»ç»‘å®šäº†äº‹ä»¶
        if (!calculateBtn.hasAttribute('data-car-bound')) {
            calculateBtn.setAttribute('data-car-bound', 'true');
            calculateBtn.addEventListener('click', function() {
                const modelType = document.getElementById('model-select').value;
                if (modelType === 'car') {
                    calculateCarModel();
                }
            });
        }
    }
    
    // ç»‘å®š4DåŠ¨ç”»å¯ç”¨å¤é€‰æ¡†äº‹ä»¶
    const enable4dCheckbox = document.getElementById('car_enable_4d_animation');
    const car4dParams = document.getElementById('car-4d-params');
    if (enable4dCheckbox && car4dParams) {
        // åˆå§‹çŠ¶æ€
        car4dParams.style.display = enable4dCheckbox.checked ? 'block' : 'none';
        
        // ç»‘å®šå˜åŒ–äº‹ä»¶
        enable4dCheckbox.addEventListener('change', function() {
            car4dParams.style.display = this.checked ? 'block' : 'none';
        });
    }
    
    // æ˜¾ç¤ºå·¥è‰ºæµç¨‹å›¾ (æœªåˆ›å»ºæ—¶ä¸æ‰§è¡Œ)
    renderCarProcessFlow();
}

// æ¸²æŸ“CARå·¥è‰ºæµç¨‹å›¾
function renderCarProcessFlow() {
    const processContainer = document.getElementById('car-process-flow');
    if (!processContainer) return;
    
    const steps = [
        { icon: 'â˜€ï¸', desc: 'æ›å…‰äº§ç”Ÿå…‰é…¸' },
        { icon: 'ğŸ”¥', desc: 'åçƒ˜æ‰©æ•£' },
        { icon: 'âš›ï¸', desc: 'è„±ä¿æŠ¤ååº”' },
        { icon: 'ğŸ’§', desc: 'æ˜¾å½±æº¶è§£' }
    ];
    
    let html = '<div class="car-process-diagram">';
    
    steps.forEach((step, index) => {
        html += `
            <div class="car-process-step">
                <div class="car-step-icon">${step.icon}</div>
                <div class="car-step-description">${step.desc}</div>
            </div>
        `;
        
        if (index < steps.length - 1) {
            html += '<div class="car-process-arrow">â†’</div>';
        }
    });
    
    html += '</div>';
    processContainer.innerHTML = html;
}

// è®¡ç®—CARæ¨¡å‹
function calculateCarModel() {
    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    document.getElementById('loading').style.display = 'flex';
    
    // è‡ªåŠ¨åˆ·æ–°ç³»ç»ŸåŒ–æ—¥å¿—
    if (window.systematicLogManager) {
        window.systematicLogManager.autoRefreshLogsOnCalculation();
    }
    
    // è·å–4DåŠ¨ç”»å‚æ•°
    const enable4dAnimation = document.getElementById('car_enable_4d_animation').checked;
    const sineType = document.getElementById('car-sine-type').value;
    
    // å‡†å¤‡APIè¯·æ±‚æ•°æ®
    const requestData = {
        model_type: 'car',
        ...currentCarParams
    };
    
    // æ·»åŠ 4DåŠ¨ç”»å‚æ•°ï¼ˆä»…åœ¨3Dæ¨¡å¼ä¸‹ä¸”å¯ç”¨4DåŠ¨ç”»æ—¶ï¼‰
    if (enable4dAnimation && sineType === '3d') {
        requestData.enable_4d_animation = true;
        requestData.t_start = parseFloat(document.getElementById('car_t_start').value) || 0;
        requestData.t_end = parseFloat(document.getElementById('car_t_end').value) || 5;
        requestData.time_steps = parseInt(document.getElementById('car_time_steps').value) || 20;
        requestData.animation_speed = parseInt(document.getElementById('car_animation_speed').value) || 500;
        
        // è·å–3Då‚æ•°
        requestData.sine_type = '3d';
        requestData.Kx = parseFloat(document.getElementById('car_Kx_3d').value) || 2;
        requestData.Ky = parseFloat(document.getElementById('car_Ky_3d').value) || 1;
        requestData.Kz = parseFloat(document.getElementById('car_Kz_3d').value) || 1;
        requestData.phi_expr = document.getElementById('car_phi_expr_3d').value || 'sin(t)';
        
        // è·å–3DèŒƒå›´å‚æ•°
        const x_min = parseFloat(document.getElementById('car_x_min_3d').value) || 0;
        const x_max = parseFloat(document.getElementById('car_x_max_3d').value) || 10;
        const y_min = parseFloat(document.getElementById('car_y_min_3d').value) || 0;
        const y_max = parseFloat(document.getElementById('car_y_max_3d').value) || 10;
        const z_min = parseFloat(document.getElementById('car_z_min_3d').value) || 0;
        const z_max = parseFloat(document.getElementById('car_z_max_3d').value) || 10;
        
        requestData.x_range = [x_min, x_max];
        requestData.y_range = [y_min, y_max];
        requestData.z_range = [z_min, z_max];
    }
    
    // å‘é€APIè¯·æ±‚
    fetch('/api/calculate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayCarResults(data.data);
        } else {
            showErrorMessage(data.message || 'è®¡ç®—å¤±è´¥');
        }
    })
    .catch(error => {
        showErrorMessage(`è¯·æ±‚é”™è¯¯: ${error.message}`);
    })
    .finally(() => {
        // éšè—åŠ è½½åŠ¨ç”»
        document.getElementById('loading').style.display = 'none';
    });
    
    // åŒæ—¶è¯·æ±‚äº¤äº’å¼æ•°æ®
    fetch('/api/calculate_data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯4DåŠ¨ç”»æ•°æ®
            if (data.data && data.data.enable_4d_animation) {
                render4DAnimation(data.data);
            } else {
                renderCarInteractivePlots(data.data);
            }
        }
    })
    .catch(error => {
        console.error('è·å–äº¤äº’å¼æ•°æ®å¤±è´¥:', error);
    });
}

// æ˜¾ç¤ºCARæ¨¡å‹ç»“æœ
function displayCarResults(results) {
    // æ˜¾ç¤ºç»“æœå›¾
    const resultsContainer = document.getElementById('car-results');
    if (!resultsContainer) return;
    
    let html = '<div class="car-results-container">';
    
    // æ˜¾ç¤ºåˆå§‹å…‰é…¸åˆ†å¸ƒå›¾
    if (results.initial_acid_plot) {
        html += `
            <div class="car-result-card">
                <div class="car-result-title">åˆå§‹å…‰é…¸åˆ†å¸ƒ</div>
                <img class="car-result-image" src="data:image/png;base64,${results.initial_acid_plot}" alt="åˆå§‹å…‰é…¸åˆ†å¸ƒ">
                <p>æ›å…‰åäº§ç”Ÿçš„åˆå§‹å…‰é…¸ç©ºé—´åˆ†å¸ƒ</p>
            </div>
        `;
    }
    
    // æ˜¾ç¤ºå…‰é…¸æ‰©æ•£å¯¹æ¯”å›¾
    if (results.acid_diffusion_plot) {
        html += `
            <div class="car-result-card">
                <div class="car-result-title">å…‰é…¸æ‰©æ•£è¿‡ç¨‹</div>
                <img class="car-result-image" src="data:image/png;base64,${results.acid_diffusion_plot}" alt="å…‰é…¸æ‰©æ•£è¿‡ç¨‹">
                <p>åçƒ˜è¿‡ç¨‹ä¸­å…‰é…¸æ‰©æ•£æ•ˆæœå¯¹æ¯”</p>
            </div>
        `;
    }
    
    // æ˜¾ç¤ºè„±ä¿æŠ¤ç¨‹åº¦å›¾
    if (results.deprotection_plot) {
        html += `
            <div class="car-result-card">
                <div class="car-result-title">è„±ä¿æŠ¤ååº”åˆ†å¸ƒ</div>
                <img class="car-result-image" src="data:image/png;base64,${results.deprotection_plot}" alt="è„±ä¿æŠ¤ååº”åˆ†å¸ƒ">
                <p>å…‰é…¸å‚¬åŒ–çš„æ ‘è„‚è„±ä¿æŠ¤ååº”ç¨‹åº¦åˆ†å¸ƒ</p>
            </div>
        `;
    }
    
    // æ˜¾ç¤ºå…‰åˆ»èƒ¶åšåº¦å›¾
    if (results.thickness_plot) {
        html += `
            <div class="car-result-card">
                <div class="car-result-title">æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦</div>
                <img class="car-result-image" src="data:image/png;base64,${results.thickness_plot}" alt="æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦">
                <p>æ˜¾å½±åçš„å…‰åˆ»èƒ¶åšåº¦åˆ†å¸ƒ</p>
            </div>
        `;
    }
    
    html += '</div>';
    resultsContainer.innerHTML = html;
}

// é€šç”¨å¯¼å‡ºå›¾ç‰‡å’Œæ•°æ®å‡½æ•°
function addExportButtonsForPlot(plotDiv, plotName, xData, yData) {
    // åˆ›å»ºæŒ‰é’®å®¹å™¨
    const btnContainer = document.createElement('div');
    btnContainer.className = 'plot-export-btns';
    btnContainer.style.textAlign = 'center';
    btnContainer.style.margin = '10px 0 20px 0';
    // å¯¼å‡ºå›¾ç‰‡æŒ‰é’®
    const exportImgBtn = document.createElement('button');
    exportImgBtn.textContent = 'å¯¼å‡ºå›¾ç‰‡';
    exportImgBtn.onclick = function() {
        Plotly.downloadImage(plotDiv, {format: 'png', filename: plotName});
    };
    // å¯¼å‡ºæ•°æ®æŒ‰é’®
    const exportDataBtn = document.createElement('button');
    exportDataBtn.textContent = 'å¯¼å‡ºæ•°æ®';
    exportDataBtn.onclick = function() {
        let csv = 'x,y\n';
        for (let i = 0; i < xData.length; i++) {
            csv += `${xData[i]},${yData[i]}\n`;
        }
        let blob = new Blob([csv], {type: 'text/csv'});
        let link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = plotName + '.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    btnContainer.appendChild(exportImgBtn);
    btnContainer.appendChild(exportDataBtn);
    // æ’å…¥åˆ°å›¾è¡¨ä¸‹æ–¹
    plotDiv.parentNode.insertBefore(btnContainer, plotDiv.nextSibling);
}

// æ¸²æŸ“äº¤äº’å¼å›¾è¡¨
function renderCarInteractivePlots(data, dimensionInfo = null) {
    // å‡†å¤‡å®¹å™¨
    const plotContainer = document.getElementById('car-interactive-plots');
    if (!plotContainer || !data) return;
    plotContainer.innerHTML = '';

    // é…ç½®é€‰é¡¹ï¼šæ·»åŠ willReadFrequentlyä¼˜åŒ–Canvasæ€§èƒ½
    const plotlyConfig = {
        responsive: true,
        toImageButtonOptions: {
            format: 'png',
            filename: 'car_model_plot',
            scale: 1,
            width: 800,
            height: 600,
            willReadFrequently: true // æ·»åŠ Canvasä¼˜åŒ–å±æ€§
        }
    };

    // ç¡®å®šå½“å‰æ•°æ®ç»´åº¦
    let is1D, is2D, is3D;
    if (dimensionInfo) {
        // ä½¿ç”¨ä¼ å…¥çš„ç»´åº¦ä¿¡æ¯
        is1D = dimensionInfo.is1D;
        is2D = dimensionInfo.is2D;
        is3D = dimensionInfo.is3D;
    } else {
        // å›é€€åˆ°åŸæœ‰çš„æ£€æµ‹é€»è¾‘
        is3D = data.is_3d || data.sine_type === '3d';
        is2D = data.is_2d === true && data.x_coords && data.y_coords;
        is1D = !is3D && !is2D;
    }

    console.log(`CARæ¨¡å‹å›¾è¡¨æ¸²æŸ“ - ç»´åº¦: 1D=${is1D}, 2D=${is2D}, 3D=${is3D}`);
    
    // æ ¹æ®ç»´åº¦åªæ˜¾ç¤ºå¯¹åº”çš„å›¾è¡¨
    if (is3D) {
        renderCar3DPlots(plotContainer, data, plotlyConfig);
    } else if (is2D) {
        renderCar2DPlots(plotContainer, data, plotlyConfig);
    } else if (is1D) {
        renderCar1DPlots(plotContainer, data, plotlyConfig);
    } else {
        plotContainer.innerHTML = '<div style="color:red;padding:20px;">æ— æ³•ç¡®å®šCARæ¨¡å‹æ•°æ®ç»´åº¦</div>';
    }
}

// æ¸²æŸ“CARæ¨¡å‹3Då›¾è¡¨
function renderCar3DPlots(plotContainer, data, plotlyConfig) {
    // å¤„ç†ä¸‰ç»´å›¾è¡¨æ•°æ®
    console.log('CARæ¨¡å‹ï¼šæ¸²æŸ“3Då›¾è¡¨');
    
    // åˆ›å»º3Då±•ç¤ºçš„å®¹å™¨æ ‡é¢˜å’Œæ ·å¼
    const title3D = document.createElement('h2');
    title3D.className = 'section-title';
    title3D.textContent = 'CARæ¨¡å‹ä¸‰ç»´åˆ†å¸ƒå›¾';
    plotContainer.appendChild(title3D);
    
    // åˆ›å»ºå›¾è¡¨ç½‘æ ¼å®¹å™¨
    const gridContainer = document.createElement('div');
    gridContainer.className = 'car-3d-grid';
    gridContainer.style.display = 'grid';
    gridContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
    gridContainer.style.gap = '20px';
    gridContainer.style.marginBottom = '30px';
    plotContainer.appendChild(gridContainer);
    
    // åˆ›å»º4ä¸ª3Då›¾è¡¨å®¹å™¨ï¼Œæ·»åŠ å”¯ä¸€ID
    const plot3DContainers = [
        { id: 'car-initial-acid-3d', title: 'åˆå§‹å…‰é…¸åˆ†å¸ƒ (3D)', dataField: 'initial_acid_3d' },
        { id: 'car-diffused-acid-3d', title: 'æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ (3D)', dataField: 'diffused_acid_3d' },
        { id: 'car-deprotection-3d', title: 'è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ (3D)', dataField: 'deprotection_3d' },
        { id: 'car-thickness-3d', title: 'æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦ (3D)', dataField: 'thickness_3d' }
    ];
    
    plot3DContainers.forEach(plotInfo => {
        const plotDiv = document.createElement('div');
        plotDiv.className = 'car-3d-plot-container';
        plotDiv.style.height = '400px';
        plotDiv.innerHTML = `
            <h3>${plotInfo.title}</h3>
            <div id="${plotInfo.id}" class="car-3d-plot" style="width:100%; height:350px;"></div>
        `;
        gridContainer.appendChild(plotDiv);
        
        // åˆ›å»ºå¯¹åº”çš„3Då›¾è¡¨
        if (data[plotInfo.dataField] || data.x_coords) {
            create3DSurfacePlot(plotInfo.id, data, plotInfo.dataField, plotInfo.title, plotlyConfig);
        }
    });
}

// æ¸²æŸ“CARæ¨¡å‹2Då›¾è¡¨
function renderCar2DPlots(plotContainer, data, plotlyConfig) {
    // å¤„ç†äºŒç»´çƒ­åŠ›å›¾æ•°æ®
    console.log('CARæ¨¡å‹ï¼šæ¸²æŸ“2Dçƒ­åŠ›å›¾');
    
    // åˆ›å»º2Då±•ç¤ºçš„å®¹å™¨æ ‡é¢˜å’Œæ ·å¼
    const title2D = document.createElement('h2');
    title2D.className = 'section-title';
    title2D.textContent = 'CARæ¨¡å‹äºŒç»´åˆ†å¸ƒå›¾';
    plotContainer.appendChild(title2D);
    
    // åˆ›å»ºå›¾è¡¨ç½‘æ ¼å®¹å™¨
    const gridContainer = document.createElement('div');
    gridContainer.className = 'car-2d-grid';
    gridContainer.style.display = 'grid';
    gridContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
    gridContainer.style.gap = '20px';
    gridContainer.style.marginBottom = '30px';
    plotContainer.appendChild(gridContainer);
    
    // åˆ›å»º4ä¸ª2Då›¾è¡¨å®¹å™¨ï¼Œæ·»åŠ å”¯ä¸€ID
    const plot2DContainers = [
        { id: 'car-initial-acid-2d', title: 'åˆå§‹å…‰é…¸åˆ†å¸ƒ (2D)', dataField: 'z_exposure_dose', altField: 'z_initial_acid' },
        { id: 'car-diffused-acid-2d', title: 'æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ (2D)', dataField: 'z_diffused_acid' },
        { id: 'car-deprotection-2d', title: 'è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ (2D)', dataField: 'z_deprotection' },
        { id: 'car-thickness-2d', title: 'æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦ (2D)', dataField: 'z_thickness' }
    ];
    
    plot2DContainers.forEach(plotInfo => {
        const plotDiv = document.createElement('div');
        plotDiv.className = 'car-2d-plot-container';
        plotDiv.style.height = '400px';
        plotDiv.innerHTML = `
            <h3>${plotInfo.title}</h3>
            <div id="${plotInfo.id}" class="car-2d-plot" style="width:100%; height:350px;"></div>
        `;
        gridContainer.appendChild(plotDiv);
        
        // åˆ›å»ºå¯¹åº”çš„2Dçƒ­åŠ›å›¾
        const zData = data[plotInfo.dataField] || (plotInfo.altField && data[plotInfo.altField]);
        if (zData && data.x_coords && data.y_coords) {
            create2DHeatmapPlot(plotInfo.id, data, plotInfo.dataField, plotInfo.title, plotlyConfig);
        }
    });
}

// æ¸²æŸ“CARæ¨¡å‹1Då›¾è¡¨
function renderCar1DPlots(plotContainer, data, plotlyConfig) {
    // å¤„ç†ä¸€ç»´çº¿å›¾æ•°æ®
    console.log('CARæ¨¡å‹ï¼šæ¸²æŸ“1Dçº¿å›¾');
    
    // ç¡®ä¿è‡³å°‘æœ‰xå’ŒæŸä¸ªyåºåˆ—æ•°æ®
    if (!data.x || !data.initial_acid) {
        console.error('CARæ¨¡å‹ï¼šç¼ºå°‘å¿…è¦çš„ä¸€ç»´æ•°æ®');
        return;
    }
    
    // åˆ›å»º1Då±•ç¤ºçš„å®¹å™¨æ ‡é¢˜å’Œæ ·å¼
    const title1D = document.createElement('h2');
    title1D.className = 'section-title';
    title1D.textContent = 'CARæ¨¡å‹ä¸€ç»´åˆ†å¸ƒå›¾';
    plotContainer.appendChild(title1D);
    
    // åˆ›å»ºå›¾è¡¨ç½‘æ ¼å®¹å™¨
    const gridContainer = document.createElement('div');
    gridContainer.className = 'car-1d-grid';
    gridContainer.style.display = 'grid';
    gridContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
    gridContainer.style.gap = '20px';
    gridContainer.style.marginBottom = '30px';
    plotContainer.appendChild(gridContainer);
    
    // åˆ›å»º4ä¸ª1Då›¾è¡¨å®¹å™¨ï¼Œæ·»åŠ å”¯ä¸€ID
    const plot1DContainers = [
        { id: 'car-initial-acid-1d', title: 'åˆå§‹å…‰é…¸åˆ†å¸ƒ (1D)', dataField: 'initial_acid', color: '#2ca02c' },
        { id: 'car-diffused-acid-1d', title: 'æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ (1D)', dataField: 'diffused_acid', color: '#1f77b4' },
        { id: 'car-deprotection-1d', title: 'è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ (1D)', dataField: 'deprotection', color: '#d62728' },
        { id: 'car-thickness-1d', title: 'æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦ (1D)', dataField: 'thickness', color: '#9467bd' }
    ];
    
    plot1DContainers.forEach(plotInfo => {
        const plotDiv = document.createElement('div');
        plotDiv.className = 'car-1d-plot-container';
        plotDiv.style.height = '400px';
        plotDiv.innerHTML = `
            <h3>${plotInfo.title}</h3>
            <div id="${plotInfo.id}" class="car-1d-plot" style="width:100%; height:350px;"></div>
        `;
        gridContainer.appendChild(plotDiv);
        
        // åˆ›å»ºå¯¹åº”çš„1Dçº¿å›¾
        if (data[plotInfo.dataField] && data.x) {
            create1DLinePlot(plotInfo.id, data, plotInfo.dataField, plotInfo.title, plotInfo.color, plotlyConfig);
        }
    });
}

// åˆ›å»º2Dçƒ­åŠ›å›¾
function create2DHeatmapPlot(containerId, data, dataField, title, plotlyConfig) {
    const zData = data[dataField] || (dataField === 'z_exposure_dose' && data.z_initial_acid);
    if (!zData || !data.x_coords || !data.y_coords) return;
    
    const trace = {
        x: data.x_coords,
        y: data.y_coords,
        z: zData,
        type: 'heatmap',
        colorscale: getColorScale(dataField),
        colorbar: { title: getColorBarTitle(dataField) },
        hovertemplate: `X: %{x}<br>Y: %{y}<br>${getColorBarTitle(dataField)}: %{z}<extra></extra>`
    };
    
    const layout = {
        title: title,
        xaxis: { title: 'ä½ç½® (Î¼m)' },
        yaxis: { title: 'ä½ç½® (Î¼m)' },
        margin: { l: 60, r: 20, t: 60, b: 60 }
    };
    
    Plotly.newPlot(containerId, [trace], layout, plotlyConfig);
    
    // æ·»åŠ å¯¼å‡ºæŒ‰é’®
    addExportButton(containerId, title.replace(/\s+/g, '_').toLowerCase());
}

// åˆ›å»º3Dè¡¨é¢å›¾
function create3DSurfacePlot(containerId, data, dataField, title, plotlyConfig) {
    if (!data.x_coords || !data.y_coords || !data[dataField]) return;
    
    const trace = {
        type: 'surface',
        x: data.x_coords,
        y: data.y_coords,
        z: data[dataField],
        colorscale: getColorScale(dataField),
        contours: {
            z: {
                show: true,
                usecolormap: true,
                highlightcolor: "#42f462",
                project: {z: true}
            }
        },
        hovertemplate: `X: %{x}<br>Y: %{y}<br>${getColorBarTitle(dataField)}: %{z}<extra></extra>`
    };
    
    const layout = {
        title: title,
        scene: {
            xaxis: {title: 'Xä½ç½®(Î¼m)'},
            yaxis: {title: 'Yä½ç½®(Î¼m)'},
            zaxis: {title: getColorBarTitle(dataField)}
        },
        autosize: true,
        margin: {l: 0, r: 0, b: 0, t: 30}
    };
    
    Plotly.newPlot(containerId, [trace], layout, plotlyConfig);
    
    // æ·»åŠ å¯¼å‡ºæŒ‰é’®
    addExportButton(containerId, title.replace(/\s+/g, '_').toLowerCase());
}

// åˆ›å»º1Dçº¿å›¾
function create1DLinePlot(containerId, data, dataField, title, color, plotlyConfig) {
    if (!data[dataField] || !data.x) return;
    
    const trace = {
        x: data.x,
        y: data[dataField],
        name: title,
        type: 'scatter',
        mode: 'lines',
        line: { color: color, width: 2 },
        fill: dataField === 'thickness' ? 'tozeroy' : undefined,
        fillcolor: dataField === 'thickness' ? `rgba(${hexToRgb(color)}, 0.2)` : undefined
    };
    
    const layout = {
        title: title,
        xaxis: { title: 'ä½ç½® (Î¼m)' },
        yaxis: { title: getYAxisTitle(dataField) },
        margin: { t: 40, b: 40, l: 60, r: 10 },
        hovermode: 'closest'
    };
    
    Plotly.newPlot(containerId, [trace], layout, plotlyConfig);
    
    // æ·»åŠ å¯¼å‡ºæŒ‰é’®
    addExportButton(containerId, title.replace(/\s+/g, '_').toLowerCase());
}

// è¾…åŠ©å‡½æ•°
function getColorScale(dataField) {
    const colorMap = {
        'z_exposure_dose': 'Viridis',
        'z_initial_acid': 'Viridis',
        'z_diffused_acid': 'Viridis',
        'z_deprotection': 'YlOrRd',
        'z_thickness': 'Plasma',
        'initial_acid_3d': 'Viridis',
        'diffused_acid_3d': 'Viridis',
        'deprotection_3d': 'YlOrRd',
        'thickness_3d': 'Plasma'
    };
    return colorMap[dataField] || 'Viridis';
}

function getColorBarTitle(dataField) {
    const titleMap = {
        'z_exposure_dose': 'å…‰é…¸æµ“åº¦',
        'z_initial_acid': 'å…‰é…¸æµ“åº¦',
        'z_diffused_acid': 'å…‰é…¸æµ“åº¦',
        'z_deprotection': 'è„±ä¿æŠ¤ç¨‹åº¦',
        'z_thickness': 'å½’ä¸€åŒ–åšåº¦',
        'initial_acid_3d': 'å…‰é…¸æµ“åº¦',
        'diffused_acid_3d': 'æ‰©æ•£åæµ“åº¦',
        'deprotection_3d': 'è„±ä¿æŠ¤ç¨‹åº¦',
        'thickness_3d': 'ç›¸å¯¹åšåº¦'
    };
    return titleMap[dataField] || 'æ•°å€¼';
}

function getYAxisTitle(dataField) {
    const titleMap = {
        'initial_acid': 'å½’ä¸€åŒ–å…‰é…¸æµ“åº¦',
        'diffused_acid': 'å½’ä¸€åŒ–å…‰é…¸æµ“åº¦',
        'deprotection': 'è„±ä¿æŠ¤ç¨‹åº¦',
        'thickness': 'å½’ä¸€åŒ–åšåº¦'
    };
    return titleMap[dataField] || 'æ•°å€¼';
}

function addExportButton(containerId, filename) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const btnContainer = document.createElement('div');
    btnContainer.className = 'plot-export-btns';
    btnContainer.style.textAlign = 'center';
    btnContainer.style.margin = '10px 0';
    
    const exportBtn = document.createElement('button');
    exportBtn.textContent = 'å¯¼å‡ºå›¾ç‰‡';
    exportBtn.onclick = function() {
        Plotly.downloadImage(containerId, {
            format: 'png',
            filename: filename,
            width: 800,
            height: 600
        });
    };
    
    btnContainer.appendChild(exportBtn);
    container.parentNode.appendChild(btnContainer);
}

function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? 
        `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
        '148, 103, 189';
}

// ä¸‹é¢çš„å‡½æ•°æ›¾æ˜¯æ—§çš„ä»£ç ï¼Œç°å·²é‡æ„
        console.log('CARæ¨¡å‹ï¼šæ¸²æŸ“3Då›¾è¡¨');
        
        // åˆ›å»º3Då±•ç¤ºçš„å®¹å™¨æ ‡é¢˜å’Œæ ·å¼
        const title3D = document.createElement('h2');
        title3D.className = 'section-title';
        title3D.textContent = 'CARæ¨¡å‹ä¸‰ç»´åˆ†å¸ƒå›¾';
        plotContainer.appendChild(title3D);
        
        // åˆ›å»ºå›¾è¡¨ç½‘æ ¼å®¹å™¨
        const gridContainer = document.createElement('div');
        gridContainer.className = 'car-3d-grid';
        gridContainer.style.display = 'grid';
        gridContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
        gridContainer.style.gap = '20px';
        gridContainer.style.marginBottom = '30px';
        plotContainer.appendChild(gridContainer);
        
        // 1. åˆå§‹å…‰é…¸åˆ†å¸ƒå›¾çš„å®¹å™¨
        const initialAcidDiv = document.createElement('div');
        initialAcidDiv.className = 'car-3d-plot-container';
        initialAcidDiv.style.height = '400px';
        initialAcidDiv.innerHTML = `
            <h3>åˆå§‹å…‰é…¸åˆ†å¸ƒ (3D)</h3>
            <div id="car-initial-acid-3d" class="car-3d-plot" style="width:100%; height:350px;"></div>
        `;
        gridContainer.appendChild(initialAcidDiv);
        
        // 2. æ‰©æ•£åå…‰é…¸åˆ†å¸ƒå›¾çš„å®¹å™¨
        const diffusedAcidDiv = document.createElement('div');
        diffusedAcidDiv.className = 'car-3d-plot-container';
        diffusedAcidDiv.style.height = '400px';
        diffusedAcidDiv.innerHTML = `
            <h3>æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ (3D)</h3>
            <div id="car-diffused-acid-3d" class="car-3d-plot" style="width:100%; height:350px;"></div>
        `;
        gridContainer.appendChild(diffusedAcidDiv);
        
        // 3. è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒå›¾çš„å®¹å™¨
        const deprotectionDiv = document.createElement('div');
        deprotectionDiv.className = 'car-3d-plot-container';
        deprotectionDiv.style.height = '400px';
        deprotectionDiv.innerHTML = `
            <h3>è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ (3D)</h3>
            <div id="car-deprotection-3d" class="car-3d-plot" style="width:100%; height:350px;"></div>
        `;
        gridContainer.appendChild(deprotectionDiv);
        
        // 4. å…‰åˆ»èƒ¶åšåº¦åˆ†å¸ƒå›¾çš„å®¹å™¨
        const thicknessDiv = document.createElement('div');
        thicknessDiv.className = 'car-3d-plot-container';
        thicknessDiv.style.height = '400px';
        thicknessDiv.innerHTML = `
            <h3>æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦ (3D)</h3>
            <div id="car-thickness-3d" class="car-3d-plot" style="width:100%; height:350px;"></div>
        `;
        gridContainer.appendChild(thicknessDiv);
        
        // ç¡®ä¿æœ‰æ­£ç¡®çš„3Dæ•°æ®
        if (data.x_coords && data.y_coords && 
            (data.initial_acid || data.diffused_acid || data.deprotection || data.thickness)) {
            
            // åˆ›å»ºç½‘æ ¼æ•°æ®
            const x_coords = data.x_coords;
            const y_coords = data.y_coords;
            
            // ä¸ºæ¯ä¸ª3Då›¾è¡¨æ·»åŠ äº¤äº’å¼Plotlyå›¾è¡¨
            
            // 1. åˆå§‹å…‰é…¸åˆ†å¸ƒ
            if (data.initial_acid) {
                const initialAcidData = [{
                    type: 'surface',
                    x: x_coords,
                    y: y_coords,
                    z: data.initial_acid,
                    colorscale: 'Viridis',
                    contours: {
                        z: {
                            show: true,
                            usecolormap: true,
                            highlightcolor: "#42f462",
                            project: {z: true}
                        }
                    },
                    hovertemplate: 'X: %{x}<br>Y: %{y}<br>å…‰é…¸æµ“åº¦: %{z}<extra></extra>'
                }];
                
                const initialAcidLayout = {
                    title: 'åˆå§‹å…‰é…¸åˆ†å¸ƒ (3D)',
                    scene: {
                        xaxis: {title: 'Xä½ç½®(Î¼m)'},
                        yaxis: {title: 'Yä½ç½®(Î¼m)'},
                        zaxis: {title: 'æµ“åº¦'}
                    },
                    autosize: true,
                    margin: {l: 0, r: 0, b: 0, t: 30}
                };
                
                Plotly.newPlot('car-initial-acid-3d', initialAcidData, initialAcidLayout, plotlyConfig);
                
                // æ·»åŠ å¯¼å‡ºæŒ‰é’®
                const btnContainer1 = document.createElement('div');
                btnContainer1.className = 'plot-export-btns';
                btnContainer1.style.textAlign = 'center';
                btnContainer1.style.margin = '10px 0';
                
                const exportImgBtn1 = document.createElement('button');
                exportImgBtn1.textContent = 'å¯¼å‡ºå›¾ç‰‡';
                exportImgBtn1.onclick = function() {
                    Plotly.downloadImage('car-initial-acid-3d', {
                        format: 'png',
                        filename: 'car_initial_acid_3d',
                        width: 800,
                        height: 600
                    });
                };
                
                btnContainer1.appendChild(exportImgBtn1);
                document.getElementById('car-initial-acid-3d').parentNode.appendChild(btnContainer1);
            }
            
            // 2. æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ
            if (data.diffused_acid) {
                const diffusedAcidData = [{
                    type: 'surface',
                    x: x_coords,
                    y: y_coords,
                    z: data.diffused_acid,
                    colorscale: 'Viridis',
                    contours: {
                        z: {
                            show: true,
                            usecolormap: true,
                            highlightcolor: "#42f462",
                            project: {z: true}
                        }
                    },
                    hovertemplate: 'X: %{x}<br>Y: %{y}<br>æ‰©æ•£åæµ“åº¦: %{z}<extra></extra>'
                }];
                
                const diffusedAcidLayout = {
                    title: 'æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ (3D)',
                    scene: {
                        xaxis: {title: 'Xä½ç½®(Î¼m)'},
                        yaxis: {title: 'Yä½ç½®(Î¼m)'},
                        zaxis: {title: 'æ‰©æ•£åæµ“åº¦'}
                    },
                    autosize: true,
                    margin: {l: 0, r: 0, b: 0, t: 30}
                };
                
                Plotly.newPlot('car-diffused-acid-3d', diffusedAcidData, diffusedAcidLayout, plotlyConfig);
                
                // æ·»åŠ å¯¼å‡ºæŒ‰é’®
                const btnContainer2 = document.createElement('div');
                btnContainer2.className = 'plot-export-btns';
                btnContainer2.style.textAlign = 'center';
                btnContainer2.style.margin = '10px 0';
                
                const exportImgBtn2 = document.createElement('button');
                exportImgBtn2.textContent = 'å¯¼å‡ºå›¾ç‰‡';
                exportImgBtn2.onclick = function() {
                    Plotly.downloadImage('car-diffused-acid-3d', {
                        format: 'png',
                        filename: 'car_diffused_acid_3d',
                        width: 800,
                        height: 600
                    });
                };
                
                btnContainer2.appendChild(exportImgBtn2);
                document.getElementById('car-diffused-acid-3d').parentNode.appendChild(btnContainer2);
            }
            
            // 3. è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ
            if (data.deprotection) {
                const deprotectionData = [{
                    type: 'surface',
                    x: x_coords,
                    y: y_coords,
                    z: data.deprotection,
                    colorscale: 'YlOrRd',
                    contours: {
                        z: {
                            show: true,
                            usecolormap: true,
                            highlightcolor: "#42f462",
                            project: {z: true}
                        }
                    },
                    hovertemplate: 'X: %{x}<br>Y: %{y}<br>è„±ä¿æŠ¤ç¨‹åº¦: %{z}<extra></extra>'
                }];
                
                const deprotectionLayout = {
                    title: 'è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ (3D)',
                    scene: {
                        xaxis: {title: 'Xä½ç½®(Î¼m)'},
                        yaxis: {title: 'Yä½ç½®(Î¼m)'},
                        zaxis: {title: 'è„±ä¿æŠ¤ç¨‹åº¦'}
                    },
                    autosize: true,
                    margin: {l: 0, r: 0, b: 0, t: 30}
                };
                
                Plotly.newPlot('car-deprotection-3d', deprotectionData, deprotectionLayout, plotlyConfig);
                
                // æ·»åŠ å¯¼å‡ºæŒ‰é’®
                const btnContainer3 = document.createElement('div');
                btnContainer3.className = 'plot-export-btns';
                btnContainer3.style.textAlign = 'center';
                btnContainer3.style.margin = '10px 0';
                
                const exportImgBtn3 = document.createElement('button');
                exportImgBtn3.textContent = 'å¯¼å‡ºå›¾ç‰‡';
                exportImgBtn3.onclick = function() {
                    Plotly.downloadImage('car-deprotection-3d', {
                        format: 'png',
                        filename: 'car_deprotection_3d',
                        width: 800,
                        height: 600
                    });
                };
                
                btnContainer3.appendChild(exportImgBtn3);
                document.getElementById('car-deprotection-3d').parentNode.appendChild(btnContainer3);
            }
            
            // 4. å…‰åˆ»èƒ¶åšåº¦åˆ†å¸ƒ
            if (data.thickness) {
                const thicknessData = [{
                    type: 'surface',
                    x: x_coords,
                    y: y_coords,
                    z: data.thickness,
                    colorscale: 'Plasma',
                    contours: {
                        z: {
                            show: true,
                            usecolormap: true,
                            highlightcolor: "#42f462",
                            project: {z: true}
                        }
                    },
                    hovertemplate: 'X: %{x}<br>Y: %{y}<br>ç›¸å¯¹åšåº¦: %{z}<extra></extra>'
                }];
                
                const thicknessLayout = {
                    title: 'æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦ (3D)',
                    scene: {
                        xaxis: {title: 'Xä½ç½®(Î¼m)'},
                        yaxis: {title: 'Yä½ç½®(Î¼m)'},
                        zaxis: {title: 'ç›¸å¯¹åšåº¦'}
                    },
                    autosize: true,
                    margin: {l: 0, r: 0, b: 0, t: 30}
                };
                
                Plotly.newPlot('car-thickness-3d', thicknessData, thicknessLayout, plotlyConfig);
                
                // æ·»åŠ å¯¼å‡ºæŒ‰é’®
                const btnContainer4 = document.createElement('div');
                btnContainer4.className = 'plot-export-btns';
                btnContainer4.style.textAlign = 'center';
                btnContainer4.style.margin = '10px 0';
                
                const exportImgBtn4 = document.createElement('button');
                exportImgBtn4.textContent = 'å¯¼å‡ºå›¾ç‰‡';
                exportImgBtn4.onclick = function() {
                    Plotly.downloadImage('car-thickness-3d', {
                        format: 'png',
                        filename: 'car_thickness_3d',
                        width: 800,
                        height: 600
                    });
                };
                
                btnContainer4.appendChild(exportImgBtn4);
                document.getElementById('car-thickness-3d').parentNode.appendChild(btnContainer4);
            }
        } 
        // å¦‚æœæ²¡æœ‰è·å–åˆ°3Dæ•°æ®ï¼Œä½†æœ‰å›¾ç‰‡æ•°æ®ï¼Œä½œä¸ºå¤‡ç”¨æ˜¾ç¤ºå›¾ç‰‡
        else if (data.initial_acid_plot || data.acid_diffusion_plot || 
                data.deprotection_plot || data.thickness_plot) {
            
            // 1. åˆå§‹å…‰é…¸åˆ†å¸ƒ
            if (data.initial_acid_plot) {
                const initialAcidImg = document.createElement('img');
                initialAcidImg.src = `data:image/png;base64,${data.initial_acid_plot}`;
                initialAcidImg.alt = 'åˆå§‹å…‰é…¸åˆ†å¸ƒ (3D)';
                initialAcidImg.style.width = '100%';
                initialAcidImg.style.height = '350px';
                initialAcidImg.style.objectFit = 'contain';
                document.getElementById('car-initial-acid-3d').appendChild(initialAcidImg);
                
                // æ·»åŠ å¯¼å‡ºæŒ‰é’®
                const btnContainer1 = document.createElement('div');
                btnContainer1.className = 'plot-export-btns';
                btnContainer1.style.textAlign = 'center';
                btnContainer1.style.margin = '10px 0';
                
                const exportImgBtn1 = document.createElement('button');
                exportImgBtn1.textContent = 'å¯¼å‡ºå›¾ç‰‡';
                exportImgBtn1.onclick = function() {
                    const link = document.createElement('a');
                    link.href = initialAcidImg.src;
                    link.download = 'car_initial_acid_3d.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                
                btnContainer1.appendChild(exportImgBtn1);
                document.getElementById('car-initial-acid-3d').parentNode.appendChild(btnContainer1);
            }
            
            // 2. æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ
            if (data.acid_diffusion_plot) {
                const diffusedAcidImg = document.createElement('img');
                diffusedAcidImg.src = `data:image/png;base64,${data.acid_diffusion_plot}`;
                diffusedAcidImg.alt = 'æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ (3D)';
                diffusedAcidImg.style.width = '100%';
                diffusedAcidImg.style.height = '350px';
                diffusedAcidImg.style.objectFit = 'contain';
                document.getElementById('car-diffused-acid-3d').appendChild(diffusedAcidImg);
                
                // æ·»åŠ å¯¼å‡ºæŒ‰é’®
                const btnContainer2 = document.createElement('div');
                btnContainer2.className = 'plot-export-btns';
                btnContainer2.style.textAlign = 'center';
                btnContainer2.style.margin = '10px 0';
                
                const exportImgBtn2 = document.createElement('button');
                exportImgBtn2.textContent = 'å¯¼å‡ºå›¾ç‰‡';
                exportImgBtn2.onclick = function() {
                    const link = document.createElement('a');
                    link.href = diffusedAcidImg.src;
                    link.download = 'car_diffused_acid_3d.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                
                btnContainer2.appendChild(exportImgBtn2);
                document.getElementById('car-diffused-acid-3d').parentNode.appendChild(btnContainer2);
            }
            
            // 3. è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ
            if (data.deprotection_plot) {
                const deprotectionImg = document.createElement('img');
                deprotectionImg.src = `data:image/png;base64,${data.deprotection_plot}`;
                deprotectionImg.alt = 'è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ (3D)';
                deprotectionImg.style.width = '100%';
                deprotectionImg.style.height = '350px';
                deprotectionImg.style.objectFit = 'contain';
                document.getElementById('car-deprotection-3d').appendChild(deprotectionImg);
                
                // æ·»åŠ å¯¼å‡ºæŒ‰é’®
                const btnContainer3 = document.createElement('div');
                btnContainer3.className = 'plot-export-btns';
                btnContainer3.style.textAlign = 'center';
                btnContainer3.style.margin = '10px 0';
                
                const exportImgBtn3 = document.createElement('button');
                exportImgBtn3.textContent = 'å¯¼å‡ºå›¾ç‰‡';
                exportImgBtn3.onclick = function() {
                    const link = document.createElement('a');
                    link.href = deprotectionImg.src;
                    link.download = 'car_deprotection_3d.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                
                btnContainer3.appendChild(exportImgBtn3);
                document.getElementById('car-deprotection-3d').parentNode.appendChild(btnContainer3);
            }
            
            // 4. å…‰åˆ»èƒ¶åšåº¦åˆ†å¸ƒ
            if (data.thickness_plot) {
                const thicknessImg = document.createElement('img');
                thicknessImg.src = `data:image/png;base64,${data.thickness_plot}`;
                thicknessImg.alt = 'æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦ (3D)';
                thicknessImg.style.width = '100%';
                thicknessImg.style.height = '350px';
                thicknessImg.style.objectFit = 'contain';
                document.getElementById('car-thickness-3d').appendChild(thicknessImg);
                
                // æ·»åŠ å¯¼å‡ºæŒ‰é’®
                const btnContainer4 = document.createElement('div');
                btnContainer4.className = 'plot-export-btns';
                btnContainer4.style.textAlign = 'center';
                btnContainer4.style.margin = '10px 0';
                
                const exportImgBtn4 = document.createElement('button');
                exportImgBtn4.textContent = 'å¯¼å‡ºå›¾ç‰‡';
                exportImgBtn4.onclick = function() {
                    const link = document.createElement('a');
                    link.href = thicknessImg.src;
                    link.download = 'car_thickness_3d.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                
                btnContainer4.appendChild(exportImgBtn4);
                document.getElementById('car-thickness-3d').parentNode.appendChild(btnContainer4);
            }
        } else {
            // å¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error-message';
            errorMsg.textContent = 'æ— æ³•åŠ è½½3Dæ•°æ®ï¼Œè¯·å°è¯•é‡æ–°è®¡ç®—';
            plotContainer.appendChild(errorMsg);
        }
    }
    else {
        // å¤„ç†æ™®é€šçš„ä¸€ç»´çº¿å›¾æ•°æ®
        // ç¡®ä¿è‡³å°‘æœ‰xå’ŒæŸä¸ªyåºåˆ—æ•°æ®
        if (!data.x || !data.initial_acid) {
            console.error('CARæ¨¡å‹ï¼šç¼ºå°‘å¿…è¦çš„ä¸€ç»´æ•°æ®');
            return;
        }
        
        // åˆ›å»º1Då±•ç¤ºçš„å®¹å™¨æ ‡é¢˜å’Œæ ·å¼
        const title1D = document.createElement('h2');
        title1D.className = 'section-title';
        title1D.textContent = 'CARæ¨¡å‹ä¸€ç»´åˆ†å¸ƒå›¾';
        plotContainer.appendChild(title1D);
        
        // åˆ›å»ºå›¾è¡¨ç½‘æ ¼å®¹å™¨
        const gridContainer = document.createElement('div');
        gridContainer.className = 'car-1d-grid';
        gridContainer.style.display = 'grid';
        gridContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
        gridContainer.style.gap = '20px';
        gridContainer.style.marginBottom = '30px';
        plotContainer.appendChild(gridContainer);
        
        // 1. åˆå§‹å…‰é…¸åˆ†å¸ƒå›¾çš„å®¹å™¨
        const initialAcidDiv = document.createElement('div');
        initialAcidDiv.className = 'car-1d-plot-container';
        initialAcidDiv.style.height = '400px';
        initialAcidDiv.innerHTML = `
            <h3>åˆå§‹å…‰é…¸åˆ†å¸ƒ (1D)</h3>
            <div id="car-initial-acid-1d" class="car-1d-plot" style="width:100%; height:350px;"></div>
        `;
        gridContainer.appendChild(initialAcidDiv);
        
        // 2. æ‰©æ•£åå…‰é…¸åˆ†å¸ƒå›¾çš„å®¹å™¨
        const diffusedAcidDiv = document.createElement('div');
        diffusedAcidDiv.className = 'car-1d-plot-container';
        diffusedAcidDiv.style.height = '400px';
        diffusedAcidDiv.innerHTML = `
            <h3>æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ (1D)</h3>
            <div id="car-diffused-acid-1d" class="car-1d-plot" style="width:100%; height:350px;"></div>
        `;
        gridContainer.appendChild(diffusedAcidDiv);
        
        // 3. è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒå›¾çš„å®¹å™¨
        const deprotectionDiv = document.createElement('div');
        deprotectionDiv.className = 'car-1d-plot-container';
        deprotectionDiv.style.height = '400px';
        deprotectionDiv.innerHTML = `
            <h3>è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ (1D)</h3>
            <div id="car-deprotection-1d" class="car-1d-plot" style="width:100%; height:350px;"></div>
        `;
        gridContainer.appendChild(deprotectionDiv);
        
        // 4. å…‰åˆ»èƒ¶åšåº¦åˆ†å¸ƒå›¾çš„å®¹å™¨
        const thicknessDiv = document.createElement('div');
        thicknessDiv.className = 'car-1d-plot-container';
        thicknessDiv.style.height = '400px';
        thicknessDiv.innerHTML = `
            <h3>æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦ (1D)</h3>
            <div id="car-thickness-1d" class="car-1d-plot" style="width:100%; height:350px;"></div>
        `;
        gridContainer.appendChild(thicknessDiv);

        // åˆ›å»ºåˆå§‹å…‰é…¸åˆ†å¸ƒå›¾
        if (data.initial_acid) {
            const initialAcidTrace = [{
                x: data.x,
                y: data.initial_acid,
                name: 'åˆå§‹å…‰é…¸åˆ†å¸ƒ',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#2ca02c', width: 2 }
            }];
            
            const initialAcidLayout = {
                title: 'åˆå§‹å…‰é…¸åˆ†å¸ƒ (1D)',
                xaxis: { title: 'ä½ç½® (Î¼m)' },
                yaxis: { title: 'å½’ä¸€åŒ–å…‰é…¸æµ“åº¦' },
                margin: { t: 40, b: 40, l: 60, r: 10 },
                hovermode: 'closest'
            };
            
            Plotly.newPlot('car-initial-acid-1d', initialAcidTrace, initialAcidLayout, plotlyConfig);
            
            // æ·»åŠ å¯¼å‡ºæŒ‰é’®
            const btnContainer1 = document.createElement('div');
            btnContainer1.className = 'plot-export-btns';
            btnContainer1.style.textAlign = 'center';
            btnContainer1.style.margin = '10px 0';
            
            const exportImgBtn1 = document.createElement('button');
            exportImgBtn1.textContent = 'å¯¼å‡ºå›¾ç‰‡';
            exportImgBtn1.onclick = function() {
                Plotly.downloadImage('car-initial-acid-1d', {
                    format: 'png',
                    filename: 'car_initial_acid_1d',
                    width: 800,
                    height: 600
                });
            };
            
            btnContainer1.appendChild(exportImgBtn1);
            document.getElementById('car-initial-acid-1d').parentNode.appendChild(btnContainer1);
        }
        
        // åˆ›å»ºæ‰©æ•£åå…‰é…¸åˆ†å¸ƒå›¾
        if (data.diffused_acid) {
            const diffusedAcidTrace = [{
                x: data.x,
                y: data.diffused_acid,
                name: 'æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#1f77b4', width: 2 }
            }];
            
            const diffusedAcidLayout = {
                title: 'æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ (1D)',
                xaxis: { title: 'ä½ç½® (Î¼m)' },
                yaxis: { title: 'å½’ä¸€åŒ–å…‰é…¸æµ“åº¦' },
                margin: { t: 40, b: 40, l: 60, r: 10 },
                hovermode: 'closest'
            };
            
            Plotly.newPlot('car-diffused-acid-1d', diffusedAcidTrace, diffusedAcidLayout, plotlyConfig);
            
            // æ·»åŠ å¯¼å‡ºæŒ‰é’®
            const btnContainer2 = document.createElement('div');
            btnContainer2.className = 'plot-export-btns';
            btnContainer2.style.textAlign = 'center';
            btnContainer2.style.margin = '10px 0';
            
            const exportImgBtn2 = document.createElement('button');
            exportImgBtn2.textContent = 'å¯¼å‡ºå›¾ç‰‡';
            exportImgBtn2.onclick = function() {
                Plotly.downloadImage('car-diffused-acid-1d', {
                    format: 'png',
                    filename: 'car_diffused_acid_1d',
                    width: 800,
                    height: 600
                });
            };
            
            btnContainer2.appendChild(exportImgBtn2);
            document.getElementById('car-diffused-acid-1d').parentNode.appendChild(btnContainer2);
        }

        // åˆ›å»ºæ ‘è„‚è„±ä¿æŠ¤ç¨‹åº¦å›¾
        if (data.deprotection) {
            const deprotectionTrace = [{
                x: data.x,
                y: data.deprotection,
                name: 'è„±ä¿æŠ¤ç¨‹åº¦',
                type: 'scatter',
                mode: 'lines',
                line: { color: '#d62728', width: 2 }
            }];
            
            const deprotectionLayout = {
                title: 'è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ (1D)',
                xaxis: { title: 'ä½ç½® (Î¼m)' },
                yaxis: { title: 'è„±ä¿æŠ¤ç¨‹åº¦' },
                margin: { t: 40, b: 40, l: 60, r: 10 },
                hovermode: 'closest'
            };
            
            Plotly.newPlot('car-deprotection-1d', deprotectionTrace, deprotectionLayout, plotlyConfig);
            
            // æ·»åŠ å¯¼å‡ºæŒ‰é’®
            const btnContainer3 = document.createElement('div');
            btnContainer3.className = 'plot-export-btns';
            btnContainer3.style.textAlign = 'center';
            btnContainer3.style.margin = '10px 0';
            
            const exportImgBtn3 = document.createElement('button');
            exportImgBtn3.textContent = 'å¯¼å‡ºå›¾ç‰‡';
            exportImgBtn3.onclick = function() {
                Plotly.downloadImage('car-deprotection-1d', {
                    format: 'png',
                    filename: 'car_deprotection_1d',
                    width: 800,
                    height: 600
                });
            };
            
            btnContainer3.appendChild(exportImgBtn3);
            document.getElementById('car-deprotection-1d').parentNode.appendChild(btnContainer3);
        }

        // åˆ›å»ºæœ€ç»ˆå…‰åˆ»èƒ¶åšåº¦å›¾
        if (data.thickness) {
            const thicknessTrace = [{
                x: data.x,
                y: data.thickness,
                name: 'å…‰åˆ»èƒ¶åšåº¦',
                type: 'scatter',
                mode: 'lines',
                fill: 'tozeroy',
                fillcolor: 'rgba(148, 103, 189, 0.2)',
                line: { color: '#9467bd', width: 2 }
            }];
            
            const thicknessLayout = {
                title: 'æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦ (1D)',
                xaxis: { title: 'ä½ç½® (Î¼m)' },
                yaxis: { title: 'å½’ä¸€åŒ–åšåº¦' },
                margin: { t: 40, b: 40, l: 60, r: 10 },
                hovermode: 'closest'
            };
            
            Plotly.newPlot('car-thickness-1d', thicknessTrace, thicknessLayout, plotlyConfig);
            
            // æ·»åŠ å¯¼å‡ºæŒ‰é’®
            const btnContainer4 = document.createElement('div');
            btnContainer4.className = 'plot-export-btns';
            btnContainer4.style.textAlign = 'center';
            btnContainer4.style.margin = '10px 0';
            
            const exportImgBtn4 = document.createElement('button');
            exportImgBtn4.textContent = 'å¯¼å‡ºå›¾ç‰‡';
            exportImgBtn4.onclick = function() {
                Plotly.downloadImage('car-thickness-1d', {
                    format: 'png',
                    filename: 'car_thickness_1d',
                    width: 800,
                    height: 600
                });
            };
            
            btnContainer4.appendChild(exportImgBtn4);
            document.getElementById('car-thickness-1d').parentNode.appendChild(btnContainer4);
        }
    }
}

// é‡ç½®CARæ¨¡å‹å‚æ•°
function resetCarParams() {
    // é‡ç½®å‚æ•°åˆ°é»˜è®¤å€¼
    Object.keys(defaultCarParams).forEach(param => {
        const slider = document.getElementById(`car_${param}`);
        const numInput = slider.parentElement.querySelector('input[type="number"]');
        const valueDisplay = slider.parentElement.parentElement.querySelector('.parameter-value');
        
        slider.value = defaultCarParams[param];
        numInput.value = defaultCarParams[param];
        if (valueDisplay) {
            valueDisplay.textContent = defaultCarParams[param];
        }
    });
    
    // æ›´æ–°å½“å‰å‚æ•°
    currentCarParams = {...defaultCarParams};
    
    // æ¸…ç©ºç»“æœ
    const resultsContainer = document.getElementById('car-results');
    if (resultsContainer) {
        resultsContainer.innerHTML = '<div class="empty-results">ç‚¹å‡»"è®¡ç®—"æŒ‰é’®æŸ¥çœ‹ç»“æœ</div>';
    }
    
    // æ¸…ç©ºäº¤äº’å¼å›¾è¡¨
    const plotContainer = document.getElementById('car-interactive-plots');
    if (plotContainer) {
        plotContainer.innerHTML = '';
    }
}

// å½“é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æ£€æŸ¥æ˜¯å¦åœ¨CARæ¨¡å‹ç›¸å…³é¡µé¢
    if (document.getElementById('car-params')) {
        initCarModel();
    }
});

// ä¿è¯ showSinglePointDetailsPopup å…¨å±€å¯ç”¨
if (typeof window.showSinglePointDetailsPopup !== 'function' && typeof showSinglePointDetailsPopup === 'function') {
    window.showSinglePointDetailsPopup = showSinglePointDetailsPopup;
}

// ==== 4DåŠ¨ç”»åŠŸèƒ½ç›¸å…³å‡½æ•° ====

// å…¨å±€å˜é‡å­˜å‚¨4DåŠ¨ç”»æ•°æ®å’ŒçŠ¶æ€
let car4DAnimationData = null;
let car4DAnimationState = {
    isPlaying: false,
    currentFrame: 0,
    totalFrames: 0,
    animationSpeed: 500,
    intervalId: null
};

/**
 * æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
 * @param {string} message - é”™è¯¯æ¶ˆæ¯
 */
function showErrorMessage(message) {
    const errorContainer = document.getElementById('error-message');
    if (errorContainer) {
        errorContainer.textContent = message;
        errorContainer.style.display = 'block';
        
        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            errorContainer.style.display = 'none';
        }, 3000);
    } else {
        // å›é€€åˆ°alert
        alert(message);
    }
}

/**
 * æ¸²æŸ“4DåŠ¨ç”»ä¸»å‡½æ•°
 * @param {Object} data - åŒ…å«åŠ¨ç”»æ•°æ®çš„å¯¹è±¡
 */
function render4DAnimation(data) {
    console.log('CARæ¨¡å‹ï¼šå¼€å§‹æ¸²æŸ“4DåŠ¨ç”»');
    
    // ä¿å­˜åŠ¨ç”»æ•°æ®
    car4DAnimationData = data;
    car4DAnimationState.totalFrames = data.initial_acid_frames ? data.initial_acid_frames.length : 0;
    car4DAnimationState.animationSpeed = 500; // å›ºå®šåŠ¨ç”»æ’­æ”¾é€Ÿåº¦
    car4DAnimationState.currentFrame = 0;
    car4DAnimationState.isPlaying = false;
    
    if (car4DAnimationState.totalFrames === 0) {
        console.error('CARæ¨¡å‹ï¼šæ— æœ‰æ•ˆçš„4DåŠ¨ç”»å¸§æ•°æ®');
        return;
    }
    
    console.log(`CARæ¨¡å‹ï¼š4DåŠ¨ç”»æ•°æ®åŠ è½½æˆåŠŸï¼Œæ€»å¸§æ•°: ${car4DAnimationState.totalFrames}`);
    
    // æ˜¾ç¤º4DåŠ¨ç”»åŒºåŸŸ
    const animationSection = document.getElementById('car-4d-animation-section');
    if (animationSection) {
        animationSection.style.display = 'block';
    }
    
    // æ˜¾ç¤º4DåŠ¨ç”»æ§åˆ¶ç•Œé¢
    setupCar4DAnimationUI();
    
    // æ¸²æŸ“åˆå§‹å¸§ï¼ˆç¬¬0å¸§ï¼‰
    updateCar4DAnimationFrame(0);
    
    console.log(`CARæ¨¡å‹ï¼š4DåŠ¨ç”»åˆå§‹åŒ–å®Œæˆï¼Œå…±${car4DAnimationState.totalFrames}å¸§`);
}

/**
 * è®¾ç½®4DåŠ¨ç”»ç•Œé¢
 */
function setupCar4DAnimationUI() {
    const plotContainer = document.getElementById('car-4d-animation-container');
    if (!plotContainer) {
        console.error('CARæ¨¡å‹ï¼šæœªæ‰¾åˆ°4DåŠ¨ç”»å®¹å™¨');
        return;
    }
    
    // æ¸…ç©ºå®¹å™¨å¹¶è®¾ç½®4DåŠ¨ç”»ç•Œé¢
    plotContainer.innerHTML = '';
    
    // åˆ›å»ºåŠ¨ç”»æ§åˆ¶åŒºåŸŸ
    const controlsContainer = document.createElement('div');
    controlsContainer.className = 'car-4d-animation-controls';
    controlsContainer.innerHTML = `
        <div class="car-4d-controls-row">
            <button id="car-4d-play-btn" class="car-4d-control-btn">â–¶ï¸ æ’­æ”¾</button>
            <button id="car-4d-pause-btn" class="car-4d-control-btn">â¸ï¸ æš‚åœ</button>
            <button id="car-4d-stop-btn" class="car-4d-control-btn">â¹ï¸ åœæ­¢</button>
            <button id="car-4d-reset-btn" class="car-4d-control-btn">ğŸ”„ é‡ç½®</button>
        </div>
        <div class="car-4d-time-controls">
            <label>æ—¶é—´è¿›åº¦:</label>
            <input type="range" id="car-4d-time-slider" min="0" max="${car4DAnimationState.totalFrames - 1}" value="0" step="1">
            <span id="car-4d-time-display">å¸§ 1/${car4DAnimationState.totalFrames} (t=0.00s)</span>
        </div>
        <div class="car-4d-status">
            <span id="car-4d-status-text">åŠ¨ç”»å·²å°±ç»ª</span>
        </div>
    `;
    plotContainer.appendChild(controlsContainer);
    
    // æ›´æ–°æ—¶é—´æ»‘å—çš„æœ€å¤§å€¼å’Œæ˜¾ç¤ºï¼ˆåœ¨åŠ¨ç”»æ•°æ®åŠ è½½åï¼‰
    const timeSlider = document.getElementById('car-4d-time-slider');
    const timeDisplay = document.getElementById('car-4d-time-display');
    if (timeSlider && timeDisplay) {
        timeSlider.max = car4DAnimationState.totalFrames - 1;
        timeDisplay.textContent = `å¸§ 1/${car4DAnimationState.totalFrames} (t=0.00s)`;
    }
    
    // åˆ›å»º4DåŠ¨ç”»å›¾è¡¨å®¹å™¨
    const animationContainer = document.createElement('div');
    animationContainer.className = 'car-4d-animation-plots';
    animationContainer.innerHTML = `
        <div class="car-4d-plot-grid">
            <div class="car-4d-plot-container">
                <h3>åˆå§‹å…‰é…¸åˆ†å¸ƒ (3D+æ—¶é—´)</h3>
                <div id="car-4d-initial-acid" class="car-4d-plot"></div>
            </div>
            <div class="car-4d-plot-container">
                <h3>æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ (3D+æ—¶é—´)</h3>
                <div id="car-4d-diffused-acid" class="car-4d-plot"></div>
            </div>
            <div class="car-4d-plot-container">
                <h3>è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ (3D+æ—¶é—´)</h3>
                <div id="car-4d-deprotection" class="car-4d-plot"></div>
            </div>
            <div class="car-4d-plot-container">
                <h3>æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦ (3D+æ—¶é—´)</h3>
                <div id="car-4d-thickness" class="car-4d-plot"></div>
            </div>
        </div>
    `;
    plotContainer.appendChild(animationContainer);
    
    // ç»‘å®šæ§åˆ¶æŒ‰é’®äº‹ä»¶
    setupCar4DControlEvents();
}

/**
 * è®¾ç½®4DåŠ¨ç”»æ§åˆ¶äº‹ä»¶
 */
function setupCar4DControlEvents() {
    // æ’­æ”¾æŒ‰é’®
    document.getElementById('car-4d-play-btn').addEventListener('click', playCar4DAnimation);
    
    // æš‚åœæŒ‰é’®  
    document.getElementById('car-4d-pause-btn').addEventListener('click', pauseCar4DAnimation);
    
    // åœæ­¢æŒ‰é’®
    document.getElementById('car-4d-stop-btn').addEventListener('click', stopCar4DAnimation);
    
    // é‡ç½®æŒ‰é’®
    document.getElementById('car-4d-reset-btn').addEventListener('click', resetCar4DAnimation);
    
    // æ—¶é—´æ»‘å—
    document.getElementById('car-4d-time-slider').addEventListener('input', function() {
        const frameIndex = parseInt(this.value);
        car4DAnimationState.currentFrame = frameIndex;
        updateCar4DAnimationFrame(frameIndex);
    });
}

/**
 * æ’­æ”¾4DåŠ¨ç”»
 */
function playCar4DAnimation() {
    if (car4DAnimationState.isPlaying) return;
    
    car4DAnimationState.isPlaying = true;
    updateCar4DStatusText('åŠ¨ç”»æ’­æ”¾ä¸­...');
    
    car4DAnimationState.intervalId = setInterval(() => {
        car4DAnimationState.currentFrame++;
        
        if (car4DAnimationState.currentFrame >= car4DAnimationState.totalFrames) {
            // åŠ¨ç”»ç»“æŸï¼Œé‡æ–°å¼€å§‹
            car4DAnimationState.currentFrame = 0;
        }
        
        updateCar4DAnimationFrame(car4DAnimationState.currentFrame);
        
        // æ›´æ–°æ»‘å—
        document.getElementById('car-4d-time-slider').value = car4DAnimationState.currentFrame;
        
    }, car4DAnimationState.animationSpeed);
}

/**
 * æš‚åœ4DåŠ¨ç”»
 */
function pauseCar4DAnimation() {
    car4DAnimationState.isPlaying = false;
    if (car4DAnimationState.intervalId) {
        clearInterval(car4DAnimationState.intervalId);
        car4DAnimationState.intervalId = null;
    }
    updateCar4DStatusText('åŠ¨ç”»å·²æš‚åœ');
}

/**
 * åœæ­¢4DåŠ¨ç”»
 */
function stopCar4DAnimation() {
    pauseCar4DAnimation();
    car4DAnimationState.currentFrame = 0;
    updateCar4DAnimationFrame(0);
    document.getElementById('car-4d-time-slider').value = 0;
    updateCar4DStatusText('åŠ¨ç”»å·²åœæ­¢');
}

/**
 * é‡ç½®4DåŠ¨ç”»
 */
function resetCar4DAnimation() {
    stopCar4DAnimation();
    updateCar4DStatusText('åŠ¨ç”»å·²é‡ç½®');
}

/**
 * æ›´æ–°4DåŠ¨ç”»å¸§
 * @param {number} frameIndex - å¸§ç´¢å¼•
 */
function updateCar4DAnimationFrame(frameIndex) {
    if (!car4DAnimationData) {
        console.error('CARæ¨¡å‹ï¼šæ— 4DåŠ¨ç”»æ•°æ®');
        return;
    }
    
    // æ£€æŸ¥æ•°æ®ç»“æ„ - åç«¯è¿”å›çš„æ˜¯framesæ ¼å¼è€Œä¸æ˜¯animation_frames
    const initialAcidFrames = car4DAnimationData.initial_acid_frames;
    const diffusedAcidFrames = car4DAnimationData.diffused_acid_frames;
    const deprotectionFrames = car4DAnimationData.deprotection_frames;
    const thicknessFrames = car4DAnimationData.thickness_frames;
    const timeArray = car4DAnimationData.time_array;
    
    if (!initialAcidFrames || frameIndex >= initialAcidFrames.length) {
        console.error(`CARæ¨¡å‹ï¼šæ— æ•ˆçš„å¸§ç´¢å¼•(${frameIndex})ï¼Œæ€»å¸§æ•°: ${initialAcidFrames ? initialAcidFrames.length : 0}`);
        return;
    }
    
    // è·å–å½“å‰å¸§çš„æ—¶é—´å€¼
    const timeValue = timeArray ? timeArray[frameIndex] : frameIndex;
    
    // æ›´æ–°æ—¶é—´æ˜¾ç¤º
    updateCar4DTimeDisplay(frameIndex, timeValue);
    
    // é…ç½®Plotlyé€‰é¡¹
    const plotlyConfig = {
        responsive: true,
        toImageButtonOptions: {
            format: 'png',
            filename: `car_4d_frame_${frameIndex}`,
            scale: 1,
            width: 800,
            height: 600
        }
    };
    
    // å…¬å…±3Då¸ƒå±€è®¾ç½®
    const common3DLayout = {
        scene: {
            camera: {
                eye: { x: 1.5, y: 1.5, z: 1.5 }
            },
            aspectmode: 'cube'
        },
        autosize: true,
        margin: { l: 0, r: 0, b: 0, t: 40 }
    };
    
    // 1. æ›´æ–°åˆå§‹å…‰é…¸åˆ†å¸ƒå›¾
    if (initialAcidFrames && car4DAnimationData.x_coords && car4DAnimationData.y_coords) {
        const initialAcidData = [{
            type: 'surface',
            x: car4DAnimationData.x_coords,
            y: car4DAnimationData.y_coords,
            z: initialAcidFrames[frameIndex],
            colorscale: 'Viridis',
            contours: {
                z: {
                    show: true,
                    usecolormap: true,
                    highlightcolor: "#42f462",
                    project: { z: true }
                }
            },
            hovertemplate: 'X: %{x}<br>Y: %{y}<br>å…‰é…¸æµ“åº¦: %{z}<extra></extra>'
        }];
        
        const initialAcidLayout = {
            ...common3DLayout,
            title: `åˆå§‹å…‰é…¸åˆ†å¸ƒ (t=${timeValue.toFixed(2)}s)`,
            scene: {
                ...common3DLayout.scene,
                xaxis: { title: 'Xä½ç½®(Î¼m)' },
                yaxis: { title: 'Yä½ç½®(Î¼m)' },
                zaxis: { title: 'å…‰é…¸æµ“åº¦' }
            }
        };
        
        Plotly.newPlot('car-4d-initial-acid', initialAcidData, initialAcidLayout, plotlyConfig);
    }
    
    // 2. æ›´æ–°æ‰©æ•£åå…‰é…¸åˆ†å¸ƒå›¾
    if (diffusedAcidFrames && car4DAnimationData.x_coords && car4DAnimationData.y_coords) {
        const diffusedAcidData = [{
            type: 'surface',
            x: car4DAnimationData.x_coords,
            y: car4DAnimationData.y_coords,
            z: diffusedAcidFrames[frameIndex],
            colorscale: 'Viridis',
            contours: {
                z: {
                    show: true,
                    usecolormap: true,
                    highlightcolor: "#42f462",
                    project: { z: true }
                }
            },
            hovertemplate: 'X: %{x}<br>Y: %{y}<br>æ‰©æ•£å…‰é…¸æµ“åº¦: %{z}<extra></extra>'
        }];
        
        const diffusedAcidLayout = {
            ...common3DLayout,
            title: `æ‰©æ•£åå…‰é…¸åˆ†å¸ƒ (t=${timeValue.toFixed(2)}s)`,
            scene: {
                ...common3DLayout.scene,
                xaxis: { title: 'Xä½ç½®(Î¼m)' },
                yaxis: { title: 'Yä½ç½®(Î¼m)' },
                zaxis: { title: 'å…‰é…¸æµ“åº¦' }
            }
        };
        
        Plotly.newPlot('car-4d-diffused-acid', diffusedAcidData, diffusedAcidLayout, plotlyConfig);
    }
    
    // 3. æ›´æ–°è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒå›¾
    if (deprotectionFrames && car4DAnimationData.x_coords && car4DAnimationData.y_coords) {
        const deprotectionData = [{
            type: 'surface',
            x: car4DAnimationData.x_coords,
            y: car4DAnimationData.y_coords,
            z: deprotectionFrames[frameIndex],
            colorscale: 'YlOrRd',
            contours: {
                z: {
                    show: true,
                    usecolormap: true,
                    highlightcolor: "#42f462",
                    project: { z: true }
                }
            },
            hovertemplate: 'X: %{x}<br>Y: %{y}<br>è„±ä¿æŠ¤ç¨‹åº¦: %{z}<extra></extra>'
        }];
        
        const deprotectionLayout = {
            ...common3DLayout,
            title: `è„±ä¿æŠ¤ç¨‹åº¦åˆ†å¸ƒ (t=${timeValue.toFixed(2)}s)`,
            scene: {
                ...common3DLayout.scene,
                xaxis: { title: 'Xä½ç½®(Î¼m)' },
                yaxis: { title: 'Yä½ç½®(Î¼m)' },
                zaxis: { title: 'è„±ä¿æŠ¤ç¨‹åº¦' }
            }
        };
        
        Plotly.newPlot('car-4d-deprotection', deprotectionData, deprotectionLayout, plotlyConfig);
    }
    
    // 4. æ›´æ–°å…‰åˆ»èƒ¶åšåº¦åˆ†å¸ƒå›¾
    if (thicknessFrames && car4DAnimationData.x_coords && car4DAnimationData.y_coords) {
        const thicknessData = [{
            type: 'surface',
            x: car4DAnimationData.x_coords,
            y: car4DAnimationData.y_coords,
            z: thicknessFrames[frameIndex],
            colorscale: 'Plasma',
            contours: {
                z: {
                    show: true,
                    usecolormap: true,
                    highlightcolor: "#42f462",
                    project: { z: true }
                }
            },
            hovertemplate: 'X: %{x}<br>Y: %{y}<br>ç›¸å¯¹åšåº¦: %{z}<extra></extra>'
        }];
        
        const thicknessLayout = {
            ...common3DLayout,
            title: `æ˜¾å½±åå…‰åˆ»èƒ¶åšåº¦ (t=${timeValue.toFixed(2)}s)`,
            scene: {
                ...common3DLayout.scene,
                xaxis: { title: 'Xä½ç½®(Î¼m)' },
                yaxis: { title: 'Yä½ç½®(Î¼m)' },
                zaxis: { title: 'ç›¸å¯¹åšåº¦' }
            }
        };
        
        Plotly.newPlot('car-4d-thickness', thicknessData, thicknessLayout, plotlyConfig);
    }
}

/**
 * æ›´æ–°æ—¶é—´æ˜¾ç¤º
 * @param {number} frameIndex - å½“å‰å¸§ç´¢å¼•
 * @param {number} timeValue - å½“å‰æ—¶é—´å€¼
 */
function updateCar4DTimeDisplay(frameIndex, timeValue) {
    const timeDisplay = document.getElementById('car-4d-time-display');
    if (timeDisplay) {
        timeDisplay.textContent = `å¸§ ${frameIndex + 1}/${car4DAnimationState.totalFrames} (t=${timeValue.toFixed(2)}s)`;
    }
}

/**
 * æ›´æ–°çŠ¶æ€æ–‡æœ¬
 * @param {string} status - çŠ¶æ€æ–‡æœ¬
 */
function updateCar4DStatusText(status) {
    const statusText = document.getElementById('car-4d-status-text');
    if (statusText) {
        statusText.textContent = status;
    }
}